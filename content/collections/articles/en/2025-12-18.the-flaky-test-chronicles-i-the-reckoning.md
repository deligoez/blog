---
id: 6c21b8fe-f221-4bc0-a6b7-4e78d71ac6fc
published: false
blueprint: articles
title: 'The Flaky Test Chronicles I: The Reckoning'
updated_by: b8f3533e-0fcf-42b9-a3d8-c8691deaf917
updated_at: 1766441673
og_generator_image: the-flaky-test-chronicles-i-the-reckoning.jpg
subtitle: 'Why Your CI Fails at Random'
show_toc: true
toc_levels:
  - 1
content:
  -
    type: heading
    attrs:
      textAlign: left
      level: 1
    content:
      -
        type: text
        text: 'The PR That Should Have Been Green'
  -
    type: blockquote
    content:
      -
        type: paragraph
        attrs:
          textAlign: left
        content:
          -
            type: text
            text: "Your CI pipeline's success rate shouldn't look like a coin flip simulation."
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'You know the feeling. You pick up a '
      -
        type: text
        marks:
          -
            type: link
            attrs:
              href: 'https://www.atlassian.com/software/jira'
              rel: null
              target: _blank
              title: null
        text: Jira
      -
        type: text
        text: ' ticket. You plan the implementation. You write the code. You even do '
      -
        type: text
        marks:
          -
            type: link
            attrs:
              href: 'https://en.wikipedia.org/wiki/Test-driven_development'
              rel: null
              target: _blank
              title: null
        text: TDD
      -
        type: text
        text: ' - actual test-first development, not the '
      -
        type: text
        marks:
          -
            type: italic
        text: '“I’ll write tests later”'
      -
        type: text
        text: ' kind.'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'Everything works. '
      -
        type: hardBreak
      -
        type: text
        text: 'Tests pass. '
      -
        type: hardBreak
      -
        type: text
        text: 'Coverage looks good. '
      -
        type: hardBreak
      -
        type: text
        text: 'You push to '
      -
        type: text
        marks:
          -
            type: link
            attrs:
              href: 'https://github.com/'
              rel: null
              target: _blank
              title: null
        text: GitHub
      -
        type: text
        text: ', open a PR, and wait for the pipeline.'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'Then the GitHub Actions runner finishes. '
      -
        type: hardBreak
      -
        type: text
        marks:
          -
            type: bold
        text: Red
      -
        type: text
        text: '. '
      -
        type: hardBreak
      -
        type: text
        text: 'Multiple failures.'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: "You check the logs. Some failures are in your new tests - but they passed locally, three times in a row. Others are in tests you've never touched. A payment processing test failed. You changed a notification service. "
      -
        type: text
        marks:
          -
            type: italic
        text: 'How are these even related?'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'You click “'
      -
        type: text
        marks:
          -
            type: italic
        text: 'Re-run failed jobs.”'
      -
        type: text
        text: ' '
      -
        type: hardBreak
      -
        type: text
        text: 'It passes. '
      -
        type: hardBreak
      -
        type: text
        text: 'You merge. '
      -
        type: hardBreak
      -
        type: text
        text: 'You move on.'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'Sound familiar? Of course it does. Every developer has lived this moment. Most of us have lived it hundreds of times.'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'For months, this was our workflow. '
      -
        type: text
        marks:
          -
            type: italic
        text: '“Just rerun it”'
      -
        type: text
        text: ' became our unofficial '
      -
        type: text
        marks:
          -
            type: link
            attrs:
              href: 'https://en.wikipedia.org/wiki/Quality_assurance'
              rel: null
              target: _blank
              title: null
        text: 'QA process.'
      -
        type: text
        text: ' '
  -
    type: set
    attrs:
      id: mjg7t45w
      values:
        type: thought
        content:
          -
            type: paragraph
            content:
              -
                type: text
                text: 'PR fails? '
        position: center-left
  -
    type: set
    attrs:
      id: mjg7tcbi
      values:
        type: thought
        content:
          -
            type: paragraph
            content:
              -
                type: text
                text: 'Rerun. '
        position: center-right
  -
    type: set
    attrs:
      id: mjg7tijg
      values:
        type: thought
        content:
          -
            type: paragraph
            content:
              -
                type: text
                text: 'Fails again? '
        position: center-left
  -
    type: set
    attrs:
      id: mjg7v562
      values:
        type: thought
        content:
          -
            type: paragraph
            content:
              -
                type: text
                text: 'Rerun twice.'
        position: center-right
  -
    type: set
    attrs:
      id: mjg7veeg
      values:
        type: thought
        content:
          -
            type: paragraph
            content:
              -
                type: text
                text: 'Eventually it passes.'
        position: center-left
  -
    type: set
    attrs:
      id: mjg7vmrg
      values:
        type: thought
        content:
          -
            type: paragraph
            content:
              -
                type: text
                text: 'Ship it.'
        position: center-right
  -
    type: set
    attrs:
      id: mjc028ab
      values:
        type: sidenote
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                text: 'Senior developer definition: Someone who knows exactly which flaky test to ignore and which one is hiding a production bug waiting for the weekend.'
        style: note
        position: right
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'Then one day, someone actually counted: '
      -
        type: text
        marks:
          -
            type: bold
        text: '16'
      -
        type: text
        text: ' out of '
      -
        type: text
        marks:
          -
            type: bold
        text: '10,500+'
      -
        type: text
        text: ' tests were playing Russian roulette with our '
      -
        type: text
        marks:
          -
            type: link
            attrs:
              href: 'https://en.wikipedia.org/wiki/Continuous_integration'
              rel: null
              target: _blank
              title: null
        text: CI
      -
        type: text
        text: " pipeline. That's about "
      -
        type: text
        marks:
          -
            type: bold
        text: 0.15%
      -
        type: text
        text: ". Sounds small, right? Here's the thing about "
      -
        type: text
        marks:
          -
            type: bold
        text: 0.15%
      -
        type: text
        text: ": when you run tests hundreds of times a day across a team, you're guaranteed to see these failures. "
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'Every. '
      -
        type: hardBreak
      -
        type: text
        text: 'Single. '
      -
        type: hardBreak
      -
        type: text
        text: Day.
  -
    type: horizontalRule
  -
    type: set
    attrs:
      id: mjg960ds
      values:
        type: sidenote
        content:
          -
            type: paragraph
            content:
              -
                type: text
                text: '(A Story of Denial)'
        style: note
        position: right
  -
    type: heading
    attrs:
      textAlign: left
      level: 1
    content:
      -
        type: text
        text: 'How Did We Get Here?'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'The path to test suite hell is paved with good intentions and bad habits.'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'It starts innocently:'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'A test fails. '
      -
        type: hardBreak
      -
        type: text
        text: 'You rerun it. '
      -
        type: hardBreak
      -
        type: text
        text: 'It passes. '
      -
        type: hardBreak
      -
        type: text
        text: '"Must be timing," you think. '
      -
        type: hardBreak
      -
        type: text
        text: "You don't investigate. "
      -
        type: hardBreak
      -
        type: text
        text: 'Why would you? '
      -
        type: hardBreak
      -
        type: text
        text: "You have features to ship, deadlines to meet, and a PM who definitely doesn't care about your test infrastructure."
      -
        type: hardBreak
      -
        type: text
        text: 'Then it happens again. '
      -
        type: hardBreak
      -
        type: text
        text: 'And again. '
      -
        type: hardBreak
      -
        type: text
        text: 'And suddenly you have a culture.'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'The culture looks like this:'
  -
    type: bulletList
    content:
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                marks:
                  -
                    type: bold
                  -
                    type: italic
                text: “Flaky”
              -
                type: text
                marks:
                  -
                    type: bold
                text: ' becomes a label, not a problem to solve.'
              -
                type: text
                text: ' Tests get marked as '
              -
                type: text
                marks:
                  -
                    type: italic
                text: 'flaky and forgotten'
              -
                type: text
                text: '. People fix them occasionally - the same tests, multiple times - but they keep coming back like zombies.'
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                marks:
                  -
                    type: bold
                text: 'Trust erodes slowly, then all at once.'
              -
                type: text
                text: ' At some point, your team stops believing test failures mean anything. Red CI? Whatever. '
              -
                type: text
                marks:
                  -
                    type: italic
                text: 'Merge it'
              -
                type: text
                text: '. This is when bugs start sneaking through.'
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                marks:
                  -
                    type: bold
                text: 'Merge requests get blocked by tests that have nothing to do with your changes.'
              -
                type: text
                text: " You touched a CSS file. A payment processing test failed. Everyone knows it's unrelated. Everyone clicks rerun anyway. Twenty minutes of CI time, gone."
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                marks:
                  -
                    type: bold
                text: 'Technical debt compounds.'
              -
                type: text
                text: ' Quick fixes mask real issues. Someone weakens an assertion from “'
              -
                type: text
                marks:
                  -
                    type: italic
                text: 'equals 3”'
              -
                type: text
                text: ' to “'
              -
                type: text
                marks:
                  -
                    type: italic
                text: 'not empty”'
              -
                type: text
                text: ' because the count keeps changing. The test passes now. '
              -
                type: text
                marks:
                  -
                    type: italic
                text: 'It also proves nothing'
              -
                type: text
                text: .
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'We lived in this world for too long.'
  -
    type: horizontalRule
  -
    type: heading
    attrs:
      textAlign: left
      level: 1
    content:
      -
        type: text
        text: 'The Numbers That Actually Matter'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: "First, some context. We're talking about a test suite with:"
  -
    type: bulletList
    content:
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                marks:
                  -
                    type: bold
                text: '10,500+ tests'
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                marks:
                  -
                    type: bold
                text: '~40,000 assertions'
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                marks:
                  -
                    type: bold
                text: '~8 minutes'
              -
                type: text
                text: ' CI runtime'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: "That's not a toy project. Changes here ripple."
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: "Here's the thing about test suite statistics: most of them are noise. Test counts go up and down as features ship and code gets deleted. Assertion counts fluctuate with refactoring. In a startup environment where big features ship fast and pivot faster, these numbers tell you almost nothing about test quality."
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'But some numbers matter. These are the ones we tracked:'
  -
    type: table
    content:
      -
        type: tableRow
        content:
          -
            type: tableCell
            attrs:
              colspan: 1
              rowspan: 1
              colwidth: null
            content:
              -
                type: paragraph
                attrs:
                  textAlign: left
                content:
                  -
                    type: text
                    text: Metric
          -
            type: tableCell
            attrs:
              colspan: 1
              rowspan: 1
              colwidth: null
            content:
              -
                type: paragraph
                attrs:
                  textAlign: left
                content:
                  -
                    type: text
                    text: Before
          -
            type: tableCell
            attrs:
              colspan: 1
              rowspan: 1
              colwidth: null
            content:
              -
                type: paragraph
                attrs:
                  textAlign: left
                content:
                  -
                    type: text
                    text: After
      -
        type: tableRow
        content:
          -
            type: tableCell
            attrs:
              colspan: 1
              rowspan: 1
              colwidth: null
            content:
              -
                type: paragraph
                attrs:
                  textAlign: left
                content:
                  -
                    type: text
                    text: 'Flaky Failures'
          -
            type: tableCell
            attrs:
              colspan: 1
              rowspan: 1
              colwidth: null
            content:
              -
                type: paragraph
                attrs:
                  textAlign: left
                content:
                  -
                    type: text
                    text: '16'
          -
            type: tableCell
            attrs:
              colspan: 1
              rowspan: 1
              colwidth: null
            content:
              -
                type: paragraph
                attrs:
                  textAlign: left
                content:
                  -
                    type: text
                    text: '0'
      -
        type: tableRow
        content:
          -
            type: tableCell
            attrs:
              colspan: 1
              rowspan: 1
              colwidth: null
            content:
              -
                type: paragraph
                attrs:
                  textAlign: left
                content:
                  -
                    type: text
                    text: 'PHPUnit Notices'
          -
            type: tableCell
            attrs:
              colspan: 1
              rowspan: 1
              colwidth: null
            content:
              -
                type: paragraph
                attrs:
                  textAlign: left
                content:
                  -
                    type: text
                    text: '42'
          -
            type: tableCell
            attrs:
              colspan: 1
              rowspan: 1
              colwidth: null
            content:
              -
                type: paragraph
                attrs:
                  textAlign: left
                content:
                  -
                    type: text
                    text: '0'
      -
        type: tableRow
        content:
          -
            type: tableCell
            attrs:
              colspan: 1
              rowspan: 1
              colwidth: null
            content:
              -
                type: paragraph
                attrs:
                  textAlign: left
                content:
                  -
                    type: text
                    text: 'Alias Mocks'
          -
            type: tableCell
            attrs:
              colspan: 1
              rowspan: 1
              colwidth: null
            content:
              -
                type: paragraph
                attrs:
                  textAlign: left
                content:
                  -
                    type: text
                    text: '43'
          -
            type: tableCell
            attrs:
              colspan: 1
              rowspan: 1
              colwidth: null
            content:
              -
                type: paragraph
                attrs:
                  textAlign: left
                content:
                  -
                    type: text
                    text: '0'
      -
        type: tableRow
        content:
          -
            type: tableCell
            attrs:
              colspan: 1
              rowspan: 1
              colwidth: null
            content:
              -
                type: paragraph
                attrs:
                  textAlign: left
                content:
                  -
                    type: text
                    text: 'Risky Tests'
          -
            type: tableCell
            attrs:
              colspan: 1
              rowspan: 1
              colwidth: null
            content:
              -
                type: paragraph
                attrs:
                  textAlign: left
                content:
                  -
                    type: text
                    text: '12'
          -
            type: tableCell
            attrs:
              colspan: 1
              rowspan: 1
              colwidth: null
            content:
              -
                type: paragraph
                attrs:
                  textAlign: left
                content:
                  -
                    type: text
                    text: '0'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: "Let's talk about what these actually mean."
  -
    type: set
    attrs:
      id: mjc14x79
      values:
        type: sidenote
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                text: "Don't obsess over total test count or assertion count. Those numbers reflect your codebase size, not your test quality. Focus on failures, notices, and risky tests. Those are the metrics that tell you if your suite is trustworthy."
        style: note
        position: right
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        marks:
          -
            type: bold
        text: '16 flaky failures went to zero.'
      -
        type: text
        text: ' These were the tests that passed locally and failed in CI. The ones that “'
      -
        type: text
        marks:
          -
            type: italic
        text: 'just needed a rerun.”'
      -
        type: text
        text: ' Every single one was a real bug - either in the test or in production code. We found the root cause for each.'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        marks:
          -
            type: bold
        text: '42 PHPUnit notices eliminated.'
      -
        type: text
        text: ' These were risky tests - tests without assertions. PHPUnit was literally telling us "this test proves nothing" and we ignored it. A test that doesn''t assert anything is not a test. It''s a lie you tell CI.'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        marks:
          -
            type: bold
        text: '43 alias mocks killed.'
      -
        type: text
        text: ' Every one of them was a parallelization time bomb. We replaced them with the factory pattern (covered in Part 2). This took the most effort but had the biggest impact on CI reliability.'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        marks:
          -
            type: bold
        text: '12 risky tests fixed.'
      -
        type: text
        text: " Tests that ran but didn't actually verify anything. They probably worked once, then broke silently as the codebase evolved. Nobody noticed because they never failed - "
      -
        type: text
        marks:
          -
            type: italic
        text: 'they just stopped testing'
      -
        type: text
        text: .
  -
    type: horizontalRule
  -
    type: set
    attrs:
      id: mjc174i9
      values:
        type: sidenote
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                text: '(Memorize This)'
        style: note
        position: right
  -
    type: heading
    attrs:
      textAlign: left
      level: 1
    content:
      -
        type: text
        text: 'The Flakiness Rule'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'If a test fails intermittently, treat it as a '
      -
        type: text
        marks:
          -
            type: bold
        text: 'deterministic bug'
      -
        type: text
        text: '. '
      -
        type: hardBreak
      -
        type: text
        text: 'Period. '
      -
        type: hardBreak
      -
        type: text
        text: 'Full stop. '
      -
        type: hardBreak
      -
        type: text
        text: 'No exceptions.'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'The bug is either:'
  -
    type: bulletList
    content:
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                marks:
                  -
                    type: bold
                text: 'In the test itself:'
              -
                type: text
                text: ' Bad assumptions, global state leaks, time dependencies, race conditions in test setup, or reliance on execution order.'
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                marks:
                  -
                    type: bold
                text: 'In production code:'
              -
                type: text
                text: ' Hidden side effects, non-deterministic database queries, code paths that behave differently under load or timing.'
  -
    type: blockquote
    content:
      -
        type: paragraph
        attrs:
          textAlign: left
        content:
          -
            type: text
            text: "There's no such thing as “just flaky.” There are only bugs you haven't found yet."
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'When someone says '
      -
        type: text
        marks:
          -
            type: italic
        text: '“that test is flaky,”'
      -
        type: text
        text: " what they're really saying is “"
      -
        type: text
        marks:
          -
            type: italic
        text: 'I don’t know why this fails and I don’t want to find out.”'
      -
        type: text
        text: ' And look, I get it. Debugging flaky tests is soul-crushing work. But ignoring them is worse.'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: "Every flaky test is a tiny crack in your test suite's credibility. Enough cracks and the whole thing becomes useless. Why run tests at all if you can't trust the results?"
  -
    type: horizontalRule
  -
    type: heading
    attrs:
      textAlign: left
      level: 1
    content:
      -
        type: text
        text: 'The Six Deadly Sins of Flaky Tests'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'Over 300+ commits, we cataloged every flaky test we fixed. They all fell into six categories.'
  -
    type: set
    attrs:
      id: mjc23q83
      values:
        type: sidenote
        content:
          -
            type: paragraph
            content:
              -
                type: text
                marks:
                  -
                    type: italic
                text: '(The Silent Killer)'
        style: note
        position: right
  -
    type: heading
    attrs:
      textAlign: left
      level: 2
    content:
      -
        type: text
        text: Time
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'Time is the sneakiest cause of flakiness. Your code uses '
      -
        type: text
        marks:
          -
            type: code
        text: now()
      -
        type: text
        text: ', '
      -
        type: text
        marks:
          -
            type: code
        text: today()
      -
        type: text
        text: ', or '
      -
        type: text
        marks:
          -
            type: code
        text: 'Date::parse()'
      -
        type: text
        text: '. Your test runs at '
      -
        type: text
        marks:
          -
            type: code
        text: '11:59 PM'
      -
        type: text
        text: '. It passes. Tomorrow it runs at '
      -
        type: text
        marks:
          -
            type: code
        text: '12:01 AM'
      -
        type: text
        text: '. It fails. Same code. Same data. Different day.'
  -
    type: set
    attrs:
      id: mjc26hy2
      values:
        type: sidenote
        content:
          -
            type: paragraph
            content:
              -
                type: text
                marks:
                  -
                    type: code
                text: "Date::parse('Today, 17:00')"
              -
                type: text
                text: ' - Nothing says '
              -
                type: text
                marks:
                  -
                    type: italic
                text: '“I enjoy debugging timezone issues at 3 AM”'
              -
                type: text
                text: ' quite like natural language date parsing. Use explicit timestamps: '
              -
                type: text
                marks:
                  -
                    type: code
                text: "'2025-01-15 17:00:00'"
              -
                type: text
                text: '. Boring, but it works in every timezone and survives daylight saving time.'
        style: note
        position: right
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        marks:
          -
            type: bold
        text: 'The usual suspects:'
  -
    type: bulletList
    content:
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                text: 'Timestamp comparisons in payloads'
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                text: 'TTL and cache expiration logic'
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                text: 'Business day calculations ("next Wednesday")'
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                text: 'Scheduled jobs and cron-dependent code'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        marks:
          -
            type: bold
        text: 'The fix:'
      -
        type: text
        text: ' Freeze time.'
  -
    type: codeBlock
    attrs:
      language: null
    content:
      -
        type: text
        text: |-
          $this->travelTo(now()->startOfMinute());
          // ... test logic that involves timestamps ...
          $this->travelBack();
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: "Your test now lives in a frozen moment. Time doesn't pass. Timestamps don't drift. Life is predictable. This is the way."
  -
    type: set
    attrs:
      id: mjc2bttu
      values:
        type: sidenote
        content:
          -
            type: paragraph
            content:
              -
                type: text
                marks:
                  -
                    type: italic
                text: '(The False Prophet)'
        style: note
        position: right
  -
    type: heading
    attrs:
      textAlign: left
      level: 2
    content:
      -
        type: text
        text: Randomness
  -
    type: set
    attrs:
      id: mjc2d3fd
      values:
        type: thought
        content:
          -
            type: paragraph
            content:
              -
                type: text
                text: '“I’ll use '
              -
                type: text
                marks:
                  -
                    type: code
                text: '$faker->numberBetween(2, 5)'
              -
                type: text
                text: ' so my test covers different cases!”'
        position: left
  -
    type: set
    attrs:
      id: mjc2dbzu
      values:
        type: thought
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                text: "No. No, you won't."
        position: right
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: "What you've actually done is create a test that sometimes creates 2 records, sometimes 3, sometimes 5. Your assertion expects exactly 3. Congratulations, you've invented chaos engineering without any of the benefits."
  -
    type: codeBlock
    attrs:
      language: null
    content:
      -
        type: text
        text: |-
          // This is not testing. This is gambling.
          $orders = Order::factory()
              ->times($this->faker->numberBetween(2, 5))
              ->create();

          $this->assertCount(3, $orders);  // 40% success rate, roughly
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        marks:
          -
            type: bold
        text: 'The fix:'
      -
        type: text
        text: ' Use fixed, deterministic values.'
  -
    type: codeBlock
    attrs:
      language: null
    content:
      -
        type: text
        text: '$orders = Order::factory()->times(3)->create();'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'Boring? Yes. Predictable? Also yes. Reliable? '
      -
        type: text
        marks:
          -
            type: bold
        text: 'Absolutely yes'
      -
        type: text
        text: .
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'If you want to test multiple cases, use a '
      -
        type: text
        marks:
          -
            type: code
        text: DataProvider
      -
        type: text
        text: '. Test all the cases. '
      -
        type: text
        marks:
          -
            type: italic
        text: Explicitly
      -
        type: text
        text: ". Don't roll the dice and hope you're covering edge cases."
  -
    type: heading
    attrs:
      textAlign: left
      level: 2
    content:
      -
        type: text
        text: 'Ordering & Timestamp Precision'
  -
    type: set
    attrs:
      id: mjc2hug7
      values:
        type: thought
        content:
          -
            type: paragraph
            content:
              -
                type: text
                text: '“I created two records at the same time.”'
        position: left
  -
    type: set
    attrs:
      id: mjc2i8kb
      values:
        type: thought
        content:
          -
            type: paragraph
            content:
              -
                type: text
                text: "You didn't. You created one record, then nanoseconds later, you created another. Usually this doesn't matter. Sometimes it does."
        position: right
  -
    type: codeBlock
    attrs:
      language: null
    content:
      -
        type: text
        text: |-
          // Production code:
          $hasNewerApplication = $farmer->applications()
              ->where('created_at', '>', $application->created_at)
              ->exists();

          // Test code: create two records "at the same time"
          $app1 = Application::factory()->create();
          $app2 = Application::factory()->create();

          // Surprise: app2->created_at is 3 milliseconds after app1
          // Your boolean just became a coin flip
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        marks:
          -
            type: bold
        text: 'The fix:'
      -
        type: text
        text: ' Set timestamps explicitly.'
  -
    type: codeBlock
    attrs:
      language: null
    content:
      -
        type: text
        text: |-
          $createdAt = now()->startOfSecond();

          $applications = Application::factory()
              ->count(2)
              ->create([
                  'created_at' => $createdAt,
                  'updated_at' => $createdAt,
              ]);
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'Now they really are created at the same time. The universe is deterministic again.'
  -
    type: heading
    attrs:
      textAlign: left
      level: 2
    content:
      -
        type: text
        text: 'Global State Leaks'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'The test that works alone but fails when run with others. The classic '
      -
        type: text
        marks:
          -
            type: italic
        text: '“it works on my machine, in isolation, when the moon is full”'
      -
        type: text
        text: ' problem.'
  -
    type: set
    attrs:
      id: mjc2m55a
      values:
        type: sidenote
        content:
          -
            type: paragraph
            content:
              -
                type: text
                text: 'If you must change global state, restore it in '
              -
                type: text
                marks:
                  -
                    type: code
                text: tearDown()
              -
                type: text
                text: ' in the same test class. Not '
              -
                type: text
                marks:
                  -
                    type: italic
                text: “eventually.”
              -
                type: text
                text: ' Not '
              -
                type: text
                marks:
                  -
                    type: italic
                text: '“in some other test.”'
              -
                type: text
                text: " Right there. Same file. Don't make future-you hunt for it."
        style: note
        position: right
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        marks:
          -
            type: bold
        text: 'Common culprits:'
  -
    type: bulletList
    content:
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                marks:
                  -
                    type: bold
                text: 'Locale and timezone:'
              -
                type: text
                text: ' Your code formats dates. Another test changed the locale. Your assertions fail.'
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                marks:
                  -
                    type: bold
                text: 'Config cache:'
              -
                type: text
                text: ' You mocked a config value. Another test has cached config. Your mock gets ignored.'
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                marks:
                  -
                    type: bold
                text: 'Eloquent events:'
              -
                type: text
                text: ' A test called '
              -
                type: text
                marks:
                  -
                    type: code
                text: 'Model::unsetEventDispatcher()'
              -
                type: text
                text: '. Your factory relies on a '
              -
                type: text
                marks:
                  -
                    type: code
                text: creating
              -
                type: text
                text: ' event to set defaults. Your model is now incomplete.'
  -
    type: codeBlock
    attrs:
      language: null
    content:
      -
        type: text
        text: |-
          // If you do this...
          Model::unsetEventDispatcher();

          // ...you MUST do this in the same test class
          protected function tearDown(): void
          {
              Model::setEventDispatcher($this->app['events']);
              
              parent::tearDown();
          }
  -
    type: heading
    attrs:
      textAlign: left
      level: 2
    content:
      -
        type: text
        text: 'Parallelization Hazards'
  -
    type: set
    attrs:
      id: mjc2qo71
      values:
        type: sidenote
        content:
          -
            type: paragraph
            content:
              -
                type: text
                text: "Alias mocks modify PHP's global class autoloader. When two tests try to do this simultaneously for the same class, they collide. It's not a bug in Mockery. It's a fundamental limitation of how alias mocking works. We'll cover this in gory detail in Part 2."
        style: note
        position: right
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: "Parallel test execution is wonderful until it isn't. The most common failure mode: "
      -
        type: text
        marks:
          -
            type: italic
        text: 'Mockery alias mocks'
      -
        type: text
        text: .
  -
    type: codeBlock
    attrs:
      language: null
    content:
      -
        type: text
        text: |-
          Mockery\Exception\RuntimeException: Could not load mock
          App\Services\SomeClass, class already exists
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'This error happens when two parallel tests try to mock the same class using '
      -
        type: text
        marks:
          -
            type: code
        text: "Mockery::mock('alias:...')"
      -
        type: text
        text: ". PHP's autoloader gets confused. Everything breaks. Your CI turns red."
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        marks:
          -
            type: bold
        text: 'The fix:'
      -
        type: text
        text: " Don't use alias mocks. Use the factory pattern instead. We dedicated all of Part 2 to this because we had to kill 43 of them."
  -
    type: heading
    attrs:
      textAlign: left
      level: 2
    content:
      -
        type: text
        text: 'Factories That Depend on Observers'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'Your factory creates a '
      -
        type: text
        marks:
          -
            type: code
        text: User
      -
        type: text
        text: '. An observer fires on create and sets their role. Another test disabled event dispatching. Your User has no role. Your test fails.'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'This is subtle and maddening.'
  -
    type: codeBlock
    attrs:
      language: null
    content:
      -
        type: text
        text: |-
          // Another test somewhere called:
          Model::unsetEventDispatcher();

          // Your factory relies on this observer to set the role:
          // UserObserver::creating() { $user->role = UserRole::OWNER; }

          // Now your test creates a User...
          $user = User::factory()->create();

          // ...and the role is null. Test fails.
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        marks:
          -
            type: bold
        text: 'The fix:'
      -
        type: text
        text: " Set critical attributes explicitly in factory states. Don't trust events to run."
  -
    type: codeBlock
    attrs:
      language: null
    content:
      -
        type: text
        text: "User::factory()->state(['role' => UserRole::OWNER])->create();"
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: "Yes, it's more verbose. Yes, it's more reliable. "
      -
        type: text
        marks:
          -
            type: italic
        text: 'Pick reliable.'
  -
    type: horizontalRule
  -
    type: set
    attrs:
      id: mjc2v0g8
      values:
        type: sidenote
        content:
          -
            type: paragraph
            content:
              -
                type: text
                text: '(The Stuff That Actually Works)'
        style: note
        position: right
  -
    type: heading
    attrs:
      textAlign: left
      level: 1
    content:
      -
        type: text
        text: 'Practical Patterns'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'Here are the patterns we use daily. Bookmark this section.'
  -
    type: heading
    attrs:
      textAlign: left
      level: 2
    content:
      -
        type: text
        text: 'Freeze Time for Payload Comparisons'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'When comparing serialized data that includes timestamps:'
  -
    type: codeBlock
    attrs:
      language: null
    content:
      -
        type: text
        text: |-
          $this->travelTo(now()->startOfMinute());

          $order = Order::factory()->create();
          $expectedPayload = CustomerLoanRequestDTO::fromOrder($order);

          ReportOverdueOrderJob::dispatchSync($order->id);

          // Timestamps match because time is frozen
          $this->assertDatabaseHas('credit_bureau_reports', [
              'payload' => $expectedPayload->toString(),
          ]);

          $this->travelBack();
  -
    type: heading
    attrs:
      textAlign: left
      level: 2
    content:
      -
        type: text
        text: 'Stabilize '
      -
        type: text
        marks:
          -
            type: code
        text: created_at
      -
        type: text
        text: ' Comparisons'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'When your code checks “'
      -
        type: text
        marks:
          -
            type: italic
        text: 'is there a newer record?”'
      -
        type: text
        text: ':'
  -
    type: codeBlock
    attrs:
      language: null
    content:
      -
        type: text
        text: |-
          $createdAt = now()->startOfSecond();

          $applications = Application::factory()
              ->for($farmer)
              ->count(2)
              ->create([
                  'created_at' => $createdAt,
                  'updated_at' => $createdAt,
              ]);

          // Now the "newer record exists?" check behaves consistently
  -
    type: horizontalRule
  -
    type: heading
    attrs:
      textAlign: left
      level: 1
    content:
      -
        type: text
        text: 'How to Verify Your Fix Actually Fixed It'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: "You fixed a flaky test. Or did you? Here's how to be sure."
  -
    type: set
    attrs:
      id: mjcf5seq
      values:
        type: sidenote
        content:
          -
            type: paragraph
            content:
              -
                type: text
                text: "If it fails once in 100 runs, it's still flaky. You haven't found the root cause. You've just made the odds better. Keep digging."
        style: note
        position: right
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        marks:
          -
            type: bold
        text: 'Step 1: Run it many times'
  -
    type: codeBlock
    attrs:
      language: null
    content:
      -
        type: text
        text: |-
          for i in {1..100}; do
              php artisan test --filter=it_handles_payment_status || break
          done
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: "If it fails once, you haven't fixed it. You've just made it less frequent."
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        marks:
          -
            type: bold
        text: 'Step 2: Run in random order'
  -
    type: codeBlock
    attrs:
      language: null
    content:
      -
        type: text
        text: './vendor/bin/phpunit --order-by=random'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'This exposes global state leaks. If your test only passes when run after some other test, you have a dependency bug.'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        marks:
          -
            type: bold
        text: 'Step 3: Run in parallel'
  -
    type: codeBlock
    attrs:
      language: null
    content:
      -
        type: text
        text: 'php artisan test --parallel --filter=YourTestClass'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'This exposes parallelization issues. Race conditions. Alias mock collisions. All the fun stuff.'
  -
    type: horizontalRule
  -
    type: heading
    attrs:
      textAlign: left
      level: 1
    content:
      -
        type: text
        text: 'The Flakiness Checklist'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'Print this. Tape it to your monitor. Use it when writing or reviewing tests.'
  -
    type: bulletList
    content:
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                marks:
                  -
                    type: bold
                text: 'No random values affect test logic or counts.'
              -
                type: text
                text: ' Faker is for names and emails, not for determining how many records to create.'
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                marks:
                  -
                    type: bold
                text: 'Time is frozen when relevant.'
              -
                type: text
                text: ' If your code uses '
              -
                type: text
                marks:
                  -
                    type: code
                text: now()
              -
                type: text
                text: ' anywhere, your test probably needs '
              -
                type: text
                marks:
                  -
                    type: code
                text: travelTo()
              -
                type: text
                text: .
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                marks:
                  -
                    type: bold
                text: 'Time is reset afterwards.'
              -
                type: text
                text: " Don't let frozen time leak to other tests."
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                marks:
                  -
                    type: bold
                text: "Assertions don't rely on implicit ordering."
              -
                type: text
                text: " If order matters, assert it explicitly. If it doesn't, don't assume it."
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                marks:
                  -
                    type: bold
                text: 'Global state changes are restored in '
              -
                type: text
                marks:
                  -
                    type: code
                text: tearDown()
              -
                type: text
                marks:
                  -
                    type: bold
                text: .
              -
                type: text
                text: ' Same test class. Same file. No exceptions.'
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                marks:
                  -
                    type: bold
                text: 'No alias/overload mocks.'
              -
                type: text
                text: ' Not even one. Not even '
              -
                type: text
                marks:
                  -
                    type: italic
                text: '“just this once.”'
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                marks:
                  -
                    type: bold
                text: 'Factories set critical attributes explicitly.'
              -
                type: text
                text: " Don't rely on observers that might be disabled."
  -
    type: horizontalRule
  -
    type: heading
    attrs:
      textAlign: left
      level: 1
    content:
      -
        type: text
        text: "What's Next"
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'Part 1 was the why. The pain. The anatomy of a flaky test suite.'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: "Part 2 is where Mockery shows its dark side. We had 43 alias mocks across 5 test files. Every single one of them was a ticking time bomb in parallel execution. We'll cover:"
  -
    type: bulletList
    content:
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                text: 'Why alias mocks are fundamentally broken for parallel testing'
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                text: 'The factory pattern that saved us'
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                text: 'Why '
              -
                type: text
                marks:
                  -
                    type: code
                text: '@runInSeparateProcess'
              -
                type: text
                text: " is not a solution (it's a surrender)"
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                text: 'PHPUnit mocks vs Mockery mocks, when to use which'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'See you there. And maybe fix that one flaky test before you continue. You know the one.'
  -
    type: horizontalRule
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        marks:
          -
            type: italic
        text: 'The Flaky Test Chronicles is a series documenting what we learned from 300+ commits of test suite cleanup. May your CI be green and your reruns be few.'
---
