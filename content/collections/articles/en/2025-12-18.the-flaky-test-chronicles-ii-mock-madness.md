---
id: 1998cc39-c36d-4965-a18d-42df897655b0
blueprint: articles
title: 'The Flaky Test Chronicles II: Mock Madness'
subtitle: 'Making Mockery Parallel-Safe'
updated_by: b8f3533e-0fcf-42b9-a3d8-c8691deaf917
updated_at: 1766612443
display_date: '2025-12-25'
og_generator_image: the-flaky-test-chronicles-ii-mock-madness.jpg
show_toc: true
toc_levels:
  - 1
content:
  -
    type: heading
    attrs:
      textAlign: left
      level: 1
    content:
      -
        type: text
        text: 'The Crime Scene'
  -
    type: blockquote
    content:
      -
        type: paragraph
        attrs:
          textAlign: left
        content:
          -
            type: text
            text: '53 alias and overload mocks walked into a CI pipeline. None of them came out parallel-safe.'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'One morning we saw this error in CI:'
  -
    type: codeBlock
    attrs:
      language: null
    content:
      -
        type: text
        text: |-
          Mockery\Exception\RuntimeException: Could not load mock
          App\Services\TarfinPayment\CreditCard\CreditCardPayment, class already exists
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: "Test passes locally. Fails in CI. The classic. But this time, I knew exactly what it was. I just didn't want to admit it."
  -
    type: set
    attrs:
      id: mjcj20zq
      values:
        type: sidenote
        content:
          -
            type: paragraph
            content:
              -
                type: text
                text: "There's a special circle of debugging hell reserved for errors that only happen in CI. Right next to “"
              -
                type: text
                marks:
                  -
                    type: italic
                text: 'works on my machine.”'
        style: note
        position: right
  -
    type: paragraph
    attrs:
      textAlign: left
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'The problem: '
      -
        type: text
        marks:
          -
            type: bold
        text: 'Mockery alias mocks.'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'Across multiple test files, we were using '
      -
        type: text
        marks:
          -
            type: code
        text: "Mockery::mock('alias:...')"
      -
        type: text
        text: ' and '
      -
        type: text
        marks:
          -
            type: code
        text: "Mockery::mock('overload:...')"
      -
        type: text
        text: " in 53 places. And these mocks weren't compatible with parallel test runners."
  -
    type: horizontalRule
  -
    type: heading
    attrs:
      textAlign: left
      level: 1
    content:
      -
        type: text
        text: 'Why Alias Mocks Are the Enemy'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: "Mockery's "
      -
        type: text
        marks:
          -
            type: code
        text: 'alias:'
      -
        type: text
        text: ' prefix lets you mock static methods and class instantiation. Sounds great. But it has serious problems.'
  -
    type: heading
    attrs:
      textAlign: left
      level: 2
    content:
      -
        type: text
        text: 'Problem 1: Not Parallel-Safe'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'Alias mocks '
      -
        type: text
        marks:
          -
            type: bold
        text: globally
      -
        type: text
        text: " modify PHP's class autoloader. When two tests run in parallel and try to mock the same class:"
  -
    type: set
    attrs:
      id: overload_same_issue
      values:
        type: sidenote
        content:
          -
            type: paragraph
            content:
              -
                type: text
                text: 'The same applies to '
              -
                type: text
                marks:
                  -
                    type: code
                text: 'overload:'
              -
                type: text
                text: ' mocks. They''re actually a superset of '
              -
                type: text
                marks:
                  -
                    type: code
                text: 'alias:'
              -
                type: text
                text: '—same class registry manipulation, same parallel-unsafe behavior.'
        style: warning
        position: right
  -
    type: codeBlock
    attrs:
      language: null
    content:
      -
        type: text
        text: 'class already exists'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'PHP looks at you like you just asked it to divide by zero.'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: "Tests run in parallel by default in CI environments. If you run sequentially locally, you won't notice. It blows up in CI."
  -
    type: set
    attrs:
      id: mockery_docs_link
      values:
        type: sidenote
        content:
          -
            type: paragraph
            content:
              -
                type: text
                text: 'For the official explanation, see '
              -
                type: text
                marks:
                  -
                    type: link
                    attrs:
                      href: 'https://docs.mockery.io/en/stable/cookbook/mocking_hard_dependencies.html'
                      rel: null
                      target: _blank
                      title: null
                text: 'Mockery documentation on mocking hard dependencies'
              -
                type: text
                text: .
        style: note
        position: right
  -
    type: heading
    attrs:
      textAlign: left
      level: 3
    content:
      -
        type: text
        text: 'But Wait, Doesn''t Mockery::close() Fix This?'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'No. Here''s the thing: '
      -
        type: text
        marks:
          -
            type: bold
        text: 'PHP cannot unload a class once it''s been defined.'
      -
        type: text
        text: ' This is a fundamental limitation of the PHP runtime, not a Mockery bug.'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'When you call '
      -
        type: text
        marks:
          -
            type: code
        text: 'Mockery::close()'
      -
        type: text
        text: ', it does these things:'
  -
    type: bulletList
    content:
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                text: 'Verifies that all mock expectations were met'
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                text: 'Releases mock object references from memory'
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                text: 'Prevents memory leaks between tests'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'But it '
      -
        type: text
        marks:
          -
            type: bold
        text: cannot
      -
        type: text
        text: ' remove the fake class definition from PHP''s class registry. Once '
      -
        type: text
        marks:
          -
            type: code
        text: CreditCardPayment
      -
        type: text
        text: ' is defined (even as a mock), it stays defined until the PHP process terminates.'
  -
    type: codeBlock
    attrs:
      language: null
    content:
      -
        type: text
        text: |-
          Test A: Mockery::mock('alias:CreditCardPayment')
                  → Fake CreditCardPayment registered in PHP's class registry

          Test A ends: Mockery::close()
                  → Mock expectations cleared
                  → BUT: CreditCardPayment class definition still in memory!

          Test B: Mockery::mock('alias:CreditCardPayment')
                  → FATAL: "class already exists"
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'This is why alias mocks and parallel testing are fundamentally incompatible—not because Mockery is broken, but because PHP''s class system doesn''t support class unloading.'
  -
    type: heading
    attrs:
      textAlign: left
      level: 2
    content:
      -
        type: text
        text: 'Problem 2: The Process Isolation Tax'
  -
    type: set
    attrs:
      id: mjcji1e8
      values:
        type: sidenote
        content:
          -
            type: paragraph
            content:
              -
                type: text
                text: 'Using '
              -
                type: text
                marks:
                  -
                    type: code
                text: '@runInSeparateProcess'
              -
                type: text
                text: " is like solving a flat tire by buying a new car. It works, technically. It's just 10-100x more expensive."
        style: note
        position: right
  -
    type: set
    attrs:
      id: mjcji4nu
      values:
        type: sidenote
        content:
          -
            type: paragraph
            content:
              -
                type: text
                text: 'In a suite of 10,000 tests, separate process for each test = hours. A test takes 100ms, process spawn takes 500ms. The math is terrible.'
        style: note
        position: right
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'The only safe way to use alias mocks is with '
      -
        type: text
        marks:
          -
            type: code
        text: '@runInSeparateProcess'
      -
        type: text
        text: ' annotation. But this:'
  -
    type: bulletList
    content:
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                marks:
                  -
                    type: bold
                text: 'Slows down by 10-100x'
              -
                type: text
                text: ' - Each test spawns a new PHP process'
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                marks:
                  -
                    type: bold
                text: 'Makes debugging impossible'
              -
                type: text
                text: ' - Breakpoints and '
              -
                type: text
                marks:
                  -
                    type: code
                text: var_dump
              -
                type: text
                text: " don't work"
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                marks:
                  -
                    type: bold
                text: 'Memory overhead'
              -
                type: text
                text: ' - Each process reloads the framework'
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                marks:
                  -
                    type: bold
                text: 'Multiplies CI time'
              -
                type: text
                text: " - Parallel runner can't optimize"
  -
    type: set
    attrs:
      id: mjcjirp0
      values:
        type: sidenote
        content:
          -
            type: paragraph
            content:
              -
                type: text
                text: 'Need for alias mocks = refactoring opportunity. Making production code more testable is better than hacking tests.'
        style: note
        position: right
  -
    type: heading
    attrs:
      textAlign: left
      level: 2
    content:
      -
        type: text
        text: 'Problem 3: Design Smell'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'If you need alias mocks, your code is tightly coupled to static calls. This is a '
      -
        type: text
        marks:
          -
            type: bold
        text: 'design problem'
      -
        type: text
        text: .
  -
    type: horizontalRule
  -
    type: set
    attrs:
      id: mjcjjfxk
      values:
        type: sidenote
        content:
          -
            type: paragraph
            content:
              -
                type: text
                text: '(With Tears)'
        style: note
        position: right
  -
    type: heading
    attrs:
      textAlign: left
      level: 1
    content:
      -
        type: text
        text: 'The Pattern to Avoid'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: "Here's the pattern we saw 43 times in our project:"
  -
    type: codeBlock
    attrs:
      language: null
    content:
      -
        type: text
        text: |-
          // BAD: Alias mock - not parallel-safe
          Mockery::mock('alias:'.CreditCardPayment::class)
              ->shouldReceive('create')
              ->with($payableDTO, $cardNumber)
              ->once()
              ->andReturnSelf()
              ->shouldReceive('withCard')
              ->andReturnSelf()
              ->shouldReceive('pay3d')
              ->andReturn(redirect($url));
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: "This code works. Locally. In sequential mode. But when CI's parallel runner kicks in, it explodes."
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'The core issue? '
      -
        type: text
        marks:
          -
            type: code
        text: 'CreditCardPayment::create()'
      -
        type: text
        text: " is a static factory method. Static calls don't go through Laravel's container. You can't intercept them with "
      -
        type: text
        marks:
          -
            type: code
        text: $this->mock()
      -
        type: text
        text: '. The only way to mock them is with alias mocks, which brings us back to the parallel-unsafe territory.'
  -
    type: horizontalRule
  -
    type: heading
    attrs:
      textAlign: left
      level: 1
    content:
      -
        type: text
        text: 'Why Container Mocking is Parallel-Safe'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: "Before we look at solutions, let's understand why container-based mocking doesn't suffer from the same parallel test issues."
  -
    type: set
    attrs:
      id: container_mock_sidenote
      values:
        type: sidenote
        content:
          -
            type: paragraph
            content:
              -
                type: text
                text: 'This distinction is crucial. Once you understand it, the solution becomes obvious.'
        style: note
        position: right
  -
    type: table
    content:
      -
        type: tableRow
        content:
          -
            type: tableHeader
            attrs:
              colspan: 1
              rowspan: 1
              colwidth: null
            content:
              -
                type: paragraph
                attrs:
                  textAlign: left
                content:
                  -
                    type: text
                    marks:
                      -
                        type: bold
                    text: ' '
          -
            type: tableHeader
            attrs:
              colspan: 1
              rowspan: 1
              colwidth: null
            content:
              -
                type: paragraph
                attrs:
                  textAlign: left
                content:
                  -
                    type: text
                    marks:
                      -
                        type: bold
                    text: 'Alias Mock'
          -
            type: tableHeader
            attrs:
              colspan: 1
              rowspan: 1
              colwidth: null
            content:
              -
                type: paragraph
                attrs:
                  textAlign: left
                content:
                  -
                    type: text
                    marks:
                      -
                        type: bold
                    text: 'Container Mock'
      -
        type: tableRow
        content:
          -
            type: tableCell
            attrs:
              colspan: 1
              rowspan: 1
              colwidth: null
            content:
              -
                type: paragraph
                attrs:
                  textAlign: left
                content:
                  -
                    type: text
                    marks:
                      -
                        type: bold
                    text: 'What it modifies'
          -
            type: tableCell
            attrs:
              colspan: 1
              rowspan: 1
              colwidth: null
            content:
              -
                type: paragraph
                attrs:
                  textAlign: left
                content:
                  -
                    type: text
                    text: 'PHP Autoloader (global)'
          -
            type: tableCell
            attrs:
              colspan: 1
              rowspan: 1
              colwidth: null
            content:
              -
                type: paragraph
                attrs:
                  textAlign: left
                content:
                  -
                    type: text
                    text: 'Laravel Container (test-scoped)'
      -
        type: tableRow
        content:
          -
            type: tableCell
            attrs:
              colspan: 1
              rowspan: 1
              colwidth: null
            content:
              -
                type: paragraph
                attrs:
                  textAlign: left
                content:
                  -
                    type: text
                    marks:
                      -
                        type: bold
                    text: Scope
          -
            type: tableCell
            attrs:
              colspan: 1
              rowspan: 1
              colwidth: null
            content:
              -
                type: paragraph
                attrs:
                  textAlign: left
                content:
                  -
                    type: text
                    text: 'Entire PHP process'
          -
            type: tableCell
            attrs:
              colspan: 1
              rowspan: 1
              colwidth: null
            content:
              -
                type: paragraph
                attrs:
                  textAlign: left
                content:
                  -
                    type: text
                    text: 'Single test instance'
      -
        type: tableRow
        content:
          -
            type: tableCell
            attrs:
              colspan: 1
              rowspan: 1
              colwidth: null
            content:
              -
                type: paragraph
                attrs:
                  textAlign: left
                content:
                  -
                    type: text
                    marks:
                      -
                        type: bold
                    text: 'Parallel-safe?'
          -
            type: tableCell
            attrs:
              colspan: 1
              rowspan: 1
              colwidth: null
            content:
              -
                type: paragraph
                attrs:
                  textAlign: left
                content:
                  -
                    type: text
                    text: ❌
          -
            type: tableCell
            attrs:
              colspan: 1
              rowspan: 1
              colwidth: null
            content:
              -
                type: paragraph
                attrs:
                  textAlign: left
                content:
                  -
                    type: text
                    text: ✅
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: "When PHPUnit runs tests in parallel, each process gets its own PHP runtime and its own Laravel Application instance. Container bindings are isolated to that instance. Alias mocks, however, modify PHP's class autoloading mechanism—which is shared across the entire process."
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'The key insight: '
      -
        type: text
        marks:
          -
            type: bold
        text: 'any solution that routes through the container is parallel-safe'
      -
        type: text
        text: '. Factory injection, container binding, Facades—they all work because they use the container, not the autoloader.'
  -
    type: horizontalRule
  -
    type: heading
    attrs:
      textAlign: left
      level: 1
    content:
      -
        type: text
        text: 'The Escape Routes'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'Good news: there are multiple ways out of alias mock hell. Bad news: none of them are free.'
  -
    type: set
    attrs:
      id: escape_routes_sidenote
      values:
        type: sidenote
        content:
          -
            type: paragraph
            content:
              -
                type: text
                text: "Every solution requires touching production code. That's not a bug, it's a feature. The code needed to change to become testable."
        style: note
        position: right
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'Each approach trades off different things:'
  -
    type: table
    content:
      -
        type: tableRow
        content:
          -
            type: tableHeader
            attrs:
              colspan: 1
              rowspan: 1
              colwidth: null
            content:
              -
                type: paragraph
                attrs:
                  textAlign: left
                content:
                  -
                    type: text
                    marks:
                      -
                        type: bold
                    text: Approach
          -
            type: tableHeader
            attrs:
              colspan: 1
              rowspan: 1
              colwidth: null
            content:
              -
                type: paragraph
                attrs:
                  textAlign: left
                content:
                  -
                    type: text
                    marks:
                      -
                        type: bold
                    text: Effort
          -
            type: tableHeader
            attrs:
              colspan: 1
              rowspan: 1
              colwidth: null
            content:
              -
                type: paragraph
                attrs:
                  textAlign: left
                content:
                  -
                    type: text
                    marks:
                      -
                        type: bold
                    text: Elegance
          -
            type: tableHeader
            attrs:
              colspan: 1
              rowspan: 1
              colwidth: null
            content:
              -
                type: paragraph
                attrs:
                  textAlign: left
                content:
                  -
                    type: text
                    marks:
                      -
                        type: bold
                    text: 'Keeps Static Syntax'
          -
            type: tableHeader
            attrs:
              colspan: 1
              rowspan: 1
              colwidth: null
            content:
              -
                type: paragraph
                attrs:
                  textAlign: left
                content:
                  -
                    type: text
                    marks:
                      -
                        type: bold
                    text: Parallel-Safe
      -
        type: tableRow
        content:
          -
            type: tableCell
            attrs:
              colspan: 1
              rowspan: 1
              colwidth: null
            content:
              -
                type: paragraph
                attrs:
                  textAlign: left
                content:
                  -
                    type: text
                    text: 'Factory Pattern'
          -
            type: tableCell
            attrs:
              colspan: 1
              rowspan: 1
              colwidth: null
            content:
              -
                type: paragraph
                attrs:
                  textAlign: left
                content:
                  -
                    type: text
                    text: Low
          -
            type: tableCell
            attrs:
              colspan: 1
              rowspan: 1
              colwidth: null
            content:
              -
                type: paragraph
                attrs:
                  textAlign: left
                content:
                  -
                    type: text
                    text: Medium
          -
            type: tableCell
            attrs:
              colspan: 1
              rowspan: 1
              colwidth: null
            content:
              -
                type: paragraph
                attrs:
                  textAlign: left
                content:
                  -
                    type: text
                    text: ❌
          -
            type: tableCell
            attrs:
              colspan: 1
              rowspan: 1
              colwidth: null
            content:
              -
                type: paragraph
                attrs:
                  textAlign: left
                content:
                  -
                    type: text
                    text: ✅
      -
        type: tableRow
        content:
          -
            type: tableCell
            attrs:
              colspan: 1
              rowspan: 1
              colwidth: null
            content:
              -
                type: paragraph
                attrs:
                  textAlign: left
                content:
                  -
                    type: text
                    text: 'Facade Pattern'
          -
            type: tableCell
            attrs:
              colspan: 1
              rowspan: 1
              colwidth: null
            content:
              -
                type: paragraph
                attrs:
                  textAlign: left
                content:
                  -
                    type: text
                    text: High
          -
            type: tableCell
            attrs:
              colspan: 1
              rowspan: 1
              colwidth: null
            content:
              -
                type: paragraph
                attrs:
                  textAlign: left
                content:
                  -
                    type: text
                    text: High
          -
            type: tableCell
            attrs:
              colspan: 1
              rowspan: 1
              colwidth: null
            content:
              -
                type: paragraph
                attrs:
                  textAlign: left
                content:
                  -
                    type: text
                    text: ✅
          -
            type: tableCell
            attrs:
              colspan: 1
              rowspan: 1
              colwidth: null
            content:
              -
                type: paragraph
                attrs:
                  textAlign: left
                content:
                  -
                    type: text
                    text: ✅
      -
        type: tableRow
        content:
          -
            type: tableCell
            attrs:
              colspan: 1
              rowspan: 1
              colwidth: null
            content:
              -
                type: paragraph
                attrs:
                  textAlign: left
                content:
                  -
                    type: text
                    text: 'Container Binding'
          -
            type: tableCell
            attrs:
              colspan: 1
              rowspan: 1
              colwidth: null
            content:
              -
                type: paragraph
                attrs:
                  textAlign: left
                content:
                  -
                    type: text
                    text: Lowest
          -
            type: tableCell
            attrs:
              colspan: 1
              rowspan: 1
              colwidth: null
            content:
              -
                type: paragraph
                attrs:
                  textAlign: left
                content:
                  -
                    type: text
                    text: Low
          -
            type: tableCell
            attrs:
              colspan: 1
              rowspan: 1
              colwidth: null
            content:
              -
                type: paragraph
                attrs:
                  textAlign: left
                content:
                  -
                    type: text
                    text: ❌
          -
            type: tableCell
            attrs:
              colspan: 1
              rowspan: 1
              colwidth: null
            content:
              -
                type: paragraph
                attrs:
                  textAlign: left
                content:
                  -
                    type: text
                    text: ✅
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: "Let's explore each one."
  -
    type: horizontalRule
  -
    type: heading
    attrs:
      textAlign: left
      level: 1
    content:
      -
        type: text
        text: 'Option 1: Factory Pattern'
  -
    type: set
    attrs:
      id: factory_speed_sidenote
      values:
        type: sidenote
        content:
          -
            type: paragraph
            content:
              -
                type: text
                text: 'The factory pattern is the duct tape of software design. Not pretty, but it holds things together when you need to ship.'
        style: note
        position: right
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'The '
      -
        type: text
        marks:
          -
            type: link
            attrs:
              href: 'https://en.wikipedia.org/wiki/Factory_method_pattern'
              rel: null
              target: _blank
              title: null
          -
            type: bold
        text: 'Factory pattern'
      -
        type: text
        text: ' wraps your static calls in an injectable class. Quick to implement, gets the job done.'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        marks:
          -
            type: bold
        text: 'Pros:'
      -
        type: text
        text: ' Minimal changes, fast to implement, works immediately'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        marks:
          -
            type: bold
        text: 'Cons:'
      -
        type: text
        text: ' Changes call sites from '
      -
        type: text
        marks:
          -
            type: code
        text: 'Class::method()'
      -
        type: text
        text: ' to '
      -
        type: text
        marks:
          -
            type: code
        text: $this->factory->method()
  -
    type: set
    attrs:
      id: mjcjnftr
      values:
        type: sidenote
        content:
          -
            type: paragraph
            content:
              -
                type: text
                text: 'Why did we remove return types? PHP 8.2+ '
              -
                type: text
                marks:
                  -
                    type: code
                text: readonly
              -
                type: text
                text: " classes can't be extended. Mockery can't create typed mocks of these classes. Removing the return type lets Mockery return a generic mock."
        style: note
        position: right
  -
    type: heading
    attrs:
      textAlign: left
      level: 2
    content:
      -
        type: text
        text: 'Step 1: Create a Factory Class'
  -
    type: codeBlock
    attrs:
      language: null
    content:
      -
        type: text
        text: |-
          <?php

          declare(strict_types=1);

          namespace App\Services\TarfinPayment\CreditCard;

          use App\Enums\PlatformType;
          use App\Services\TarfinPayment\CreditCard\DTOs\PayableDTO;

          class CreditCardPaymentFactory
          {
              /**
               * Create a CreditCardPayment instance.
               *
               * Note: Return type intentionally omitted for Mockery compatibility
               * with readonly classes.
               *
               * @return CreditCardPayment
               */
              public function create(PayableDTO $payable, ?string $cardNumber = null, ?PlatformType $platformType = null)
              {
                  return CreditCardPayment::create($payable, $cardNumber, $platformType);
              }

              /**
               * Get default payment calculator.
               *
               * @return AbstractPaymentTableCalculator
               */
              public function default()
              {
                  return CreditCardPayment::default();
              }
          }
  -
    type: heading
    attrs:
      textAlign: left
      level: 2
    content:
      -
        type: text
        text: 'Step 2: Inject the Factory in Controllers'
  -
    type: codeBlock
    attrs:
      language: null
    content:
      -
        type: text
        text: |-
          class OrderPayWithCreditCardController extends Controller
          {
              public function __construct(
                  private readonly CreditCardPaymentFactory $creditCardPaymentFactory
              ) {}

              public function pay3D(Request $request, Order $order): RedirectResponse
              {
                  $payableDTO = PayableDTO::fromOrder($order);

                  // Use factory instead of static call
                  $payment = $this->creditCardPaymentFactory->create(
                      $payableDTO,
                      $request->card_number
                  );

                  return $payment->withCard($cardDTO)->pay3d();
              }
          }
  -
    type: heading
    attrs:
      textAlign: left
      level: 2
    content:
      -
        type: text
        text: 'Step 3: Mock the Factory in Tests'
  -
    type: codeBlock
    attrs:
      language: null
    content:
      -
        type: text
        text: |-
          #[Test]
          public function it_pays_using_credit_card_with_3d(): void
          {
              // Arrange
              $order = Order::factory()->create();
              $redirectUrl = 'https://payment.example.com/3d';

              // Create mock for CreditCardPayment instance
              $mockCreditCardPayment = Mockery::mock();
              $mockCreditCardPayment->shouldReceive('withCard')
                  ->with(Mockery::on(static fn ($args) => $args->is($cardDTO)))
                  ->once()
                  ->andReturnSelf();
              $mockCreditCardPayment->shouldReceive('withTransactionType')
                  ->with(TransactionType::RETAILER_CASH)
                  ->once()
                  ->andReturnSelf();
              $mockCreditCardPayment->shouldReceive('pay3d')
                  ->once()
                  ->andReturn(redirect($redirectUrl));

              // Mock factory to return our mock instance
              $this->mock(CreditCardPaymentFactory::class, function (MockInterface $mock) use ($mockCreditCardPayment, $order): void {
                  $mock->shouldReceive('create')
                      ->with(
                          Mockery::on(function ($payable) use ($order): bool {
                              $this->assertEquals($order->cash_price, $payable->getPaymentAmount());
                              return true;
                          }),
                          '5555555555555555'
                      )
                      ->once()
                      ->andReturn($mockCreditCardPayment);
              });

              // Act
              $response = $this->postJson(route('orders.pay-3d', $order), $creditCardData);

              // Assert
              $response->assertRedirect($redirectUrl);
          }
  -
    type: horizontalRule
  -
    type: heading
    attrs:
      textAlign: left
      level: 1
    content:
      -
        type: text
        text: 'Option 2: Container Binding'
  -
    type: set
    attrs:
      id: option2_recommended
      values:
        type: sidenote
        content:
          -
            type: paragraph
            content:
              -
                type: text
                text: 'This is the approach we actually used. Lowest effort, no new classes, works immediately.'
        style: note
        position: right
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: "If you want to avoid creating factory classes, you can use Laravel's container binding directly. This requires the least amount of new code."
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        marks:
          -
            type: bold
        text: 'Pros:'
      -
        type: text
        text: ' No new classes, minimal code changes, quick to implement'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        marks:
          -
            type: bold
        text: 'Cons:'
      -
        type: text
        text: ' Changes call sites from '
      -
        type: text
        marks:
          -
            type: code
        text: 'Class::method()'
      -
        type: text
        text: ' to '
      -
        type: text
        marks:
          -
            type: code
        text: 'app(Class::class, [...])->method()'
  -
    type: set
    attrs:
      id: mjcjsib8
      values:
        type: sidenote
        content:
          -
            type: paragraph
            content:
              -
                type: text
                text: "Container binding only works if the production code resolves the class through Laravel's container ("
              -
                type: text
                marks:
                  -
                    type: code
                text: 'app(Class::class)'
              -
                type: text
                text: ' or constructor injection). Direct '
              -
                type: text
                marks:
                  -
                    type: code
                text: 'new Class()'
              -
                type: text
                text: " calls won't be intercepted."
        style: warning
        position: right
  -
    type: heading
    attrs:
      textAlign: left
      level: 2
    content:
      -
        type: text
        text: 'Step 1: Add Container Binding in ServiceProvider'
  -
    type: codeBlock
    attrs:
      language: null
    content:
      -
        type: text
        text: |-
          // app/Providers/AppServiceProvider.php
          public function register(): void
          {
              $this->app->bind(CreditCardPayment::class, static function ($app, array $params): CreditCardPayment {
                  return CreditCardPayment::create(
                      payable: $params['payable'],
                      cardNumber: $params['cardNumber'] ?? null,
                  );
              });
          }
  -
    type: heading
    attrs:
      textAlign: left
      level: 2
    content:
      -
        type: text
        text: 'Step 2: Replace Static Calls'
  -
    type: codeBlock
    attrs:
      language: null
    content:
      -
        type: text
        text: |-
          // Before:
          CreditCardPayment::create($payable, $cardNumber)->pay3d();

          // After:
          app(CreditCardPayment::class, ['payable' => $payable, 'cardNumber' => $cardNumber])->pay3d();
  -
    type: heading
    attrs:
      textAlign: left
      level: 2
    content:
      -
        type: text
        text: 'Step 3: Mock in Tests'
  -
    type: codeBlock
    attrs:
      language: null
    content:
      -
        type: text
        text: |-
          // Create a generic mock (works with readonly classes too)
          $mockPayment = Mockery::mock();
          $mockPayment->shouldReceive('pay3d')
              ->once()
              ->andReturn(redirect($url));

          // Bind mock to container
          $this->app->bind(CreditCardPayment::class, static fn () => $mockPayment);
  -
    type: horizontalRule
  -
    type: heading
    attrs:
      textAlign: left
      level: 1
    content:
      -
        type: text
        text: 'Option 3: Facade Pattern'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'What if you really love that static syntax? What if '
      -
        type: text
        marks:
          -
            type: code
        text: 'CreditCardPayment::create()'
      -
        type: text
        text: " feels like home and you don't want to leave?"
  -
    type: set
    attrs:
      id: facade_sidenote_1
      values:
        type: sidenote
        content:
          -
            type: paragraph
            content:
              -
                type: text
                text: "Laravel Facades are basically static method calls that secretly go through the container. It's like a magic trick where the rabbit was in the hat all along."
        style: note
        position: right
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: "Laravel Facades let you keep the static-looking syntax while routing everything through the container. The catch? You'll need to rename your existing class."
  -
    type: codeBlock
    attrs:
      language: null
    content:
      -
        type: text
        text: |-
          // Step 1: Rename the original class
          class CreditCardPaymentService  // was: CreditCardPayment
          {
              public function create(PayableDTO $payable): self
              {
                  return new self(
                      gateway: (new PaymentGatewayFactory())->create($payable)
                  );
              }
          }

          // Step 2: Create the Facade
          class CreditCardPayment extends Facade
          {
              protected static function getFacadeAccessor(): string
              {
                  return CreditCardPaymentService::class;
              }
          }
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        marks:
          -
            type: bold
        text: 'Usage stays the same:'
  -
    type: codeBlock
    attrs:
      language: null
    content:
      -
        type: text
        text: |-
          // Production code - unchanged!
          CreditCardPayment::create($payable)->withCard($card)->pay3d();

          // Test - now parallel-safe
          CreditCardPayment::shouldReceive('create')
              ->once()
              ->andReturn($mockPayment);
  -
    type: set
    attrs:
      id: facade_shouldreceive_sidenote
      values:
        type: sidenote
        content:
          -
            type: paragraph
            content:
              -
                type: text
                text: 'If you want that elegant ::shouldReceive() syntax, you need a Facade. There''s no shortcut. Regular PHP classes don''t have this magic—it comes from extending Illuminate\Support\Facades\Facade.'
        style: warning
        position: right
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'Notice the '
      -
        type: text
        marks:
          -
            type: code
        text: '::shouldReceive()'
      -
        type: text
        text: ' syntax in tests. This only works because '
      -
        type: text
        marks:
          -
            type: code
        text: CreditCardPayment
      -
        type: text
        text: " is now a Facade. Regular PHP classes don't have this method—it's provided by Laravel's Facade base class. If you try "
      -
        type: text
        marks:
          -
            type: code
        text: 'SomeRegularClass::shouldReceive()'
      -
        type: text
        text: ", you'll get a fatal error."
  -
    type: set
    attrs:
      id: facade_sidenote_2
      values:
        type: sidenote
        content:
          -
            type: paragraph
            content:
              -
                type: text
                text: "Is it worth renaming a class just to keep the same syntax? That's a philosophical question. I'll let you fight that battle with your IDE's refactoring tools."
        style: note
        position: right
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'The Facade approach gives you the best of both worlds: familiar static syntax and container-based testability. But it requires renaming your original class and setting up the Facade infrastructure.'
  -
    type: horizontalRule
  -
    type: heading
    attrs:
      textAlign: left
      level: 1
    content:
      -
        type: text
        text: 'What We Actually Did'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'So which path did we take? The fastest one. The least invasive one. The one that ships.'
  -
    type: set
    attrs:
      id: what_we_did_sidenote
      values:
        type: sidenote
        content:
          -
            type: paragraph
            content:
              -
                type: text
                text: 'Perfect is the enemy of shipped. We had a massive architectural migration to complete. Pretty code could wait.'
        style: note
        position: right
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'We were already knee-deep in a major architectural refactoring. Creating factory classes or setting up Facade infrastructure would have been scope creep.'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'So we went with '
      -
        type: text
        marks:
          -
            type: bold
        text: 'Option 2: Container Binding'
      -
        type: text
        text: '. It required the least amount of new code. We just needed to add a binding in the ServiceProvider and change static calls to container resolution.'
  -
    type: heading
    attrs:
      textAlign: left
      level: 2
    content:
      -
        type: text
        text: 'Step 1: Add Container Binding'
  -
    type: codeBlock
    attrs:
      language: null
    content:
      -
        type: text
        text: |-
          // app/Providers/AppServiceProvider.php
          $this->app->bind(CreditCardPayment::class, static function ($app, array $params): CreditCardPayment {
              return CreditCardPayment::create(
                  payable: $params['payable'],
                  cardNumber: $params['cardNumber'] ?? null,
                  platformType: $params['platformType'] ?? null
              );
          });
  -
    type: heading
    attrs:
      textAlign: left
      level: 2
    content:
      -
        type: text
        text: 'Step 2: Update Call Sites'
  -
    type: codeBlock
    attrs:
      language: null
    content:
      -
        type: text
        text: |-
          // Before: Static call, not mockable
          CreditCardPayment::create($payable, $cardNumber)->withCard($card)->pay3d();

          // After: Container resolution, mockable
          app(CreditCardPayment::class, ['payable' => $payable, 'cardNumber' => $cardNumber])
              ->withCard($card)
              ->pay3d();
  -
    type: heading
    attrs:
      textAlign: left
      level: 2
    content:
      -
        type: text
        text: 'Step 3: Update Tests'
  -
    type: codeBlock
    attrs:
      language: null
    content:
      -
        type: text
        text: |-
          // Before: Alias mock (not parallel-safe)
          Mockery::mock('alias:'.CreditCardPayment::class)
              ->shouldReceive('create')
              ->andReturnSelf()
              ->shouldReceive('withCard')
              ->andReturnSelf()
              ->shouldReceive('pay3d')
              ->andReturn(redirect($url));

          // After: Container binding (parallel-safe)
          $mockPayment = Mockery::mock();
          $mockPayment->shouldReceive('withCard')->once()->andReturnSelf();
          $mockPayment->shouldReceive('pay3d')->once()->andReturn(redirect($url));

          $this->app->bind(CreditCardPayment::class, static fn () => $mockPayment);
  -
    type: set
    attrs:
      id: container_binding_discovery
      values:
        type: sidenote
        content:
          -
            type: paragraph
            content:
              -
                type: text
                text: 'We discovered that CreditCardPayment::default() returns AbstractPaymentTableCalculator, not CreditCardPayment. This required a separate binding for that class too.'
        style: warning
        position: right
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: "And here's the thing about technical debt: we acknowledged it. We created a backlog item to migrate to the Facade pattern later. The elegant solution is waiting for a quieter sprint."
  -
    type: set
    attrs:
      id: backlog_sidenote
      values:
        type: sidenote
        content:
          -
            type: paragraph
            content:
              -
                type: text
                text: "Will we ever actually do that Facade migration? History suggests... maybe. But at least the tests don't flake anymore."
        style: note
        position: right
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        marks:
          -
            type: bold
        text: 'The takeaway:'
      -
        type: text
        text: " Sometimes the right solution isn't the perfect one. It's the one that unblocks your team today while leaving the door open for improvements tomorrow."
  -
    type: horizontalRule
  -
    type: heading
    attrs:
      textAlign: left
      level: 1
    content:
      -
        type: text
        text: 'Mocking Variations'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'Different mock setups for different scenarios with container binding:'
  -
    type: heading
    attrs:
      textAlign: left
      level: 2
    content:
      -
        type: text
        text: 'Payment Table (Single Method After Create)'
  -
    type: codeBlock
    attrs:
      language: null
    content:
      -
        type: text
        text: |-
          $mockPayment = Mockery::mock();
          $mockPayment->shouldReceive('getPaymentTable')
              ->once()
              ->andReturn(new PaymentTableDTO([...]));

          $this->app->bind(CreditCardPayment::class, static fn () => $mockPayment);
  -
    type: heading
    attrs:
      textAlign: left
      level: 2
    content:
      -
        type: text
        text: 'Chained Method Calls'
  -
    type: codeBlock
    attrs:
      language: null
    content:
      -
        type: text
        text: |-
          $mockPayment = Mockery::mock();
          $mockPayment->shouldReceive('withCard')
              ->with(Mockery::on(fn ($card) => $card->number === '5555555555555555'))
              ->once()
              ->andReturnSelf();
          $mockPayment->shouldReceive('withTransactionType')
              ->with(TransactionType::RETAILER_CASH)
              ->once()
              ->andReturnSelf();
          $mockPayment->shouldReceive('pay3d')
              ->once()
              ->andReturn(redirect($redirectUrl));

          $this->app->bind(CreditCardPayment::class, static fn () => $mockPayment);
  -
    type: heading
    attrs:
      textAlign: left
      level: 2
    content:
      -
        type: text
        text: 'Exception Testing'
  -
    type: codeBlock
    attrs:
      language: null
    content:
      -
        type: text
        text: |-
          $mockPayment = Mockery::mock();
          $mockPayment->shouldReceive('withCard')->once()->andReturnSelf();
          $mockPayment->shouldReceive('pay3d')
              ->once()
              ->andThrow(new MokaPaymentAmountException('Payment failed'));

          $this->app->bind(CreditCardPayment::class, static fn () => $mockPayment);

          $response = $this->postJson(route('orders.pay-3d', $order), $creditCardData);
          $response->assertUnprocessableEntity();
  -
    type: heading
    attrs:
      textAlign: left
      level: 2
    content:
      -
        type: text
        text: 'Never-Called Assertions'
  -
    type: codeBlock
    attrs:
      language: null
    content:
      -
        type: text
        text: |-
          // Verify payment is never attempted when validation fails
          $mockPayment = Mockery::mock();
          $mockPayment->shouldReceive('withCard')->never();
          $mockPayment->shouldReceive('pay3d')->never();

          $this->app->bind(CreditCardPayment::class, static fn () => $mockPayment);

          $response = $this->postJson(route('orders.pay-3d', $ineligibleOrder), $creditCardData);
          $response->assertUnprocessableEntity();
  -
    type: horizontalRule
  -
    type: heading
    attrs:
      textAlign: left
      level: 1
    content:
      -
        type: text
        text: 'Handling Readonly Classes'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'PHP 8.2+ readonly classes pose a special challenge for Mockery.'
  -
    type: codeBlock
    attrs:
      language: null
    content:
      -
        type: text
        text: |-
          // This fails if CreditCardPayment is readonly
          $mock = Mockery::mock(CreditCardPayment::class); // Error!
  -
    type: heading
    attrs:
      textAlign: left
      level: 3
    content:
      -
        type: text
        text: 'Solution 1: Untyped Mocks'
  -
    type: codeBlock
    attrs:
      language: null
    content:
      -
        type: text
        text: |-
          // Don't specify class - create generic mock
          $mockCreditCardPayment = Mockery::mock(); // Works!
          $mockCreditCardPayment->shouldReceive('pay3d')->andReturn(...);
  -
    type: heading
    attrs:
      textAlign: left
      level: 3
    content:
      -
        type: text
        text: 'Solution 2: Remove Return Types from Factory'
  -
    type: set
    attrs:
      id: mjck3d3e
      values:
        type: sidenote
        content:
          -
            type: paragraph
            content:
              -
                type: text
                text: 'You can document the return type with PHPDoc. IDEs and static analyzers can read PHPDoc. No runtime type enforcement, but Mockery works.'
        style: note
        position: right
  -
    type: paragraph
    attrs:
      textAlign: left
  -
    type: codeBlock
    attrs:
      language: null
    content:
      -
        type: text
        text: |-
          class CreditCardPaymentFactory
          {
              /**
               * Return type omitted for Mockery readonly class compatibility.
               *
               * @return CreditCardPayment
               */
              public function create(PayableDTO $payable) // No return type!
              {
                  return CreditCardPayment::create($payable);
              }
          }
  -
    type: horizontalRule
  -
    type: heading
    attrs:
      textAlign: left
      level: 1
    content:
      -
        type: text
        text: 'The Migration Checklist'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'When migrating from alias or overload mocks to container binding:'
  -
    type: orderedList
    attrs:
      start: 1
    content:
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                text: 'Add container binding in ServiceProvider for the class'
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                text: 'Replace static calls ('
              -
                type: text
                marks:
                  -
                    type: code
                text: 'Class::create()'
              -
                type: text
                text: ') with container resolution ('
              -
                type: text
                marks:
                  -
                    type: code
                text: 'app(Class::class, [...])'
              -
                type: text
                text: )
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                text: 'Update tests - use '
              -
                type: text
                marks:
                  -
                    type: code
                text: $this->app->bind()
              -
                type: text
                text: ' instead of alias mock'
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                text: 'If readonly class, use '
              -
                type: text
                marks:
                  -
                    type: code
                text: 'Mockery::mock()'
              -
                type: text
                text: ' without class parameter'
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                text: 'Check if static method returns a different class (like '
              -
                type: text
                marks:
                  -
                    type: code
                text: '::default()'
              -
                type: text
                text: ') and add separate binding'
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                text: 'Run tests to verify refactoring'
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                text: 'Search for '
              -
                type: text
                marks:
                  -
                    type: code
                text: "Mockery::mock('alias:"
              -
                type: text
                text: ' and '
              -
                type: text
                marks:
                  -
                    type: code
                text: "Mockery::mock('overload:"
              -
                type: text
                text: ' and repeat'
  -
    type: heading
    attrs:
      textAlign: left
      level: 2
    content:
      -
        type: text
        text: 'Real-World Impact'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'Results of our refactoring:'
  -
    type: table
    content:
      -
        type: tableRow
        content:
          -
            type: tableHeader
            attrs:
              colspan: 1
              rowspan: 1
              colwidth: null
            content:
              -
                type: paragraph
                attrs:
                  textAlign: left
                content:
                  -
                    type: text
                    marks:
                      -
                        type: bold
                    text: 'Test File'
          -
            type: tableHeader
            attrs:
              colspan: 1
              rowspan: 1
              colwidth: null
            content:
              -
                type: paragraph
                attrs:
                  textAlign: left
                content:
                  -
                    type: text
                    marks:
                      -
                        type: bold
                    text: 'Mocks Removed'
      -
        type: tableRow
        content:
          -
            type: tableCell
            attrs:
              colspan: 1
              rowspan: 1
              colwidth: null
            content:
              -
                type: paragraph
                attrs:
                  textAlign: left
                content:
                  -
                    type: text
                    text: Retailer/OrderPayWithCreditCardControllerTest
          -
            type: tableCell
            attrs:
              colspan: 1
              rowspan: 1
              colwidth: null
            content:
              -
                type: paragraph
                attrs:
                  textAlign: left
                content:
                  -
                    type: text
                    text: '8'
      -
        type: tableRow
        content:
          -
            type: tableCell
            attrs:
              colspan: 1
              rowspan: 1
              colwidth: null
            content:
              -
                type: paragraph
                attrs:
                  textAlign: left
                content:
                  -
                    type: text
                    text: Retailer/PriceCalculatorMachineControllerTest
          -
            type: tableCell
            attrs:
              colspan: 1
              rowspan: 1
              colwidth: null
            content:
              -
                type: paragraph
                attrs:
                  textAlign: left
                content:
                  -
                    type: text
                    text: '9'
      -
        type: tableRow
        content:
          -
            type: tableCell
            attrs:
              colspan: 1
              rowspan: 1
              colwidth: null
            content:
              -
                type: paragraph
                attrs:
                  textAlign: left
                content:
                  -
                    type: text
                    text: Retailer/ApplicationMachineControllerTest
          -
            type: tableCell
            attrs:
              colspan: 1
              rowspan: 1
              colwidth: null
            content:
              -
                type: paragraph
                attrs:
                  textAlign: left
                content:
                  -
                    type: text
                    text: '11'
      -
        type: tableRow
        content:
          -
            type: tableCell
            attrs:
              colspan: 1
              rowspan: 1
              colwidth: null
            content:
              -
                type: paragraph
                attrs:
                  textAlign: left
                content:
                  -
                    type: text
                    text: Mobile/OrderPayWithCreditCardControllerTest
          -
            type: tableCell
            attrs:
              colspan: 1
              rowspan: 1
              colwidth: null
            content:
              -
                type: paragraph
                attrs:
                  textAlign: left
                content:
                  -
                    type: text
                    text: '8'
      -
        type: tableRow
        content:
          -
            type: tableCell
            attrs:
              colspan: 1
              rowspan: 1
              colwidth: null
            content:
              -
                type: paragraph
                attrs:
                  textAlign: left
                content:
                  -
                    type: text
                    text: General/OrderPayWithCreditCardControllerTest
          -
            type: tableCell
            attrs:
              colspan: 1
              rowspan: 1
              colwidth: null
            content:
              -
                type: paragraph
                attrs:
                  textAlign: left
                content:
                  -
                    type: text
                    text: '7'
      -
        type: tableRow
        content:
          -
            type: tableCell
            attrs:
              colspan: 1
              rowspan: 1
              colwidth: null
            content:
              -
                type: paragraph
                attrs:
                  textAlign: left
                content:
                  -
                    type: text
                    text: ZiraatPaymentProviderTest
          -
            type: tableCell
            attrs:
              colspan: 1
              rowspan: 1
              colwidth: null
            content:
              -
                type: paragraph
                attrs:
                  textAlign: left
                content:
                  -
                    type: text
                    text: '5'
      -
        type: tableRow
        content:
          -
            type: tableCell
            attrs:
              colspan: 1
              rowspan: 1
              colwidth: null
            content:
              -
                type: paragraph
                attrs:
                  textAlign: left
                content:
                  -
                    type: text
                    text: ZiraatPaymentTableCalculatorTest
          -
            type: tableCell
            attrs:
              colspan: 1
              rowspan: 1
              colwidth: null
            content:
              -
                type: paragraph
                attrs:
                  textAlign: left
                content:
                  -
                    type: text
                    text: '1'
      -
        type: tableRow
        content:
          -
            type: tableCell
            attrs:
              colspan: 1
              rowspan: 1
              colwidth: null
            content:
              -
                type: paragraph
                attrs:
                  textAlign: left
                content:
                  -
                    type: text
                    text: IPSPriceCalculationJobTest
          -
            type: tableCell
            attrs:
              colspan: 1
              rowspan: 1
              colwidth: null
            content:
              -
                type: paragraph
                attrs:
                  textAlign: left
                content:
                  -
                    type: text
                    text: '1'
      -
        type: tableRow
        content:
          -
            type: tableCell
            attrs:
              colspan: 1
              rowspan: 1
              colwidth: null
            content:
              -
                type: paragraph
                attrs:
                  textAlign: left
                content:
                  -
                    type: text
                    text: PaymentGatewayExceptionHandlerTest
          -
            type: tableCell
            attrs:
              colspan: 1
              rowspan: 1
              colwidth: null
            content:
              -
                type: paragraph
                attrs:
                  textAlign: left
                content:
                  -
                    type: text
                    text: '3'
      -
        type: tableRow
        content:
          -
            type: tableCell
            attrs:
              colspan: 1
              rowspan: 1
              colwidth: null
            content:
              -
                type: paragraph
                attrs:
                  textAlign: left
                content:
                  -
                    type: text
                    marks:
                      -
                        type: bold
                    text: Total
          -
            type: tableCell
            attrs:
              colspan: 1
              rowspan: 1
              colwidth: null
            content:
              -
                type: paragraph
                attrs:
                  textAlign: left
                content:
                  -
                    type: text
                    marks:
                      -
                        type: bold
                    text: '53'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        marks:
          -
            type: bold
        text: 'Result:'
      -
        type: text
        text: ' All affected tests now run in parallel, no conflicts.'
  -
    type: horizontalRule
  -
    type: set
    attrs:
      id: mjcll3r3
      values:
        type: sidenote
        content:
          -
            type: paragraph
            content:
              -
                type: text
                text: '(The Foundation)'
        style: note
        position: right
  -
    type: heading
    attrs:
      textAlign: left
      level: 1
    content:
      -
        type: text
        text: 'Mockery Best Practices'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'Beyond alias mocks, here are the fundamental rules of Mockery usage:'
  -
    type: heading
    attrs:
      textAlign: left
      level: 2
    content:
      -
        type: text
        text: '1. MockeryPHPUnitIntegration Trait'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'Add this trait to your base TestCase:'
  -
    type: codeBlock
    attrs:
      language: null
    content:
      -
        type: text
        text: |-
          <?php

          namespace Tests;

          use Mockery\Adapter\Phpunit\MockeryPHPUnitIntegration;
          use Illuminate\Foundation\Testing\TestCase as BaseTestCase;

          abstract class TestCase extends BaseTestCase
          {
              use MockeryPHPUnitIntegration;

              // ...
          }
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        marks:
          -
            type: bold
        text: 'Why it matters:'
  -
    type: bulletList
    content:
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                text: 'Mockery expectations are verified at end of each test'
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                text: 'Mock assertion counts integrate with PHPUnit'
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                text: 'Mockery closes properly after each test'
  -
    type: heading
    attrs:
      textAlign: left
      level: 2
    content:
      -
        type: text
        text: '2. Always Add Call Count Expectations'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'No call count on mock = no assertion = risky test.'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        marks:
          -
            type: bold
        text: 'Wrong (Risky Test):'
  -
    type: codeBlock
    attrs:
      language: null
    content:
      -
        type: text
        text: |-
          BankCollection::shouldReceive('updatePaymentStatusInfoWithPaymentExpCode')
              ->with($paymentId, $expCode, PaymentStatusType::MATCHED);
          // No call count = no assertion = PHPUnit warning
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        marks:
          -
            type: bold
        text: 'Correct:'
  -
    type: codeBlock
    attrs:
      language: null
    content:
      -
        type: text
        text: |-
          BankCollection::shouldReceive('updatePaymentStatusInfoWithPaymentExpCode')
              ->once()  // This is an assertion
              ->with($paymentId, $expCode, PaymentStatusType::MATCHED);
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        marks:
          -
            type: bold
        text: 'Call Count Methods:'
  -
    type: table
    content:
      -
        type: tableRow
        content:
          -
            type: tableHeader
            attrs:
              colspan: 1
              rowspan: 1
              colwidth: null
            content:
              -
                type: paragraph
                attrs:
                  textAlign: left
                content:
                  -
                    type: text
                    marks:
                      -
                        type: bold
                    text: Method
          -
            type: tableHeader
            attrs:
              colspan: 1
              rowspan: 1
              colwidth: null
            content:
              -
                type: paragraph
                attrs:
                  textAlign: left
                content:
                  -
                    type: text
                    marks:
                      -
                        type: bold
                    text: Usage
      -
        type: tableRow
        content:
          -
            type: tableCell
            attrs:
              colspan: 1
              rowspan: 1
              colwidth: null
            content:
              -
                type: paragraph
                attrs:
                  textAlign: left
                content:
                  -
                    type: text
                    marks:
                      -
                        type: code
                    text: '->once()'
          -
            type: tableCell
            attrs:
              colspan: 1
              rowspan: 1
              colwidth: null
            content:
              -
                type: paragraph
                attrs:
                  textAlign: left
                content:
                  -
                    type: text
                    text: 'Must be called exactly 1 time'
      -
        type: tableRow
        content:
          -
            type: tableCell
            attrs:
              colspan: 1
              rowspan: 1
              colwidth: null
            content:
              -
                type: paragraph
                attrs:
                  textAlign: left
                content:
                  -
                    type: text
                    marks:
                      -
                        type: code
                    text: '->twice()'
          -
            type: tableCell
            attrs:
              colspan: 1
              rowspan: 1
              colwidth: null
            content:
              -
                type: paragraph
                attrs:
                  textAlign: left
                content:
                  -
                    type: text
                    text: 'Must be called exactly 2 times'
      -
        type: tableRow
        content:
          -
            type: tableCell
            attrs:
              colspan: 1
              rowspan: 1
              colwidth: null
            content:
              -
                type: paragraph
                attrs:
                  textAlign: left
                content:
                  -
                    type: text
                    marks:
                      -
                        type: code
                    text: '->times(n)'
          -
            type: tableCell
            attrs:
              colspan: 1
              rowspan: 1
              colwidth: null
            content:
              -
                type: paragraph
                attrs:
                  textAlign: left
                content:
                  -
                    type: text
                    text: 'Must be called exactly n times'
      -
        type: tableRow
        content:
          -
            type: tableCell
            attrs:
              colspan: 1
              rowspan: 1
              colwidth: null
            content:
              -
                type: paragraph
                attrs:
                  textAlign: left
                content:
                  -
                    type: text
                    marks:
                      -
                        type: code
                    text: '->atLeast()->times(n)'
          -
            type: tableCell
            attrs:
              colspan: 1
              rowspan: 1
              colwidth: null
            content:
              -
                type: paragraph
                attrs:
                  textAlign: left
                content:
                  -
                    type: text
                    text: 'Must be called at least n times'
      -
        type: tableRow
        content:
          -
            type: tableCell
            attrs:
              colspan: 1
              rowspan: 1
              colwidth: null
            content:
              -
                type: paragraph
                attrs:
                  textAlign: left
                content:
                  -
                    type: text
                    marks:
                      -
                        type: code
                    text: '->atMost()->times(n)'
          -
            type: tableCell
            attrs:
              colspan: 1
              rowspan: 1
              colwidth: null
            content:
              -
                type: paragraph
                attrs:
                  textAlign: left
                content:
                  -
                    type: text
                    text: 'Must be called at most n times'
      -
        type: tableRow
        content:
          -
            type: tableCell
            attrs:
              colspan: 1
              rowspan: 1
              colwidth: null
            content:
              -
                type: paragraph
                attrs:
                  textAlign: left
                content:
                  -
                    type: text
                    marks:
                      -
                        type: code
                    text: '->never()'
          -
            type: tableCell
            attrs:
              colspan: 1
              rowspan: 1
              colwidth: null
            content:
              -
                type: paragraph
                attrs:
                  textAlign: left
                content:
                  -
                    type: text
                    text: 'Must never be called'
  -
    type: heading
    attrs:
      textAlign: left
      level: 2
    content:
      -
        type: text
        text: '3. partialMock() vs shouldReceive()'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'Using '
      -
        type: text
        marks:
          -
            type: code
        text: shouldReceive()
      -
        type: text
        text: ' directly on facades is dangerous.'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        marks:
          -
            type: bold
        text: 'Wrong (Can corrupt application container):'
  -
    type: codeBlock
    attrs:
      language: null
    content:
      -
        type: text
        text: |-
          LaravelConfig::shouldReceive('get')
              ->with('some.config.key')
              ->once()
              ->andReturn(true);
  -
    type: set
    attrs:
      id: mjckzhns
      values:
        type: sidenote
        content:
          -
            type: paragraph
            content:
              -
                type: text
                text: 'This change affected 37+ test files. A big refactoring but worth it.'
        style: note
        position: right
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        marks:
          -
            type: bold
        text: 'Correct:'
  -
    type: codeBlock
    attrs:
      language: null
    content:
      -
        type: text
        text: |-
          LaravelConfig::partialMock()
              ->shouldReceive('get')
              ->with('some.config.key')
              ->once()
              ->andReturn(true);
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        marks:
          -
            type: bold
        text: 'Why partialMock() is better:'
  -
    type: bulletList
    content:
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                text: 'Only mocks specified methods'
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                text: 'Rest of facade remains functional'
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                text: "Doesn't interfere with application container"
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                text: 'Prevents Sushi model caching issues'
  -
    type: heading
    attrs:
      textAlign: left
      level: 2
    content:
      -
        type: text
        text: 'The Facade vs Class Naming Trap'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: "There's another subtle mock failure mode: when a facade and its underlying class share the same name."
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'We had a package with this structure:'
  -
    type: codeBlock
    attrs:
      language: null
    content:
      -
        type: text
        text: |-
          TarfinLabs\LaravelConfig\LaravelConfig          // The class
          TarfinLabs\LaravelConfig\Facades\LaravelConfig  // The facade
  -
    type: set
    attrs:
      id: mjhgmjyg
      values:
        type: sidenote
        content:
          -
            type: paragraph
            content:
              -
                type: text
                marks:
                  -
                    type: link
                    attrs:
                      href: 'https://github.com/tarfin-labs/laravel-config'
                      rel: null
                      target: _blank
                      title: null
                text: 'Laravel Config'
              -
                type: text
                text: ' is an open source package we maintain and use in production. It provides key-value config management for Laravel.'
        style: note
        position: right
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'See the problem? When you type '
      -
        type: text
        marks:
          -
            type: code
        text: LaravelConfig
      -
        type: text
        text: " in your IDE, autocomplete shows both. It's easy to pick the wrong one."
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        marks:
          -
            type: bold
        text: 'Wrong (mocking the class directly):'
  -
    type: codeBlock
    attrs:
      language: null
    content:
      -
        type: text
        text: |-
          // BAD: Importing the class, not the facade
          use TarfinLabs\LaravelConfig\LaravelConfig;

          $this->mock(LaravelConfig::class)
              ->shouldReceive('get')
              ->once()
              ->andReturn('value');

          // Mock is set up... but facade calls bypass it entirely!
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: "The mock doesn't intercept anything because production code uses the "
      -
        type: text
        marks:
          -
            type: italic
        text: facade
      -
        type: text
        text: ', not the class directly.'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        marks:
          -
            type: bold
        text: 'Correct:'
  -
    type: codeBlock
    attrs:
      language: null
    content:
      -
        type: text
        text: |-
          // GOOD: Using the facade
          use TarfinLabs\LaravelConfig\Facades\LaravelConfig;

          LaravelConfig::partialMock()
              ->shouldReceive('get')
              ->once()
              ->andReturn('value');
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        marks:
          -
            type: bold
        text: 'The fix:'
      -
        type: text
        text: ' We renamed the class to '
      -
        type: text
        marks:
          -
            type: code
        text: ConfigManager
      -
        type: text
        text: ' in v6:'
  -
    type: codeBlock
    attrs:
      language: null
    content:
      -
        type: text
        text: |-
          TarfinLabs\LaravelConfig\ConfigManager          // The class (renamed)
          TarfinLabs\LaravelConfig\Facades\LaravelConfig  // The facade
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'Now when you type '
      -
        type: text
        marks:
          -
            type: code
        text: LaravelConfig
      -
        type: text
        text: ', only the facade appears. Problem solved at the source.'
  -
    type: heading
    attrs:
      textAlign: left
      level: 2
    content:
      -
        type: text
        text: '4. Conditional Mocking for DataProviders'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'When using '
      -
        type: text
        marks:
          -
            type: code
        text: DataProviders
      -
        type: text
        text: ', not every test case runs the same code path.'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        marks:
          -
            type: bold
        text: 'Wrong (Some datasets fail):'
  -
    type: codeBlock
    attrs:
      language: null
    content:
      -
        type: text
        text: |
          #[DataProvider('applicationStatuses')]
          #[Test]
          public function suspend_previous_applications(ApplicationStatus $status): void
          {
              // Mock setup happens every time
              BankMock::cancelApplication(true);

              // But some statuses don't call Fiba::cancelApplication()!
              // InvalidCountException: Expected 1 call, received 0
          }
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        marks:
          -
            type: bold
        text: 'Correct:'
  -
    type: codeBlock
    attrs:
      language: null
    content:
      -
        type: text
        text: |
          #[DataProvider('applicationStatuses')]
          #[Test]
          public function test_suspend_previous_applications(ApplicationStatus $status): void
          {
              $statusesThatTriggerCancellation = [
                  ApplicationStatus::BANK_DECISION_WAITING,
                  ApplicationStatus::BANK_PIN_WAITING,
              ];

              // Only mock if code path will be taken
              if (in_array($status, $statusesThatTriggerCancellation, true)) {
                  BankMock::cancelApplication(true);
              }

              // Test logic...
          }
  -
    type: heading
    attrs:
      textAlign: left
      level: 2
    content:
      -
        type: text
        text: "5. Don't Mock Unreachable Code"
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'When using '
      -
        type: text
        marks:
          -
            type: code
        text: 'Bus::fake()'
      -
        type: text
        text: ' or '
      -
        type: text
        marks:
          -
            type: code
        text: 'Queue::fake()'
      -
        type: text
        text: ", job internals don't execute."
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        marks:
          -
            type: bold
        text: 'Wrong:'
  -
    type: codeBlock
    attrs:
      language: null
    content:
      -
        type: text
        text: |-
          Bus::fake();  // Jobs won't execute

          BankMock::storeApplicant(true, [  // This will fail!
              'resultState' => StoreApplicantResultType::TH->name,
          ]);

          StoreApplicantJob::dispatch($application);

          Bus::assertDispatched(StoreApplicantJob::class);
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        marks:
          -
            type: bold
        text: 'Correct:'
  -
    type: codeBlock
    attrs:
      language: null
    content:
      -
        type: text
        text: |
          Bus::fake();

          // BankMock not needed - job doesn't execute

          StoreApplicantJob::dispatch($application);

          Bus::assertDispatched(StoreApplicantJob::class);
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        marks:
          -
            type: bold
        text: 'Scenarios where mock is unnecessary:'
  -
    type: bulletList
    content:
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                marks:
                  -
                    type: code
                text: 'Bus::fake()'
              -
                type: text
                text: " - queued jobs don't execute"
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                marks:
                  -
                    type: code
                text: 'Queue::fake()'
              -
                type: text
                text: " - queued jobs don't execute"
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                text: "Early return - subsequent code doesn't run"
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                text: "Exception throw - code after exception doesn't run"
  -
    type: horizontalRule
  -
    type: heading
    attrs:
      textAlign: left
      level: 1
    content:
      -
        type: text
        marks:
          -
            type: bold
        text: 'PHPUnit Mock vs Stub'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'PHPUnit 10+ separates mock and stub. In PHPUnit 12, a mock without expectations generates a warning.'
  -
    type: table
    content:
      -
        type: tableRow
        content:
          -
            type: tableHeader
            attrs:
              colspan: 1
              rowspan: 1
              colwidth: null
            content:
              -
                type: paragraph
                attrs:
                  textAlign: left
                content:
                  -
                    type: text
                    marks:
                      -
                        type: bold
                    text: Type
          -
            type: tableHeader
            attrs:
              colspan: 1
              rowspan: 1
              colwidth: null
            content:
              -
                type: paragraph
                attrs:
                  textAlign: left
                content:
                  -
                    type: text
                    marks:
                      -
                        type: bold
                    text: Purpose
          -
            type: tableHeader
            attrs:
              colspan: 1
              rowspan: 1
              colwidth: null
            content:
              -
                type: paragraph
                attrs:
                  textAlign: left
                content:
                  -
                    type: text
                    marks:
                      -
                        type: bold
                    text: Method
      -
        type: tableRow
        content:
          -
            type: tableCell
            attrs:
              colspan: 1
              rowspan: 1
              colwidth: null
            content:
              -
                type: paragraph
                attrs:
                  textAlign: left
                content:
                  -
                    type: text
                    marks:
                      -
                        type: bold
                    text: Mock
          -
            type: tableCell
            attrs:
              colspan: 1
              rowspan: 1
              colwidth: null
            content:
              -
                type: paragraph
                attrs:
                  textAlign: left
                content:
                  -
                    type: text
                    text: 'Verify calls/arguments'
          -
            type: tableCell
            attrs:
              colspan: 1
              rowspan: 1
              colwidth: null
            content:
              -
                type: paragraph
                attrs:
                  textAlign: left
                content:
                  -
                    type: text
                    marks:
                      -
                        type: code
                    text: createMock()
                  -
                    type: text
                    text: ' + '
                  -
                    type: text
                    marks:
                      -
                        type: code
                    text: expects()
      -
        type: tableRow
        content:
          -
            type: tableCell
            attrs:
              colspan: 1
              rowspan: 1
              colwidth: null
            content:
              -
                type: paragraph
                attrs:
                  textAlign: left
                content:
                  -
                    type: text
                    marks:
                      -
                        type: bold
                    text: Stub
          -
            type: tableCell
            attrs:
              colspan: 1
              rowspan: 1
              colwidth: null
            content:
              -
                type: paragraph
                attrs:
                  textAlign: left
                content:
                  -
                    type: text
                    text: 'Placeholder/return value'
          -
            type: tableCell
            attrs:
              colspan: 1
              rowspan: 1
              colwidth: null
            content:
              -
                type: paragraph
                attrs:
                  textAlign: left
                content:
                  -
                    type: text
                    marks:
                      -
                        type: code
                    text: createStub()
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        marks:
          -
            type: bold
        text: 'Rules:'
  -
    type: orderedList
    attrs:
      start: 1
    content:
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                text: 'If you only need a placeholder, use '
              -
                type: text
                marks:
                  -
                    type: code
                text: createStub()
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                text: 'If you need to verify calls, use '
              -
                type: text
                marks:
                  -
                    type: code
                text: createMock()
              -
                type: text
                text: ' + '
              -
                type: text
                marks:
                  -
                    type: code
                text: expects($this->once())
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                text: 'With '
              -
                type: text
                marks:
                  -
                    type: code
                text: getMockBuilder()->onlyMethods(...)
              -
                type: text
                text: ', stub every listed method'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        marks:
          -
            type: bold
        text: 'Examples:'
  -
    type: codeBlock
    attrs:
      language: null
    content:
      -
        type: text
        text: |
          // Stub - no verification
          $property = $this->createStub(DataProperty::class);
          $context = $this->createStub(CreationContext::class);
          $result = $cast->cast($property, 'value', [], $context);
          $this->assertEquals('expected', $result);

          // Mock - with verification
          $logger = $this->createMock(Logger::class);
          $logger->expects($this->once())->method('log')->with('error');
          $service->doSomething();
  -
    type: heading
    attrs:
      textAlign: left
      level: 1
    content:
      -
        type: text
        marks:
          -
            type: bold
        text: 'Concrete Test Stubs'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'If you only need to provide return values, creating a concrete test stub class avoids PHPUnit warnings:'
  -
    type: codeBlock
    attrs:
      language: null
    content:
      -
        type: text
        text: |
          final class StubQueryBuilder extends BaseQueryBuilder
          {
              public function __construct(private readonly array $filters = [])
              {
                  $this->model = StubModel::class;
              }

              public function allowedFilters(): array { return $this->filters; }
              public function allowedIncludes(): array { return []; }
              public function allowedFields(): array { return []; }
              public function allowedAppends(): array { return []; }
              public function allowedSorts(): array { return []; }
          }
  -
    type: horizontalRule
  -
    type: heading
    attrs:
      textAlign: left
      level: 1
    content:
      -
        type: text
        marks:
          -
            type: bold
        text: 'Laravel/Mockery vs PHPUnit Mocking'
  -
    type: table
    content:
      -
        type: tableRow
        content:
          -
            type: tableHeader
            attrs:
              colspan: 1
              rowspan: 1
              colwidth: null
            content:
              -
                type: paragraph
                attrs:
                  textAlign: left
                content:
                  -
                    type: text
                    marks:
                      -
                        type: bold
                    text: Tool
          -
            type: tableHeader
            attrs:
              colspan: 1
              rowspan: 1
              colwidth: null
            content:
              -
                type: paragraph
                attrs:
                  textAlign: left
                content:
                  -
                    type: text
                    marks:
                      -
                        type: bold
                    text: Stub
          -
            type: tableHeader
            attrs:
              colspan: 1
              rowspan: 1
              colwidth: null
            content:
              -
                type: paragraph
                attrs:
                  textAlign: left
                content:
                  -
                    type: text
                    marks:
                      -
                        type: bold
                    text: Mock
          -
            type: tableHeader
            attrs:
              colspan: 1
              rowspan: 1
              colwidth: null
            content:
              -
                type: paragraph
                attrs:
                  textAlign: left
                content:
                  -
                    type: text
                    marks:
                      -
                        type: bold
                    text: 'PHPUnit 10+ notice?'
      -
        type: tableRow
        content:
          -
            type: tableCell
            attrs:
              colspan: 1
              rowspan: 1
              colwidth: null
            content:
              -
                type: paragraph
                attrs:
                  textAlign: left
                content:
                  -
                    type: text
                    text: PHPUnit
          -
            type: tableCell
            attrs:
              colspan: 1
              rowspan: 1
              colwidth: null
            content:
              -
                type: paragraph
                attrs:
                  textAlign: left
                content:
                  -
                    type: text
                    marks:
                      -
                        type: code
                    text: createStub()
          -
            type: tableCell
            attrs:
              colspan: 1
              rowspan: 1
              colwidth: null
            content:
              -
                type: paragraph
                attrs:
                  textAlign: left
                content:
                  -
                    type: text
                    marks:
                      -
                        type: code
                    text: createMock()
                  -
                    type: text
                    text: ' + '
                  -
                    type: text
                    marks:
                      -
                        type: code
                    text: expects()
          -
            type: tableCell
            attrs:
              colspan: 1
              rowspan: 1
              colwidth: null
            content:
              -
                type: paragraph
                attrs:
                  textAlign: left
                content:
                  -
                    type: text
                    text: 'Yes (if no expectations)'
      -
        type: tableRow
        content:
          -
            type: tableCell
            attrs:
              colspan: 1
              rowspan: 1
              colwidth: null
            content:
              -
                type: paragraph
                attrs:
                  textAlign: left
                content:
                  -
                    type: text
                    text: Mockery
          -
            type: tableCell
            attrs:
              colspan: 1
              rowspan: 1
              colwidth: null
            content:
              -
                type: paragraph
                attrs:
                  textAlign: left
                content:
                  -
                    type: text
                    marks:
                      -
                        type: code
                    text: spy()
          -
            type: tableCell
            attrs:
              colspan: 1
              rowspan: 1
              colwidth: null
            content:
              -
                type: paragraph
                attrs:
                  textAlign: left
                content:
                  -
                    type: text
                    marks:
                      -
                        type: code
                    text: shouldReceive()->once()
          -
            type: tableCell
            attrs:
              colspan: 1
              rowspan: 1
              colwidth: null
            content:
              -
                type: paragraph
                attrs:
                  textAlign: left
                content:
                  -
                    type: text
                    text: 'No'
      -
        type: tableRow
        content:
          -
            type: tableCell
            attrs:
              colspan: 1
              rowspan: 1
              colwidth: null
            content:
              -
                type: paragraph
                attrs:
                  textAlign: left
                content:
                  -
                    type: text
                    text: 'Laravel facade'
          -
            type: tableCell
            attrs:
              colspan: 1
              rowspan: 1
              colwidth: null
            content:
              -
                type: paragraph
                attrs:
                  textAlign: left
                content:
                  -
                    type: text
                    marks:
                      -
                        type: code
                    text: 'Facade::fake()'
          -
            type: tableCell
            attrs:
              colspan: 1
              rowspan: 1
              colwidth: null
            content:
              -
                type: paragraph
                attrs:
                  textAlign: left
                content:
                  -
                    type: text
                    marks:
                      -
                        type: code
                    text: shouldReceive()->once()
          -
            type: tableCell
            attrs:
              colspan: 1
              rowspan: 1
              colwidth: null
            content:
              -
                type: paragraph
                attrs:
                  textAlign: left
                content:
                  -
                    type: text
                    text: 'No'
      -
        type: tableRow
        content:
          -
            type: tableCell
            attrs:
              colspan: 1
              rowspan: 1
              colwidth: null
            content:
              -
                type: paragraph
                attrs:
                  textAlign: left
                content:
                  -
                    type: text
                    text: 'Laravel helper'
          -
            type: tableCell
            attrs:
              colspan: 1
              rowspan: 1
              colwidth: null
            content:
              -
                type: paragraph
                attrs:
                  textAlign: left
                content:
                  -
                    type: text
                    marks:
                      -
                        type: code
                    text: $this->spy()
          -
            type: tableCell
            attrs:
              colspan: 1
              rowspan: 1
              colwidth: null
            content:
              -
                type: paragraph
                attrs:
                  textAlign: left
                content:
                  -
                    type: text
                    marks:
                      -
                        type: code
                    text: $this->mock()
          -
            type: tableCell
            attrs:
              colspan: 1
              rowspan: 1
              colwidth: null
            content:
              -
                type: paragraph
                attrs:
                  textAlign: left
                content:
                  -
                    type: text
                    text: 'No'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        marks:
          -
            type: bold
        text: 'Quick Picks:'
  -
    type: bulletList
    content:
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                marks:
                  -
                    type: bold
                text: 'Notifications/Mail/Event tests:'
              -
                type: text
                text: ' '
              -
                type: text
                marks:
                  -
                    type: code
                text: 'Facade::fake()'
              -
                type: text
                text: ' + '
              -
                type: text
                marks:
                  -
                    type: code
                text: assertSent
              -
                type: text
                text: /
              -
                type: text
                marks:
                  -
                    type: code
                text: assertDispatched
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                marks:
                  -
                    type: bold
                text: 'External services:'
              -
                type: text
                text: ' '
              -
                type: text
                marks:
                  -
                    type: code
                text: "$this->mock(Service::class, fn ($m) => $m->shouldReceive('call')->once())"
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                marks:
                  -
                    type: bold
                text: 'Partial behavior:'
              -
                type: text
                text: ' '
              -
                type: text
                marks:
                  -
                    type: code
                text: "$this->partialMock(Class::class, fn ($m) => $m->shouldReceive('send')->once())"
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                marks:
                  -
                    type: bold
                text: 'Cast/DTO placeholders (no container):'
              -
                type: text
                text: ' '
              -
                type: text
                marks:
                  -
                    type: code
                text: createStub()
  -
    type: horizontalRule
  -
    type: heading
    attrs:
      textAlign: left
      level: 1
    content:
      -
        type: text
        marks:
          -
            type: bold
        text: "What's Next"
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: "In this part, we tackled Mockery's dark side and eliminated 53 alias and overload mocks with the container binding pattern."
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        marks:
          -
            type: bold
        text: 'Part 3: Time Stood Still'
      -
        type: text
        text: ' will battle with time:'
  -
    type: bulletList
    content:
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                text: 'Flaky timestamp comparisons'
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                text: 'The five methods of time control'
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                text: 'The random value trap'
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                text: 'DataProviders running before Laravel boot'
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                text: 'Factory patterns and state management'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'See you there.'
  -
    type: horizontalRule
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        marks:
          -
            type: italic
        text: 'The Flaky Test Chronicles is a series of lessons from a 300-commit test suite cleanup'
---
