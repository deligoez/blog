---
id: 1998cc39-c36d-4965-a18d-42df897655b0
blueprint: articles
title: 'The Flaky Test Chronicles II: Mock Madness'
subtitle: 'Making Mockery Parallel-Safe'
updated_by: b8f3533e-0fcf-42b9-a3d8-c8691deaf917
updated_at: 1766426329
og_generator_image: the-flaky-test-chronicles-ii-mock-madness.jpg
show_toc: true
toc_levels:
  - 1
content:
  -
    type: heading
    attrs:
      textAlign: left
      level: 1
    content:
      -
        type: text
        text: 'The Crime Scene'
  -
    type: blockquote
    content:
      -
        type: paragraph
        attrs:
          textAlign: left
        content:
          -
            type: text
            text: '43 alias mocks walked into a CI pipeline. None of them came out parallel-safe.'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'One morning we saw this error in CI:'
  -
    type: codeBlock
    attrs:
      language: null
    content:
      -
        type: text
        text: |-
          Mockery\Exception\RuntimeException: Could not load mock
          App\Services\TarfinPayment\CreditCard\CreditCardPayment, class already exists
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: "Test passes locally. Fails in CI. The classic. But this time, I knew exactly what it was. I just didn't want to admit it."
  -
    type: set
    attrs:
      id: mjcj20zq
      values:
        type: sidenote
        content:
          -
            type: paragraph
            content:
              -
                type: text
                text: "There's a special circle of debugging hell reserved for errors that only happen in CI. Right next to “"
              -
                type: text
                marks:
                  -
                    type: italic
                text: 'works on my machine.”'
        style: note
        position: right
  -
    type: paragraph
    attrs:
      textAlign: left
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'The problem: '
      -
        type: text
        marks:
          -
            type: bold
        text: 'Mockery alias mocks.'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'Across 5 different test files, we were using '
      -
        type: text
        marks:
          -
            type: code
        text: "Mockery::mock('alias:...')"
      -
        type: text
        text: " in 43 places. And these mocks weren't compatible with parallel test runners."
  -
    type: horizontalRule
  -
    type: heading
    attrs:
      textAlign: left
      level: 1
    content:
      -
        type: text
        text: 'Why Alias Mocks Are the Enemy'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: "Mockery's "
      -
        type: text
        marks:
          -
            type: code
        text: 'alias:'
      -
        type: text
        text: ' prefix lets you mock static methods and class instantiation. Sounds great. But it has serious problems.'
  -
    type: heading
    attrs:
      textAlign: left
      level: 2
    content:
      -
        type: text
        text: 'Problem 1: Not Parallel-Safe'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'Alias mocks '
      -
        type: text
        marks:
          -
            type: bold
        text: globally
      -
        type: text
        text: " modify PHP's class autoloader. When two tests run in parallel and try to mock the same class:"
  -
    type: codeBlock
    attrs:
      language: null
    content:
      -
        type: text
        text: 'class already exists'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'PHP looks at you like you just asked it to divide by zero.'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: "Tests run in parallel by default in CI environments. If you run sequentially locally, you won't notice. It blows up in CI."
  -
    type: heading
    attrs:
      textAlign: left
      level: 2
    content:
      -
        type: text
        text: 'Problem 2: The Process Isolation Tax'
  -
    type: set
    attrs:
      id: mjcji1e8
      values:
        type: sidenote
        content:
          -
            type: paragraph
            content:
              -
                type: text
                text: 'Using '
              -
                type: text
                marks:
                  -
                    type: code
                text: '@runInSeparateProcess'
              -
                type: text
                text: " is like solving a flat tire by buying a new car. It works, technically. It's just 10-100x more expensive."
        style: note
        position: right
  -
    type: set
    attrs:
      id: mjcji4nu
      values:
        type: sidenote
        content:
          -
            type: paragraph
            content:
              -
                type: text
                text: 'In a suite of 10,000 tests, separate process for each test = hours. A test takes 100ms, process spawn takes 500ms. The math is terrible.'
        style: note
        position: right
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'The only safe way to use alias mocks is with '
      -
        type: text
        marks:
          -
            type: code
        text: '@runInSeparateProcess'
      -
        type: text
        text: ' annotation. But this:'
  -
    type: bulletList
    content:
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                marks:
                  -
                    type: bold
                text: 'Slows down by 10-100x'
              -
                type: text
                text: ' - Each test spawns a new PHP process'
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                marks:
                  -
                    type: bold
                text: 'Makes debugging impossible'
              -
                type: text
                text: ' - Breakpoints and '
              -
                type: text
                marks:
                  -
                    type: code
                text: var_dump
              -
                type: text
                text: " don't work"
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                marks:
                  -
                    type: bold
                text: 'Memory overhead'
              -
                type: text
                text: ' - Each process reloads the framework'
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                marks:
                  -
                    type: bold
                text: 'Multiplies CI time'
              -
                type: text
                text: " - Parallel runner can't optimize"
  -
    type: set
    attrs:
      id: mjcjirp0
      values:
        type: sidenote
        content:
          -
            type: paragraph
            content:
              -
                type: text
                text: 'Need for alias mocks = refactoring opportunity. Making production code more testable is better than hacking tests.'
        style: note
        position: right
  -
    type: heading
    attrs:
      textAlign: left
      level: 2
    content:
      -
        type: text
        text: 'Problem 3: Design Smell'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'If you need alias mocks, your code is tightly coupled to static calls. This is a '
      -
        type: text
        marks:
          -
            type: bold
        text: 'design problem'
      -
        type: text
        text: .
  -
    type: horizontalRule
  -
    type: set
    attrs:
      id: mjcjjfxk
      values:
        type: sidenote
        content:
          -
            type: paragraph
            content:
              -
                type: text
                text: '(With Tears)'
        style: note
        position: right
  -
    type: heading
    attrs:
      textAlign: left
      level: 1
    content:
      -
        type: text
        text: 'The Pattern to Avoid'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: "Here's the pattern we saw 43 times in our project:"
  -
    type: codeBlock
    attrs:
      language: null
    content:
      -
        type: text
        text: |-
          // BAD: Alias mock - not parallel-safe
          Mockery::mock('alias:'.CreditCardPayment::class)
              ->shouldReceive('create')
              ->with($payableDTO, $cardNumber)
              ->once()
              ->andReturnSelf()
              ->shouldReceive('withCard')
              ->andReturnSelf()
              ->shouldReceive('pay3d')
              ->andReturn(redirect($url));
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: "This code works. Locally. In sequential mode. But when CI's parallel runner kicks in, it explodes."
  -
    type: horizontalRule
  -
    type: heading
    attrs:
      textAlign: left
      level: 1
    content:
      -
        type: text
        text: 'The Solution: Factory Pattern'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'The solution is simple but requires significant refactoring: '
      -
        type: text
        marks:
          -
            type: link
            attrs:
              href: 'https://en.wikipedia.org/wiki/Factory_method_pattern'
              rel: null
              target: _blank
              title: null
          -
            type: bold
        text: 'Factory pattern'
      -
        type: text
        text: .
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'Instead of static calls, dependency injection through a factory class.'
  -
    type: set
    attrs:
      id: mjcjnftr
      values:
        type: sidenote
        content:
          -
            type: paragraph
            content:
              -
                type: text
                text: 'Why did we remove return types? PHP 8.2+ '
              -
                type: text
                marks:
                  -
                    type: code
                text: readonly
              -
                type: text
                text: " classes can't be extended. Mockery can't create typed mocks of these classes. Removing the return type lets Mockery return a generic mock."
        style: note
        position: right
  -
    type: heading
    attrs:
      textAlign: left
      level: 2
    content:
      -
        type: text
        text: 'Step 1: Create a Factory Class'
  -
    type: codeBlock
    attrs:
      language: null
    content:
      -
        type: text
        text: |-
          <?php

          declare(strict_types=1);

          namespace App\Services\TarfinPayment\CreditCard;

          use App\Enums\PlatformType;
          use App\Services\TarfinPayment\CreditCard\DTOs\PayableDTO;

          class CreditCardPaymentFactory
          {
              /**
               * Create a CreditCardPayment instance.
               *
               * Note: Return type intentionally omitted for Mockery compatibility
               * with readonly classes.
               *
               * @return CreditCardPayment
               */
              public function create(PayableDTO $payable, ?string $cardNumber = null, ?PlatformType $platformType = null)
              {
                  return CreditCardPayment::create($payable, $cardNumber, $platformType);
              }

              /**
               * Get default payment calculator.
               *
               * @return AbstractPaymentTableCalculator
               */
              public function default()
              {
                  return CreditCardPayment::default();
              }
          }
  -
    type: heading
    attrs:
      textAlign: left
      level: 2
    content:
      -
        type: text
        text: 'Step 2: Inject the Factory in Controllers'
  -
    type: codeBlock
    attrs:
      language: null
    content:
      -
        type: text
        text: |-
          class OrderPayWithCreditCardController extends Controller
          {
              public function __construct(
                  private readonly CreditCardPaymentFactory $creditCardPaymentFactory
              ) {}

              public function pay3D(Request $request, Order $order): RedirectResponse
              {
                  $payableDTO = PayableDTO::fromOrder($order);

                  // Use factory instead of static call
                  $payment = $this->creditCardPaymentFactory->create(
                      $payableDTO,
                      $request->card_number
                  );

                  return $payment->withCard($cardDTO)->pay3d();
              }
          }
  -
    type: heading
    attrs:
      textAlign: left
      level: 2
    content:
      -
        type: text
        text: 'Step 3: Mock the Factory in Tests'
  -
    type: codeBlock
    attrs:
      language: null
    content:
      -
        type: text
        text: |-
          #[Test]
          public function it_pays_using_credit_card_with_3d(): void
          {
              // Arrange
              $order = Order::factory()->create();
              $redirectUrl = 'https://payment.example.com/3d';

              // Create mock for CreditCardPayment instance
              $mockCreditCardPayment = Mockery::mock();
              $mockCreditCardPayment->shouldReceive('withCard')
                  ->with(Mockery::on(static fn ($args) => $args->is($cardDTO)))
                  ->once()
                  ->andReturnSelf();
              $mockCreditCardPayment->shouldReceive('withTransactionType')
                  ->with(TransactionType::RETAILER_CASH)
                  ->once()
                  ->andReturnSelf();
              $mockCreditCardPayment->shouldReceive('pay3d')
                  ->once()
                  ->andReturn(redirect($redirectUrl));

              // Mock factory to return our mock instance
              $this->mock(CreditCardPaymentFactory::class, function (MockInterface $mock) use ($mockCreditCardPayment, $order): void {
                  $mock->shouldReceive('create')
                      ->with(
                          Mockery::on(function ($payable) use ($order): bool {
                              $this->assertEquals($order->cash_price, $payable->getPaymentAmount());
                              return true;
                          }),
                          '5555555555555555'
                      )
                      ->once()
                      ->andReturn($mockCreditCardPayment);
              });

              // Act
              $response = $this->postJson(route('orders.pay-3d', $order), $creditCardData);

              // Assert
              $response->assertRedirect($redirectUrl);
          }
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'This approach:'
  -
    type: bulletList
    content:
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                text: '✅ Parallel-safe'
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                text: '✅ Mock through container'
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                text: '✅ No process isolation required'
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                text: '✅ Debugging works'
  -
    type: horizontalRule
  -
    type: heading
    attrs:
      textAlign: left
      level: 1
    content:
      -
        type: text
        text: 'Alternative: Container Binding'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: "Sometimes you don't want to create a full factory class. For simpler cases, you can use Laravel's container binding directly."
  -
    type: set
    attrs:
      id: mjcjsib8
      values:
        type: sidenote
        content:
          -
            type: paragraph
            content:
              -
                type: text
                text: "Container binding only works if the production code resolves the class through Laravel's container ("
              -
                type: text
                marks:
                  -
                    type: code
                text: 'app(StripeClient::class)'
              -
                type: text
                text: ' or constructor injection). Direct '
              -
                type: text
                marks:
                  -
                    type: code
                text: 'new StripeClient()'
              -
                type: text
                text: " calls won't be intercepted."
        style: note
        position: right
  -
    type: codeBlock
    attrs:
      language: null
    content:
      -
        type: text
        text: |-
          // Instead of alias mock:
          Mockery::mock('overload:StripeClient')
              ->shouldReceive('sendRequest')
              ->andReturn($response);

          // Use container binding:
          $mock = Mockery::mock(StripeClient::class);
          $mock->shouldReceive('sendRequest')
              ->once()
              ->andReturn($response);

          $this->app->bind(StripeClient::class, fn () => $mock);
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        marks:
          -
            type: bold
        text: 'When to use which:'
  -
    type: table
    content:
      -
        type: tableRow
        content:
          -
            type: tableHeader
            attrs:
              colspan: 1
              rowspan: 1
              colwidth: null
            content:
              -
                type: paragraph
                attrs:
                  textAlign: left
                content:
                  -
                    type: text
                    marks:
                      -
                        type: bold
                    text: Approach
          -
            type: tableHeader
            attrs:
              colspan: 1
              rowspan: 1
              colwidth: null
            content:
              -
                type: paragraph
                attrs:
                  textAlign: left
                content:
                  -
                    type: text
                    marks:
                      -
                        type: bold
                    text: 'Use When'
      -
        type: tableRow
        content:
          -
            type: tableCell
            attrs:
              colspan: 1
              rowspan: 1
              colwidth: null
            content:
              -
                type: paragraph
                attrs:
                  textAlign: left
                content:
                  -
                    type: text
                    text: 'Factory Pattern'
          -
            type: tableCell
            attrs:
              colspan: 1
              rowspan: 1
              colwidth: null
            content:
              -
                type: paragraph
                attrs:
                  textAlign: left
                content:
                  -
                    type: text
                    text: 'Class is used in multiple places, needs complex setup'
      -
        type: tableRow
        content:
          -
            type: tableCell
            attrs:
              colspan: 1
              rowspan: 1
              colwidth: null
            content:
              -
                type: paragraph
                attrs:
                  textAlign: left
                content:
                  -
                    type: text
                    text: 'Container Binding'
          -
            type: tableCell
            attrs:
              colspan: 1
              rowspan: 1
              colwidth: null
            content:
              -
                type: paragraph
                attrs:
                  textAlign: left
                content:
                  -
                    type: text
                    text: 'One-off mock, simpler setup, class already uses DI'
  -
    type: horizontalRule
  -
    type: heading
    attrs:
      textAlign: left
      level: 1
    content:
      -
        type: text
        text: 'Mocking Variations'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'Different mock setups for different scenarios:'
  -
    type: heading
    attrs:
      textAlign: left
      level: 2
    content:
      -
        type: text
        text: 'Payment Table (Single Method After Create)'
  -
    type: codeBlock
    attrs:
      language: null
    content:
      -
        type: text
        text: |-
          $mockCreditCardPayment = Mockery::mock();
          $mockCreditCardPayment->shouldReceive('getPaymentTable')
              ->once()
              ->andReturn(['installments' => [...]]);

          $this->mock(CreditCardPaymentFactory::class, function (MockInterface $mock) use ($mockCreditCardPayment): void {
              $mock->shouldReceive('create')
                  ->once()
                  ->andReturn($mockCreditCardPayment);
          });
  -
    type: heading
    attrs:
      textAlign: left
      level: 2
    content:
      -
        type: text
        text: 'Exception Testing'
  -
    type: codeBlock
    attrs:
      language: null
    content:
      -
        type: text
        text: |-
          $mockCreditCardPayment = Mockery::mock();
          $mockCreditCardPayment->shouldReceive('withCard')->once()->andReturnSelf();
          $mockCreditCardPayment->shouldReceive('pay3d')
              ->once()
              ->andThrow(new MokaPaymentAmountException('Payment failed'));

          $this->mock(CreditCardPaymentFactory::class, function (MockInterface $mock) use ($mockCreditCardPayment): void {
              $mock->shouldReceive('create')
                  ->once()
                  ->andReturn($mockCreditCardPayment);
          });

          $response = $this->postJson(route('orders.pay-3d', $order), $creditCardData);
          $response->assertUnprocessableEntity();
  -
    type: heading
    attrs:
      textAlign: left
      level: 2
    content:
      -
        type: text
        text: 'Never-Called Assertions'
  -
    type: codeBlock
    attrs:
      language: null
    content:
      -
        type: text
        text: |-
          // Code should abort before reaching payment
          $this->mock(CreditCardPaymentFactory::class, function (MockInterface $mock): void {
              $mock->shouldReceive('create')->never();
          });

          $response = $this->postJson(route('orders.pay-3d', $ineligibleOrder), $creditCardData);
          $response->assertUnprocessableEntity();
  -
    type: horizontalRule
  -
    type: heading
    attrs:
      textAlign: left
      level: 1
    content:
      -
        type: text
        text: 'Handling Readonly Classes'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'PHP 8.2+ readonly classes pose a special challenge for Mockery.'
  -
    type: codeBlock
    attrs:
      language: null
    content:
      -
        type: text
        text: |-
          // This fails if CreditCardPayment is readonly
          $mock = Mockery::mock(CreditCardPayment::class); // Error!
  -
    type: heading
    attrs:
      textAlign: left
      level: 3
    content:
      -
        type: text
        text: 'Solution 1: Untyped Mocks'
  -
    type: codeBlock
    attrs:
      language: null
    content:
      -
        type: text
        text: |-
          // Don't specify class - create generic mock
          $mockCreditCardPayment = Mockery::mock(); // Works!
          $mockCreditCardPayment->shouldReceive('pay3d')->andReturn(...);
  -
    type: heading
    attrs:
      textAlign: left
      level: 3
    content:
      -
        type: text
        text: 'Solution 2: Remove Return Types from Factory'
  -
    type: set
    attrs:
      id: mjck3d3e
      values:
        type: sidenote
        content:
          -
            type: paragraph
            content:
              -
                type: text
                text: 'You can document the return type with PHPDoc. IDEs and static analyzers can read PHPDoc. No runtime type enforcement, but Mockery works.'
        style: note
        position: right
  -
    type: paragraph
    attrs:
      textAlign: left
  -
    type: codeBlock
    attrs:
      language: null
    content:
      -
        type: text
        text: |-
          class CreditCardPaymentFactory
          {
              /**
               * Return type omitted for Mockery readonly class compatibility.
               *
               * @return CreditCardPayment
               */
              public function create(PayableDTO $payable) // No return type!
              {
                  return CreditCardPayment::create($payable);
              }
          }
  -
    type: horizontalRule
  -
    type: heading
    attrs:
      textAlign: left
      level: 1
    content:
      -
        type: text
        text: 'The Migration Checklist'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'When migrating from alias mocks to factory pattern:'
  -
    type: orderedList
    attrs:
      start: 1
    content:
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                text: 'Create factory class wrapping static calls'
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                text: 'Inject factory via constructor injection into controllers/services'
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                text: 'Update tests - factory mock instead of alias mock'
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                text: 'If readonly class, remove return types'
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                text: 'Add '
              -
                type: text
                marks:
                  -
                    type: code
                text: MockInterface
              -
                type: text
                text: ' import to test files'
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                text: 'Run tests to verify refactoring'
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                text: 'Search for '
              -
                type: text
                marks:
                  -
                    type: code
                text: "Mockery::mock('alias:"
              -
                type: text
                text: ' and repeat'
  -
    type: heading
    attrs:
      textAlign: left
      level: 2
    content:
      -
        type: text
        text: 'Real-World Impact'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'Results of our refactoring:'
  -
    type: table
    content:
      -
        type: tableRow
        content:
          -
            type: tableHeader
            attrs:
              colspan: 1
              rowspan: 1
              colwidth: null
            content:
              -
                type: paragraph
                attrs:
                  textAlign: left
                content:
                  -
                    type: text
                    marks:
                      -
                        type: bold
                    text: 'Test File'
          -
            type: tableHeader
            attrs:
              colspan: 1
              rowspan: 1
              colwidth: null
            content:
              -
                type: paragraph
                attrs:
                  textAlign: left
                content:
                  -
                    type: text
                    marks:
                      -
                        type: bold
                    text: 'Alias Mocks Removed'
      -
        type: tableRow
        content:
          -
            type: tableCell
            attrs:
              colspan: 1
              rowspan: 1
              colwidth: null
            content:
              -
                type: paragraph
                attrs:
                  textAlign: left
                content:
                  -
                    type: text
                    text: Retailer/OrderPayWithCreditCardControllerTest
          -
            type: tableCell
            attrs:
              colspan: 1
              rowspan: 1
              colwidth: null
            content:
              -
                type: paragraph
                attrs:
                  textAlign: left
                content:
                  -
                    type: text
                    text: '8'
      -
        type: tableRow
        content:
          -
            type: tableCell
            attrs:
              colspan: 1
              rowspan: 1
              colwidth: null
            content:
              -
                type: paragraph
                attrs:
                  textAlign: left
                content:
                  -
                    type: text
                    text: Retailer/PriceCalculatorMachineControllerTest
          -
            type: tableCell
            attrs:
              colspan: 1
              rowspan: 1
              colwidth: null
            content:
              -
                type: paragraph
                attrs:
                  textAlign: left
                content:
                  -
                    type: text
                    text: '9'
      -
        type: tableRow
        content:
          -
            type: tableCell
            attrs:
              colspan: 1
              rowspan: 1
              colwidth: null
            content:
              -
                type: paragraph
                attrs:
                  textAlign: left
                content:
                  -
                    type: text
                    text: Retailer/ApplicationMachineControllerTest
          -
            type: tableCell
            attrs:
              colspan: 1
              rowspan: 1
              colwidth: null
            content:
              -
                type: paragraph
                attrs:
                  textAlign: left
                content:
                  -
                    type: text
                    text: '11'
      -
        type: tableRow
        content:
          -
            type: tableCell
            attrs:
              colspan: 1
              rowspan: 1
              colwidth: null
            content:
              -
                type: paragraph
                attrs:
                  textAlign: left
                content:
                  -
                    type: text
                    text: Mobile/OrderPayWithCreditCardControllerTest
          -
            type: tableCell
            attrs:
              colspan: 1
              rowspan: 1
              colwidth: null
            content:
              -
                type: paragraph
                attrs:
                  textAlign: left
                content:
                  -
                    type: text
                    text: '8'
      -
        type: tableRow
        content:
          -
            type: tableCell
            attrs:
              colspan: 1
              rowspan: 1
              colwidth: null
            content:
              -
                type: paragraph
                attrs:
                  textAlign: left
                content:
                  -
                    type: text
                    text: General/OrderPayWithCreditCardControllerTest
          -
            type: tableCell
            attrs:
              colspan: 1
              rowspan: 1
              colwidth: null
            content:
              -
                type: paragraph
                attrs:
                  textAlign: left
                content:
                  -
                    type: text
                    text: '7'
      -
        type: tableRow
        content:
          -
            type: tableCell
            attrs:
              colspan: 1
              rowspan: 1
              colwidth: null
            content:
              -
                type: paragraph
                attrs:
                  textAlign: left
                content:
                  -
                    type: text
                    marks:
                      -
                        type: bold
                    text: Total
          -
            type: tableCell
            attrs:
              colspan: 1
              rowspan: 1
              colwidth: null
            content:
              -
                type: paragraph
                attrs:
                  textAlign: left
                content:
                  -
                    type: text
                    marks:
                      -
                        type: bold
                    text: '43'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        marks:
          -
            type: bold
        text: 'Result:'
      -
        type: text
        text: ' 74 tests now run in parallel, no conflicts.'
  -
    type: horizontalRule
  -
    type: set
    attrs:
      id: mjcll3r3
      values:
        type: sidenote
        content:
          -
            type: paragraph
            content:
              -
                type: text
                text: '(The Foundation)'
        style: note
        position: right
  -
    type: heading
    attrs:
      textAlign: left
      level: 1
    content:
      -
        type: text
        text: 'Mockery Best Practices'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'Beyond alias mocks, here are the fundamental rules of Mockery usage:'
  -
    type: heading
    attrs:
      textAlign: left
      level: 2
    content:
      -
        type: text
        text: '1. MockeryPHPUnitIntegration Trait'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'Add this trait to your base TestCase:'
  -
    type: codeBlock
    attrs:
      language: null
    content:
      -
        type: text
        text: |-
          <?php

          namespace Tests;

          use Mockery\Adapter\Phpunit\MockeryPHPUnitIntegration;
          use Illuminate\Foundation\Testing\TestCase as BaseTestCase;

          abstract class TestCase extends BaseTestCase
          {
              use MockeryPHPUnitIntegration;

              // ...
          }
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        marks:
          -
            type: bold
        text: 'Why it matters:'
  -
    type: bulletList
    content:
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                text: 'Mockery expectations are verified at end of each test'
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                text: 'Mock assertion counts integrate with PHPUnit'
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                text: 'Mockery closes properly after each test'
  -
    type: heading
    attrs:
      textAlign: left
      level: 2
    content:
      -
        type: text
        text: '2. Always Add Call Count Expectations'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'No call count on mock = no assertion = risky test.'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        marks:
          -
            type: bold
        text: 'Wrong (Risky Test):'
  -
    type: codeBlock
    attrs:
      language: null
    content:
      -
        type: text
        text: |-
          BankCollection::shouldReceive('updatePaymentStatusInfoWithPaymentExpCode')
              ->with($paymentId, $expCode, PaymentStatusType::MATCHED);
          // No call count = no assertion = PHPUnit warning
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        marks:
          -
            type: bold
        text: 'Correct:'
  -
    type: codeBlock
    attrs:
      language: null
    content:
      -
        type: text
        text: |-
          BankCollection::shouldReceive('updatePaymentStatusInfoWithPaymentExpCode')
              ->once()  // This is an assertion
              ->with($paymentId, $expCode, PaymentStatusType::MATCHED);
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        marks:
          -
            type: bold
        text: 'Call Count Methods:'
  -
    type: table
    content:
      -
        type: tableRow
        content:
          -
            type: tableHeader
            attrs:
              colspan: 1
              rowspan: 1
              colwidth: null
            content:
              -
                type: paragraph
                attrs:
                  textAlign: left
                content:
                  -
                    type: text
                    marks:
                      -
                        type: bold
                    text: Method
          -
            type: tableHeader
            attrs:
              colspan: 1
              rowspan: 1
              colwidth: null
            content:
              -
                type: paragraph
                attrs:
                  textAlign: left
                content:
                  -
                    type: text
                    marks:
                      -
                        type: bold
                    text: Usage
      -
        type: tableRow
        content:
          -
            type: tableCell
            attrs:
              colspan: 1
              rowspan: 1
              colwidth: null
            content:
              -
                type: paragraph
                attrs:
                  textAlign: left
                content:
                  -
                    type: text
                    marks:
                      -
                        type: code
                    text: '->once()'
          -
            type: tableCell
            attrs:
              colspan: 1
              rowspan: 1
              colwidth: null
            content:
              -
                type: paragraph
                attrs:
                  textAlign: left
                content:
                  -
                    type: text
                    text: 'Must be called exactly 1 time'
      -
        type: tableRow
        content:
          -
            type: tableCell
            attrs:
              colspan: 1
              rowspan: 1
              colwidth: null
            content:
              -
                type: paragraph
                attrs:
                  textAlign: left
                content:
                  -
                    type: text
                    marks:
                      -
                        type: code
                    text: '->twice()'
          -
            type: tableCell
            attrs:
              colspan: 1
              rowspan: 1
              colwidth: null
            content:
              -
                type: paragraph
                attrs:
                  textAlign: left
                content:
                  -
                    type: text
                    text: 'Must be called exactly 2 times'
      -
        type: tableRow
        content:
          -
            type: tableCell
            attrs:
              colspan: 1
              rowspan: 1
              colwidth: null
            content:
              -
                type: paragraph
                attrs:
                  textAlign: left
                content:
                  -
                    type: text
                    marks:
                      -
                        type: code
                    text: '->times(n)'
          -
            type: tableCell
            attrs:
              colspan: 1
              rowspan: 1
              colwidth: null
            content:
              -
                type: paragraph
                attrs:
                  textAlign: left
                content:
                  -
                    type: text
                    text: 'Must be called exactly n times'
      -
        type: tableRow
        content:
          -
            type: tableCell
            attrs:
              colspan: 1
              rowspan: 1
              colwidth: null
            content:
              -
                type: paragraph
                attrs:
                  textAlign: left
                content:
                  -
                    type: text
                    marks:
                      -
                        type: code
                    text: '->atLeast()->times(n)'
          -
            type: tableCell
            attrs:
              colspan: 1
              rowspan: 1
              colwidth: null
            content:
              -
                type: paragraph
                attrs:
                  textAlign: left
                content:
                  -
                    type: text
                    text: 'Must be called at least n times'
      -
        type: tableRow
        content:
          -
            type: tableCell
            attrs:
              colspan: 1
              rowspan: 1
              colwidth: null
            content:
              -
                type: paragraph
                attrs:
                  textAlign: left
                content:
                  -
                    type: text
                    marks:
                      -
                        type: code
                    text: '->atMost()->times(n)'
          -
            type: tableCell
            attrs:
              colspan: 1
              rowspan: 1
              colwidth: null
            content:
              -
                type: paragraph
                attrs:
                  textAlign: left
                content:
                  -
                    type: text
                    text: 'Must be called at most n times'
      -
        type: tableRow
        content:
          -
            type: tableCell
            attrs:
              colspan: 1
              rowspan: 1
              colwidth: null
            content:
              -
                type: paragraph
                attrs:
                  textAlign: left
                content:
                  -
                    type: text
                    marks:
                      -
                        type: code
                    text: '->never()'
          -
            type: tableCell
            attrs:
              colspan: 1
              rowspan: 1
              colwidth: null
            content:
              -
                type: paragraph
                attrs:
                  textAlign: left
                content:
                  -
                    type: text
                    text: 'Must never be called'
  -
    type: heading
    attrs:
      textAlign: left
      level: 2
    content:
      -
        type: text
        text: '3. partialMock() vs shouldReceive()'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'Using '
      -
        type: text
        marks:
          -
            type: code
        text: shouldReceive()
      -
        type: text
        text: ' directly on facades is dangerous.'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        marks:
          -
            type: bold
        text: 'Wrong (Can corrupt application container):'
  -
    type: codeBlock
    attrs:
      language: null
    content:
      -
        type: text
        text: |-
          LaravelConfig::shouldReceive('get')
              ->with('some.config.key')
              ->once()
              ->andReturn(true);
  -
    type: set
    attrs:
      id: mjckzhns
      values:
        type: sidenote
        content:
          -
            type: paragraph
            content:
              -
                type: text
                text: 'This change affected 37+ test files. A big refactoring but worth it.'
        style: note
        position: right
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        marks:
          -
            type: bold
        text: 'Correct:'
  -
    type: codeBlock
    attrs:
      language: null
    content:
      -
        type: text
        text: |-
          LaravelConfig::partialMock()
              ->shouldReceive('get')
              ->with('some.config.key')
              ->once()
              ->andReturn(true);
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        marks:
          -
            type: bold
        text: 'Why partialMock() is better:'
  -
    type: bulletList
    content:
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                text: 'Only mocks specified methods'
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                text: 'Rest of facade remains functional'
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                text: "Doesn't interfere with application container"
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                text: 'Prevents Sushi model caching issues'
  -
    type: heading
    attrs:
      textAlign: left
      level: 2
    content:
      -
        type: text
        text: 'The Facade vs Class Naming Trap'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: "There's another subtle mock failure mode: when a facade and its underlying class share the same name."
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'We had a package with this structure:'
  -
    type: codeBlock
    attrs:
      language: null
    content:
      -
        type: text
        text: |-
          TarfinLabs\LaravelConfig\LaravelConfig          // The class
          TarfinLabs\LaravelConfig\Facades\LaravelConfig  // The facade
  -
    type: set
    attrs:
      id: mjhgmjyg
      values:
        type: sidenote
        content:
          -
            type: paragraph
            content:
              -
                type: text
                marks:
                  -
                    type: link
                    attrs:
                      href: 'https://github.com/tarfin-labs/laravel-config'
                      rel: null
                      target: _blank
                      title: null
                text: 'Laravel Config'
              -
                type: text
                text: ' is an open source package we maintain and use in production. It provides key-value config management for Laravel.'
        style: note
        position: right
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'See the problem? When you type '
      -
        type: text
        marks:
          -
            type: code
        text: LaravelConfig
      -
        type: text
        text: " in your IDE, autocomplete shows both. It's easy to pick the wrong one."
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        marks:
          -
            type: bold
        text: 'Wrong (mocking the class directly):'
  -
    type: codeBlock
    attrs:
      language: null
    content:
      -
        type: text
        text: |-
          // BAD: Importing the class, not the facade
          use TarfinLabs\LaravelConfig\LaravelConfig;

          $this->mock(LaravelConfig::class)
              ->shouldReceive('get')
              ->once()
              ->andReturn('value');

          // Mock is set up... but facade calls bypass it entirely!
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: "The mock doesn't intercept anything because production code uses the "
      -
        type: text
        marks:
          -
            type: italic
        text: facade
      -
        type: text
        text: ', not the class directly.'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        marks:
          -
            type: bold
        text: 'Correct:'
  -
    type: codeBlock
    attrs:
      language: null
    content:
      -
        type: text
        text: |-
          // GOOD: Using the facade
          use TarfinLabs\LaravelConfig\Facades\LaravelConfig;

          LaravelConfig::partialMock()
              ->shouldReceive('get')
              ->once()
              ->andReturn('value');
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        marks:
          -
            type: bold
        text: 'The fix:'
      -
        type: text
        text: ' We renamed the class to '
      -
        type: text
        marks:
          -
            type: code
        text: ConfigManager
      -
        type: text
        text: ' in v6:'
  -
    type: codeBlock
    attrs:
      language: null
    content:
      -
        type: text
        text: |-
          TarfinLabs\LaravelConfig\ConfigManager          // The class (renamed)
          TarfinLabs\LaravelConfig\Facades\LaravelConfig  // The facade
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'Now when you type '
      -
        type: text
        marks:
          -
            type: code
        text: LaravelConfig
      -
        type: text
        text: ', only the facade appears. Problem solved at the source.'
  -
    type: heading
    attrs:
      textAlign: left
      level: 2
    content:
      -
        type: text
        text: '4. Conditional Mocking for DataProviders'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'When using '
      -
        type: text
        marks:
          -
            type: code
        text: DataProviders
      -
        type: text
        text: ', not every test case runs the same code path.'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        marks:
          -
            type: bold
        text: 'Wrong (Some datasets fail):'
  -
    type: codeBlock
    attrs:
      language: null
    content:
      -
        type: text
        text: |
          #[DataProvider('applicationStatuses')]
          #[Test]
          public function suspend_previous_applications(ApplicationStatus $status): void
          {
              // Mock setup happens every time
              BankMock::cancelApplication(true);

              // But some statuses don't call Fiba::cancelApplication()!
              // InvalidCountException: Expected 1 call, received 0
          }
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        marks:
          -
            type: bold
        text: 'Correct:'
  -
    type: codeBlock
    attrs:
      language: null
    content:
      -
        type: text
        text: |
          #[DataProvider('applicationStatuses')]
          #[Test]
          public function test_suspend_previous_applications(ApplicationStatus $status): void
          {
              $statusesThatTriggerCancellation = [
                  ApplicationStatus::BANK_DECISION_WAITING,
                  ApplicationStatus::BANK_PIN_WAITING,
              ];

              // Only mock if code path will be taken
              if (in_array($status, $statusesThatTriggerCancellation, true)) {
                  BankMock::cancelApplication(true);
              }

              // Test logic...
          }
  -
    type: heading
    attrs:
      textAlign: left
      level: 2
    content:
      -
        type: text
        text: "5. Don't Mock Unreachable Code"
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'When using '
      -
        type: text
        marks:
          -
            type: code
        text: 'Bus::fake()'
      -
        type: text
        text: ' or '
      -
        type: text
        marks:
          -
            type: code
        text: 'Queue::fake()'
      -
        type: text
        text: ", job internals don't execute."
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        marks:
          -
            type: bold
        text: 'Wrong:'
  -
    type: codeBlock
    attrs:
      language: null
    content:
      -
        type: text
        text: |-
          Bus::fake();  // Jobs won't execute

          BankMock::storeApplicant(true, [  // This will fail!
              'resultState' => StoreApplicantResultType::TH->name,
          ]);

          StoreApplicantJob::dispatch($application);

          Bus::assertDispatched(StoreApplicantJob::class);
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        marks:
          -
            type: bold
        text: 'Correct:'
  -
    type: codeBlock
    attrs:
      language: null
    content:
      -
        type: text
        text: |
          Bus::fake();

          // BankMock not needed - job doesn't execute

          StoreApplicantJob::dispatch($application);

          Bus::assertDispatched(StoreApplicantJob::class);
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        marks:
          -
            type: bold
        text: 'Scenarios where mock is unnecessary:'
  -
    type: bulletList
    content:
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                marks:
                  -
                    type: code
                text: 'Bus::fake()'
              -
                type: text
                text: " - queued jobs don't execute"
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                marks:
                  -
                    type: code
                text: 'Queue::fake()'
              -
                type: text
                text: " - queued jobs don't execute"
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                text: "Early return - subsequent code doesn't run"
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                text: "Exception throw - code after exception doesn't run"
  -
    type: horizontalRule
  -
    type: heading
    attrs:
      textAlign: left
      level: 1
    content:
      -
        type: text
        marks:
          -
            type: bold
        text: 'PHPUnit Mock vs Stub'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'PHPUnit 10+ separates mock and stub. In PHPUnit 12, a mock without expectations generates a warning.'
  -
    type: table
    content:
      -
        type: tableRow
        content:
          -
            type: tableHeader
            attrs:
              colspan: 1
              rowspan: 1
              colwidth: null
            content:
              -
                type: paragraph
                attrs:
                  textAlign: left
                content:
                  -
                    type: text
                    marks:
                      -
                        type: bold
                    text: Type
          -
            type: tableHeader
            attrs:
              colspan: 1
              rowspan: 1
              colwidth: null
            content:
              -
                type: paragraph
                attrs:
                  textAlign: left
                content:
                  -
                    type: text
                    marks:
                      -
                        type: bold
                    text: Purpose
          -
            type: tableHeader
            attrs:
              colspan: 1
              rowspan: 1
              colwidth: null
            content:
              -
                type: paragraph
                attrs:
                  textAlign: left
                content:
                  -
                    type: text
                    marks:
                      -
                        type: bold
                    text: Method
      -
        type: tableRow
        content:
          -
            type: tableCell
            attrs:
              colspan: 1
              rowspan: 1
              colwidth: null
            content:
              -
                type: paragraph
                attrs:
                  textAlign: left
                content:
                  -
                    type: text
                    marks:
                      -
                        type: bold
                    text: Mock
          -
            type: tableCell
            attrs:
              colspan: 1
              rowspan: 1
              colwidth: null
            content:
              -
                type: paragraph
                attrs:
                  textAlign: left
                content:
                  -
                    type: text
                    text: 'Verify calls/arguments'
          -
            type: tableCell
            attrs:
              colspan: 1
              rowspan: 1
              colwidth: null
            content:
              -
                type: paragraph
                attrs:
                  textAlign: left
                content:
                  -
                    type: text
                    marks:
                      -
                        type: code
                    text: createMock()
                  -
                    type: text
                    text: ' + '
                  -
                    type: text
                    marks:
                      -
                        type: code
                    text: expects()
      -
        type: tableRow
        content:
          -
            type: tableCell
            attrs:
              colspan: 1
              rowspan: 1
              colwidth: null
            content:
              -
                type: paragraph
                attrs:
                  textAlign: left
                content:
                  -
                    type: text
                    marks:
                      -
                        type: bold
                    text: Stub
          -
            type: tableCell
            attrs:
              colspan: 1
              rowspan: 1
              colwidth: null
            content:
              -
                type: paragraph
                attrs:
                  textAlign: left
                content:
                  -
                    type: text
                    text: 'Placeholder/return value'
          -
            type: tableCell
            attrs:
              colspan: 1
              rowspan: 1
              colwidth: null
            content:
              -
                type: paragraph
                attrs:
                  textAlign: left
                content:
                  -
                    type: text
                    marks:
                      -
                        type: code
                    text: createStub()
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        marks:
          -
            type: bold
        text: 'Rules:'
  -
    type: orderedList
    attrs:
      start: 1
    content:
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                text: 'If you only need a placeholder, use '
              -
                type: text
                marks:
                  -
                    type: code
                text: createStub()
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                text: 'If you need to verify calls, use '
              -
                type: text
                marks:
                  -
                    type: code
                text: createMock()
              -
                type: text
                text: ' + '
              -
                type: text
                marks:
                  -
                    type: code
                text: expects($this->once())
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                text: 'With '
              -
                type: text
                marks:
                  -
                    type: code
                text: getMockBuilder()->onlyMethods(...)
              -
                type: text
                text: ', stub every listed method'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        marks:
          -
            type: bold
        text: 'Examples:'
  -
    type: codeBlock
    attrs:
      language: null
    content:
      -
        type: text
        text: |
          // Stub - no verification
          $property = $this->createStub(DataProperty::class);
          $context = $this->createStub(CreationContext::class);
          $result = $cast->cast($property, 'value', [], $context);
          $this->assertEquals('expected', $result);

          // Mock - with verification
          $logger = $this->createMock(Logger::class);
          $logger->expects($this->once())->method('log')->with('error');
          $service->doSomething();
  -
    type: heading
    attrs:
      textAlign: left
      level: 1
    content:
      -
        type: text
        marks:
          -
            type: bold
        text: 'Concrete Test Stubs'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'If you only need to provide return values, creating a concrete test stub class avoids PHPUnit warnings:'
  -
    type: codeBlock
    attrs:
      language: null
    content:
      -
        type: text
        text: |
          final class StubQueryBuilder extends BaseQueryBuilder
          {
              public function __construct(private readonly array $filters = [])
              {
                  $this->model = StubModel::class;
              }

              public function allowedFilters(): array { return $this->filters; }
              public function allowedIncludes(): array { return []; }
              public function allowedFields(): array { return []; }
              public function allowedAppends(): array { return []; }
              public function allowedSorts(): array { return []; }
          }
  -
    type: horizontalRule
  -
    type: heading
    attrs:
      textAlign: left
      level: 1
    content:
      -
        type: text
        marks:
          -
            type: bold
        text: 'Laravel/Mockery vs PHPUnit Mocking'
  -
    type: table
    content:
      -
        type: tableRow
        content:
          -
            type: tableHeader
            attrs:
              colspan: 1
              rowspan: 1
              colwidth: null
            content:
              -
                type: paragraph
                attrs:
                  textAlign: left
                content:
                  -
                    type: text
                    marks:
                      -
                        type: bold
                    text: Tool
          -
            type: tableHeader
            attrs:
              colspan: 1
              rowspan: 1
              colwidth: null
            content:
              -
                type: paragraph
                attrs:
                  textAlign: left
                content:
                  -
                    type: text
                    marks:
                      -
                        type: bold
                    text: Stub
          -
            type: tableHeader
            attrs:
              colspan: 1
              rowspan: 1
              colwidth: null
            content:
              -
                type: paragraph
                attrs:
                  textAlign: left
                content:
                  -
                    type: text
                    marks:
                      -
                        type: bold
                    text: Mock
          -
            type: tableHeader
            attrs:
              colspan: 1
              rowspan: 1
              colwidth: null
            content:
              -
                type: paragraph
                attrs:
                  textAlign: left
                content:
                  -
                    type: text
                    marks:
                      -
                        type: bold
                    text: 'PHPUnit 10+ notice?'
      -
        type: tableRow
        content:
          -
            type: tableCell
            attrs:
              colspan: 1
              rowspan: 1
              colwidth: null
            content:
              -
                type: paragraph
                attrs:
                  textAlign: left
                content:
                  -
                    type: text
                    text: PHPUnit
          -
            type: tableCell
            attrs:
              colspan: 1
              rowspan: 1
              colwidth: null
            content:
              -
                type: paragraph
                attrs:
                  textAlign: left
                content:
                  -
                    type: text
                    marks:
                      -
                        type: code
                    text: createStub()
          -
            type: tableCell
            attrs:
              colspan: 1
              rowspan: 1
              colwidth: null
            content:
              -
                type: paragraph
                attrs:
                  textAlign: left
                content:
                  -
                    type: text
                    marks:
                      -
                        type: code
                    text: createMock()
                  -
                    type: text
                    text: ' + '
                  -
                    type: text
                    marks:
                      -
                        type: code
                    text: expects()
          -
            type: tableCell
            attrs:
              colspan: 1
              rowspan: 1
              colwidth: null
            content:
              -
                type: paragraph
                attrs:
                  textAlign: left
                content:
                  -
                    type: text
                    text: 'Yes (if no expectations)'
      -
        type: tableRow
        content:
          -
            type: tableCell
            attrs:
              colspan: 1
              rowspan: 1
              colwidth: null
            content:
              -
                type: paragraph
                attrs:
                  textAlign: left
                content:
                  -
                    type: text
                    text: Mockery
          -
            type: tableCell
            attrs:
              colspan: 1
              rowspan: 1
              colwidth: null
            content:
              -
                type: paragraph
                attrs:
                  textAlign: left
                content:
                  -
                    type: text
                    marks:
                      -
                        type: code
                    text: spy()
          -
            type: tableCell
            attrs:
              colspan: 1
              rowspan: 1
              colwidth: null
            content:
              -
                type: paragraph
                attrs:
                  textAlign: left
                content:
                  -
                    type: text
                    marks:
                      -
                        type: code
                    text: shouldReceive()->once()
          -
            type: tableCell
            attrs:
              colspan: 1
              rowspan: 1
              colwidth: null
            content:
              -
                type: paragraph
                attrs:
                  textAlign: left
                content:
                  -
                    type: text
                    text: 'No'
      -
        type: tableRow
        content:
          -
            type: tableCell
            attrs:
              colspan: 1
              rowspan: 1
              colwidth: null
            content:
              -
                type: paragraph
                attrs:
                  textAlign: left
                content:
                  -
                    type: text
                    text: 'Laravel facade'
          -
            type: tableCell
            attrs:
              colspan: 1
              rowspan: 1
              colwidth: null
            content:
              -
                type: paragraph
                attrs:
                  textAlign: left
                content:
                  -
                    type: text
                    marks:
                      -
                        type: code
                    text: 'Facade::fake()'
          -
            type: tableCell
            attrs:
              colspan: 1
              rowspan: 1
              colwidth: null
            content:
              -
                type: paragraph
                attrs:
                  textAlign: left
                content:
                  -
                    type: text
                    marks:
                      -
                        type: code
                    text: shouldReceive()->once()
          -
            type: tableCell
            attrs:
              colspan: 1
              rowspan: 1
              colwidth: null
            content:
              -
                type: paragraph
                attrs:
                  textAlign: left
                content:
                  -
                    type: text
                    text: 'No'
      -
        type: tableRow
        content:
          -
            type: tableCell
            attrs:
              colspan: 1
              rowspan: 1
              colwidth: null
            content:
              -
                type: paragraph
                attrs:
                  textAlign: left
                content:
                  -
                    type: text
                    text: 'Laravel helper'
          -
            type: tableCell
            attrs:
              colspan: 1
              rowspan: 1
              colwidth: null
            content:
              -
                type: paragraph
                attrs:
                  textAlign: left
                content:
                  -
                    type: text
                    marks:
                      -
                        type: code
                    text: $this->spy()
          -
            type: tableCell
            attrs:
              colspan: 1
              rowspan: 1
              colwidth: null
            content:
              -
                type: paragraph
                attrs:
                  textAlign: left
                content:
                  -
                    type: text
                    marks:
                      -
                        type: code
                    text: $this->mock()
          -
            type: tableCell
            attrs:
              colspan: 1
              rowspan: 1
              colwidth: null
            content:
              -
                type: paragraph
                attrs:
                  textAlign: left
                content:
                  -
                    type: text
                    text: 'No'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        marks:
          -
            type: bold
        text: 'Quick Picks:'
  -
    type: bulletList
    content:
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                marks:
                  -
                    type: bold
                text: 'Notifications/Mail/Event tests:'
              -
                type: text
                text: ' '
              -
                type: text
                marks:
                  -
                    type: code
                text: 'Facade::fake()'
              -
                type: text
                text: ' + '
              -
                type: text
                marks:
                  -
                    type: code
                text: assertSent
              -
                type: text
                text: /
              -
                type: text
                marks:
                  -
                    type: code
                text: assertDispatched
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                marks:
                  -
                    type: bold
                text: 'External services:'
              -
                type: text
                text: ' '
              -
                type: text
                marks:
                  -
                    type: code
                text: "$this->mock(Service::class, fn ($m) => $m->shouldReceive('call')->once())"
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                marks:
                  -
                    type: bold
                text: 'Partial behavior:'
              -
                type: text
                text: ' '
              -
                type: text
                marks:
                  -
                    type: code
                text: "$this->partialMock(Class::class, fn ($m) => $m->shouldReceive('send')->once())"
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                marks:
                  -
                    type: bold
                text: 'Cast/DTO placeholders (no container):'
              -
                type: text
                text: ' '
              -
                type: text
                marks:
                  -
                    type: code
                text: createStub()
  -
    type: horizontalRule
  -
    type: heading
    attrs:
      textAlign: left
      level: 1
    content:
      -
        type: text
        marks:
          -
            type: bold
        text: "What's Next"
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: "In Part 2 we saw Mockery's dark side. We eliminated 43 alias mocks with the factory pattern."
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        marks:
          -
            type: bold
        text: 'Part 3: Time Stood Still'
      -
        type: text
        text: ' will battle with time:'
  -
    type: bulletList
    content:
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                text: 'Flaky timestamp comparisons'
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                text: 'The random value trap'
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                text: 'DataProviders running before Laravel boot'
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                text: 'Factory patterns and state management'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'See you there.'
  -
    type: horizontalRule
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        marks:
          -
            type: italic
        text: 'The Flaky Test Chronicles is a series of lessons from a 300-commit test suite cleanup'
---
