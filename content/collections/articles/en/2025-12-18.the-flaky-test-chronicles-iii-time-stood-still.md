---
id: 5d9a03d6-6f6e-475f-adc2-956131aaab36
published: false
blueprint: articles
title: 'The Flaky Test Chronicles III: Time Stood Still'
subtitle: 'When Milliseconds Break Your Test Suite'
updated_by: b8f3533e-0fcf-42b9-a3d8-c8691deaf917
updated_at: 1766120597
og_generator_image: the-flaky-test-chronicles-iii-time-stood-still.jpg
show_toc: false
content:
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'When Milliseconds Break Your Test Suite'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        marks:
          -
            type: italic
        text: 'The Flaky Test Chronicles, Part 3: Time Stood Still'
  -
    type: blockquote
    content:
      -
        type: paragraph
        attrs:
          textAlign: left
        content:
          -
            type: text
            text: 'The test passed at 11:59 PM. It failed at midnight. Same code. Same data. Different universe.'
  -
    type: horizontalRule
  -
    type: heading
    attrs:
      textAlign: left
      level: 1
    content:
      -
        type: text
        marks:
          -
            type: bold
        text: 'The Timestamp Trap'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'The most insidious flaky tests are time-related. The code works correctly. The test looks reasonable. It passes locally. It fails in CI at random.'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'You spend hours debugging. Then you realize: '
      -
        type: text
        marks:
          -
            type: bold
        text: 'millisecond differences'
      -
        type: text
        text: .
  -
    type: codeBlock
    attrs:
      language: null
    content:
      -
        type: text
        text: |
          public function it_reports_overdue_order(): void
          {
              $order = Order::factory()->create();

              $requestDTO = CustomerLoanRequestDTO::fromOrder($order);

              ReportOverdueOrderJob::dispatchSync($order->id);

              // FAILS: payload timestamps differ by milliseconds
              $this->assertDatabaseHas('credit_bureau_reports', [
                  'payload' => $requestDTO->toString(),
              ]);
          }
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'When '
      -
        type: text
        marks:
          -
            type: code
        text: $requestDTO
      -
        type: text
        text: " is created, timestamp is X. When the job runs, timestamp is Y. The difference is 3 milliseconds. JSON payloads don't match. Test fails."
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: '{.sidenote} JSON timestamps are the ultimate betrayal. '
      -
        type: text
        marks:
          -
            type: code
        text: '2025-01-15T10:30:00.000Z'
      -
        type: text
        text: ' and '
      -
        type: text
        marks:
          -
            type: code
        text: '2025-01-15T10:30:00.003Z'
      -
        type: text
        text: ' look similar. They are not equal. {/sidenote}'
  -
    type: horizontalRule
  -
    type: heading
    attrs:
      textAlign: left
      level: 1
    content:
      -
        type: text
        marks:
          -
            type: bold
        text: 'When to Freeze Time'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'Situations where you need to freeze time:'
  -
    type: orderedList
    attrs:
      start: 1
    content:
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                marks:
                  -
                    type: bold
                text: 'Payload/DTO comparisons'
              -
                type: text
                text: ' - Timestamps in serialized data'
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                marks:
                  -
                    type: bold
                text: 'Business day calculations'
              -
                type: text
                text: ' - When day of week matters'
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                marks:
                  -
                    type: bold
                text: 'Date-dependent assertions'
              -
                type: text
                text: ' - "Created today", "Expires in 30 days"'
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                marks:
                  -
                    type: bold
                text: 'Scheduling tests'
              -
                type: text
                text: ' - Cron jobs, delayed jobs'
  -
    type: horizontalRule
  -
    type: heading
    attrs:
      textAlign: left
      level: 1
    content:
      -
        type: text
        marks:
          -
            type: bold
        text: 'The Five Methods of Time Control'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'Laravel provides powerful tools for controlling time.'
  -
    type: heading
    attrs:
      textAlign: left
      level: 1
    content:
      -
        type: text
        marks:
          -
            type: bold
        text: 'Method 1: Simple Freeze'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'The most basic approach. '
      -
        type: text
        marks:
          -
            type: code
        text: startOfMinute()
      -
        type: text
        text: ' eliminates millisecond differences.'
  -
    type: codeBlock
    attrs:
      language: null
    content:
      -
        type: text
        text: |
          $this->travelTo(now()->startOfMinute());

          // All now() calls return the frozen time
          $order = Order::factory()->create();

          $this->assertEquals(now(), $order->created_at);
  -
    type: heading
    attrs:
      textAlign: left
      level: 1
    content:
      -
        type: text
        marks:
          -
            type: bold
        text: 'Method 2: Freeze to Specific Day'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'When day of week matters:'
  -
    type: codeBlock
    attrs:
      language: null
    content:
      -
        type: text
        text: |
          // Freeze to next Monday for day-of-week dependent tests
          $this->travelTo(now()->next('Monday'));

          $paymentDate = $retailer->getNextPaymentDate();

          $this->assertEquals(now()->next('Wednesday'), $paymentDate);
  -
    type: heading
    attrs:
      textAlign: left
      level: 1
    content:
      -
        type: text
        marks:
          -
            type: bold
        text: 'Method 3: Freeze with Callback'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'Time is frozen only within the callback:'
  -
    type: codeBlock
    attrs:
      language: null
    content:
      -
        type: text
        text: |
          // Time is frozen only within the callback
          $this->travelTo(now()->subDay(), function () {
              $this->getJson('middleware-test-route')->assertOk();
          });

          // Time is back to normal here
  -
    type: heading
    attrs:
      textAlign: left
      level: 1
    content:
      -
        type: text
        marks:
          -
            type: bold
        text: 'Method 4: Travel Back Explicitly'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'When you want to handle cleanup yourself:'
  -
    type: codeBlock
    attrs:
      language: null
    content:
      -
        type: text
        text: |
          $this->travelTo(now()->next('Monday'));

          // ... test logic ...

          $this->travelBack();  // Restore original time
  -
    type: heading
    attrs:
      textAlign: left
      level: 1
    content:
      -
        type: text
        marks:
          -
            type: bold
        text: 'Method 5: Date::setTestNow()'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: '{.warning} Prefer '
      -
        type: text
        marks:
          -
            type: code
        text: $this->travelTo(...)
      -
        type: text
        text: '. However, if the code under test uses '
      -
        type: text
        marks:
          -
            type: code
        text: Illuminate\Support\Facades\Date
      -
        type: text
        text: ' directly (e.g., '
      -
        type: text
        marks:
          -
            type: code
        text: 'Date::parse()'
      -
        type: text
        text: ', '
      -
        type: text
        marks:
          -
            type: code
        text: today()
      -
        type: text
        text: '), freeze via the facade. {/warning}'
  -
    type: codeBlock
    attrs:
      language: null
    content:
      -
        type: text
        text: |
          use Illuminate\Support\Facades\Date;

          Date::setTestNow(Date::parse('2025-12-15 12:51:25'));

          // ... test logic ...

          Date::setTestNow(); // Always reset (see Part 4 for tearDown ordering)
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: '{.warning} Avoid natural language parsing like '
      -
        type: text
        marks:
          -
            type: code
        text: "Date::parse('Today, 17:00')->subHours(1)"
      -
        type: text
        text: '. Timezone and DST (daylight saving time) changes can lead to unexpected results. Prefer fixed timestamps. {/warning}'
  -
    type: horizontalRule
  -
    type: heading
    attrs:
      textAlign: left
      level: 1
    content:
      -
        type: text
        marks:
          -
            type: bold
        text: 'The created_at > Nightmare'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'Tests can become flaky when code checks "does a newer record exist?" and the test creates multiple related records back-to-back. Millisecond differences between records can flip the boolean result.'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        marks:
          -
            type: bold
        text: 'Before (Flaky):'
  -
    type: codeBlock
    attrs:
      language: null
    content:
      -
        type: text
        text: |
          // Code under test:
          // $hasNewApplication = $farmer->applications()
          //     ->where('created_at', '>', $application->created_at)
          //     ->exists();

          $applications = Application::factory()
              ->for($farmer)
              ->sequence(
                  ['platform' => PlatformType::Retailer],
                  ['platform' => PlatformType::Mobile],
              )
              ->rejected()
              ->count(2)
              ->create();

          // Depending on tiny timestamp differences, the "retailer" application
          // can be filtered out.
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: '{.sidenote} This problem becomes more pronounced in parallel CI runs. Records created within the same second sometimes have the same timestamp, sometimes different. {/sidenote}'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        marks:
          -
            type: bold
        text: 'After (Stable):'
  -
    type: codeBlock
    attrs:
      language: null
    content:
      -
        type: text
        text: |
          $createdAt = now()->startOfSecond();

          $applications = Application::factory()
              ->for($farmer)
              ->sequence(
                  ['platform' => PlatformType::Retailer],
                  ['platform' => PlatformType::Mobile],
              )
              ->rejected()
              ->count(2)
              ->create([
                  'created_at' => $createdAt,
                  'updated_at' => $createdAt,
              ]);

          // Verify all records have the same timestamp
          $this->assertCount(
              1,
              $applications
                  ->pluck('created_at')
                  ->map(fn ($d) => $d->format('Y-m-d H:i:s'))
                  ->unique()
          );
  -
    type: horizontalRule
  -
    type: heading
    attrs:
      textAlign: left
      level: 1
    content:
      -
        type: text
        marks:
          -
            type: bold
        text: 'Real-World Example: Overdue Order'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        marks:
          -
            type: bold
        text: 'Before (Flaky - timestamp mismatch):'
  -
    type: codeBlock
    attrs:
      language: null
    content:
      -
        type: text
        text: |
          public function it_reports_overdue_order(): void
          {
              $order = Order::factory()->create();

              $requestDTO = CustomerLoanRequestDTO::fromOrder($order);

              ReportOverdueOrderJob::dispatchSync($order->id);

              // FAILS: payload timestamps differ by milliseconds
              $this->assertDatabaseHas('credit_bureau_reports', [
                  'payload' => $requestDTO->toString(),
              ]);
          }
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        marks:
          -
            type: bold
        text: 'After (Stable - time frozen):'
  -
    type: codeBlock
    attrs:
      language: null
    content:
      -
        type: text
        text: |
          public function it_reports_overdue_order(): void
          {
              // Freeze time at the start of minute for consistent timestamps
              $this->travelTo(now()->startOfMinute());

              $order = Order::factory()->create();

              $requestDTO = CustomerLoanRequestDTO::fromOrder($order);

              ReportOverdueOrderJob::dispatchSync($order->id);

              // PASSES: timestamps are identical
              $this->assertDatabaseHas('credit_bureau_reports', [
                  'payload' => $requestDTO->toString(),
              ]);
          }
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: '{.tip} '
      -
        type: text
        marks:
          -
            type: code
        text: startOfMinute()
      -
        type: text
        text: ' is usually sufficient. For tests requiring second precision, use '
      -
        type: text
        marks:
          -
            type: code
        text: startOfSecond()
      -
        type: text
        text: '. {/tip}'
  -
    type: horizontalRule
  -
    type: heading
    attrs:
      textAlign: left
      level: 1
    content:
      -
        type: text
        marks:
          -
            type: bold
        text: 'The Randomness Illusion'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'Random values in tests might seem like a good idea. "It''ll catch edge cases," you think. But they actually cause more problems than they solve.'
  -
    type: heading
    attrs:
      textAlign: left
      level: 1
    content:
      -
        type: text
        marks:
          -
            type: bold
        text: 'Why Random Values Hurt'
  -
    type: codeBlock
    attrs:
      language: null
    content:
      -
        type: text
        text: |
          // This creates flaky tests
          $orders = Order::factory()
              ->times($this->faker->numberBetween(2, 5))
              ->create();

          // Assertions may fail randomly
          $this->assertCount(3, $orders);  // Might be 2, 3, 4, or 5!
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        marks:
          -
            type: bold
        text: 'Problems:'
  -
    type: orderedList
    attrs:
      start: 1
    content:
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                marks:
                  -
                    type: bold
                text: 'Flaky tests'
              -
                type: text
                text: ' - Same test passes/fails depending on random values'
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                marks:
                  -
                    type: bold
                text: 'Hard to debug'
              -
                type: text
                text: " - Can't consistently reproduce failures"
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                marks:
                  -
                    type: bold
                text: 'Misleading coverage'
              -
                type: text
                text: ' - Test might not actually cover all cases'
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                marks:
                  -
                    type: bold
                text: 'CI instability'
              -
                type: text
                text: ' - Random failures erode trust in test suite'
  -
    type: heading
    attrs:
      textAlign: left
      level: 1
    content:
      -
        type: text
        marks:
          -
            type: bold
        text: 'The Solution: Deterministic Values'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        marks:
          -
            type: bold
        text: 'Before:'
  -
    type: codeBlock
    attrs:
      language: null
    content:
      -
        type: text
        text: |
          $orders = Order::factory()
              ->times($this->faker->numberBetween(2, 5))
              ->create();

          $status = $this->faker->randomElement([
              PaymentStatus::DRAFT,
              PaymentStatus::PARTLY_PAID,
              PaymentStatus::FULLY_PAID,
          ]);
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        marks:
          -
            type: bold
        text: 'After:'
  -
    type: codeBlock
    attrs:
      language: null
    content:
      -
        type: text
        text: |
          $orders = Order::factory()
              ->times(3)  // Fixed count
              ->create();

          $status = PaymentStatus::DRAFT;  // Specific status
  -
    type: heading
    attrs:
      textAlign: left
      level: 1
    content:
      -
        type: text
        marks:
          -
            type: bold
        text: 'Use DataProviders Instead'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'Instead of randomness, use DataProviders to test multiple cases deterministically:'
  -
    type: codeBlock
    attrs:
      language: null
    content:
      -
        type: text
        text: |
          #[DataProvider('paymentStatuses')]
          #[Test]
          public function it_handles_payment_status(PaymentStatus $status): void
          {
              $order = Order::factory()->create([
                  'payment_status' => $status,
              ]);

              // Test each status deterministically
          }

          public static function paymentStatuses(): iterable
          {
              yield 'draft' => [PaymentStatus::DRAFT];
              yield 'partly paid' => [PaymentStatus::PARTLY_PAID];
              yield 'fully paid' => [PaymentStatus::FULLY_PAID];
          }
  -
    type: heading
    attrs:
      textAlign: left
      level: 1
    content:
      -
        type: text
        marks:
          -
            type: bold
        text: 'When Random IS Acceptable'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: "{.note} Random data that doesn't affect assertions is fine. Random data that affects test logic is not. {/note}"
  -
    type: codeBlock
    attrs:
      language: null
    content:
      -
        type: text
        text: |
          // OK: Random data that doesn't affect assertions
          $farmer = Farmer::factory()->create([
              'name' => $this->faker->name(),  // Doesn't matter for test
          ]);

          // NOT OK: Random data that affects test logic
          $order = Order::factory()->create([
              'amount' => $this->faker->numberBetween(1000, 5000),  // Affects assertions!
          ]);
  -
    type: horizontalRule
  -
    type: heading
    attrs:
      textAlign: left
      level: 1
    content:
      -
        type: text
        marks:
          -
            type: bold
        text: 'DataProvider Deep Dive'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: "PHPUnit's DataProvider feature is powerful but has subtleties that can lead to unexpected behavior."
  -
    type: heading
    attrs:
      textAlign: left
      level: 1
    content:
      -
        type: text
        marks:
          -
            type: bold
        text: 'The Boot Order Problem'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        marks:
          -
            type: bold
        text: 'DataProviders run BEFORE Laravel boots.'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'This means:'
  -
    type: bulletList
    content:
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                marks:
                  -
                    type: code
                text: now()
              -
                type: text
                text: ' returns a regular Carbon instance, not the immutable version configured in your service provider'
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                text: "Application configuration isn't available"
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                text: "Dependency injection doesn't work"
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: "{.warning} Don't use "
      -
        type: text
        marks:
          -
            type: code
        text: now()
      -
        type: text
        text: ', '
      -
        type: text
        marks:
          -
            type: code
        text: config()
      -
        type: text
        text: ', '
      -
        type: text
        marks:
          -
            type: code
        text: app()
      -
        type: text
        text: " in DataProviders - Laravel hasn't booted yet! {/warning}"
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        marks:
          -
            type: bold
        text: 'Before (Unexpected behavior):'
  -
    type: codeBlock
    attrs:
      language: null
    content:
      -
        type: text
        text: |
          public static function getLimitExpirationDate(): iterable
          {
              // PROBLEM: now() is called before Laravel boots!
              // This doesn't return CarbonImmutable as expected
              yield 'With expiration' => [now()->addDays(30)];
              yield 'Without expiration' => [null];
          }

          #[DataProvider('getLimitExpirationDate')]
          #[Test]
          public function it_handles_expiration(?CarbonInterface $expirationDate): void
          {
              // $expirationDate is not CarbonImmutable!
          }
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        marks:
          -
            type: bold
        text: 'After (Use string modifiers):'
  -
    type: codeBlock
    attrs:
      language: null
    content:
      -
        type: text
        text: |
          public static function getLimitExpirationDate(): iterable
          {
              // Use string modifiers instead of Carbon instances
              yield 'With expiration' => ['+30 days'];
              yield 'Without expiration' => [null];
          }

          #[DataProvider('getLimitExpirationDate')]
          #[Test]
          public function it_handles_expiration(?string $expirationDateModifier): void
          {
              // Convert to date inside the test where Laravel is booted
              $expirationDate = $expirationDateModifier
                  ? now()->modify($expirationDateModifier)
                  : null;

              // Now $expirationDate is CarbonImmutable as expected
          }
  -
    type: heading
    attrs:
      textAlign: left
      level: 1
    content:
      -
        type: text
        marks:
          -
            type: bold
        text: 'Safe vs Unsafe in DataProviders'
  -
    type: table
    content:
      -
        type: tableRow
        content:
          -
            type: tableHeader
            attrs:
              colspan: 1
              rowspan: 1
              colwidth: null
            content:
              -
                type: paragraph
                attrs:
                  textAlign: left
                content:
                  -
                    type: text
                    marks:
                      -
                        type: bold
                    text: Safe
          -
            type: tableHeader
            attrs:
              colspan: 1
              rowspan: 1
              colwidth: null
            content:
              -
                type: paragraph
                attrs:
                  textAlign: left
                content:
                  -
                    type: text
                    marks:
                      -
                        type: bold
                    text: Unsafe
      -
        type: tableRow
        content:
          -
            type: tableCell
            attrs:
              colspan: 1
              rowspan: 1
              colwidth: null
            content:
              -
                type: paragraph
                attrs:
                  textAlign: left
                content:
                  -
                    type: text
                    text: 'Scalar values (strings, int, bool)'
          -
            type: tableCell
            attrs:
              colspan: 1
              rowspan: 1
              colwidth: null
            content:
              -
                type: paragraph
                attrs:
                  textAlign: left
                content:
                  -
                    type: text
                    marks:
                      -
                        type: code
                    text: now()
                  -
                    type: text
                    text: ', '
                  -
                    type: text
                    marks:
                      -
                        type: code
                    text: today()
      -
        type: tableRow
        content:
          -
            type: tableCell
            attrs:
              colspan: 1
              rowspan: 1
              colwidth: null
            content:
              -
                type: paragraph
                attrs:
                  textAlign: left
                content:
                  -
                    type: text
                    text: Enums
          -
            type: tableCell
            attrs:
              colspan: 1
              rowspan: 1
              colwidth: null
            content:
              -
                type: paragraph
                attrs:
                  textAlign: left
                content:
                  -
                    type: text
                    marks:
                      -
                        type: code
                    text: config()
      -
        type: tableRow
        content:
          -
            type: tableCell
            attrs:
              colspan: 1
              rowspan: 1
              colwidth: null
            content:
              -
                type: paragraph
                attrs:
                  textAlign: left
                content:
                  -
                    type: text
                    text: 'Static data'
          -
            type: tableCell
            attrs:
              colspan: 1
              rowspan: 1
              colwidth: null
            content:
              -
                type: paragraph
                attrs:
                  textAlign: left
                content:
                  -
                    type: text
                    marks:
                      -
                        type: code
                    text: app()
      -
        type: tableRow
        content:
          -
            type: tableCell
            attrs:
              colspan: 1
              rowspan: 1
              colwidth: null
            content:
              -
                type: paragraph
                attrs:
                  textAlign: left
          -
            type: tableCell
            attrs:
              colspan: 1
              rowspan: 1
              colwidth: null
            content:
              -
                type: paragraph
                attrs:
                  textAlign: left
                content:
                  -
                    type: text
                    text: 'Any Laravel facade'
  -
    type: heading
    attrs:
      textAlign: left
      level: 1
    content:
      -
        type: text
        marks:
          -
            type: bold
        text: 'PHPUnit 10+ Attribute Syntax'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'PHPUnit 10 replaced the old '
      -
        type: text
        marks:
          -
            type: code
        text: '@dataProvider'
      -
        type: text
        text: ' annotation with PHP 8 attributes:'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        marks:
          -
            type: bold
        text: 'Old Style (PHPUnit 9 and earlier):'
  -
    type: codeBlock
    attrs:
      language: null
    content:
      -
        type: text
        text: |
          /**
           * @dataProvider applicationStatuses
           */
          public function test_something(ApplicationStatus $status): void
          {
              // ...
          }

          public function applicationStatuses(): array
          {
              return [
                  [ApplicationStatus::PENDING],
                  [ApplicationStatus::APPROVED],
              ];
          }
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        marks:
          -
            type: bold
        text: 'New Style (PHPUnit 10+):'
  -
    type: codeBlock
    attrs:
      language: null
    content:
      -
        type: text
        text: |
          use PHPUnit\Framework\Attributes\DataProvider;
          use PHPUnit\Framework\Attributes\Test;

          #[DataProvider('applicationStatuses')]
          #[Test]
          public function test_something(ApplicationStatus $status): void
          {
              // ...
          }

          public static function applicationStatuses(): iterable
          {
              yield 'pending' => [ApplicationStatus::PENDING];
              yield 'approved' => [ApplicationStatus::APPROVED];
          }
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        marks:
          -
            type: bold
        text: 'Key Differences:'
  -
    type: table
    content:
      -
        type: tableRow
        content:
          -
            type: tableHeader
            attrs:
              colspan: 1
              rowspan: 1
              colwidth: null
            content:
              -
                type: paragraph
                attrs:
                  textAlign: left
                content:
                  -
                    type: text
                    marks:
                      -
                        type: bold
                    text: Aspect
          -
            type: tableHeader
            attrs:
              colspan: 1
              rowspan: 1
              colwidth: null
            content:
              -
                type: paragraph
                attrs:
                  textAlign: left
                content:
                  -
                    type: text
                    marks:
                      -
                        type: bold
                    text: 'Old Style'
          -
            type: tableHeader
            attrs:
              colspan: 1
              rowspan: 1
              colwidth: null
            content:
              -
                type: paragraph
                attrs:
                  textAlign: left
                content:
                  -
                    type: text
                    marks:
                      -
                        type: bold
                    text: 'New Style'
      -
        type: tableRow
        content:
          -
            type: tableCell
            attrs:
              colspan: 1
              rowspan: 1
              colwidth: null
            content:
              -
                type: paragraph
                attrs:
                  textAlign: left
                content:
                  -
                    type: text
                    text: Syntax
          -
            type: tableCell
            attrs:
              colspan: 1
              rowspan: 1
              colwidth: null
            content:
              -
                type: paragraph
                attrs:
                  textAlign: left
                content:
                  -
                    type: text
                    marks:
                      -
                        type: code
                    text: '@dataProvider'
                  -
                    type: text
                    text: ' annotation'
          -
            type: tableCell
            attrs:
              colspan: 1
              rowspan: 1
              colwidth: null
            content:
              -
                type: paragraph
                attrs:
                  textAlign: left
                content:
                  -
                    type: text
                    marks:
                      -
                        type: code
                    text: '#[DataProvider()]'
                  -
                    type: text
                    text: ' attribute'
      -
        type: tableRow
        content:
          -
            type: tableCell
            attrs:
              colspan: 1
              rowspan: 1
              colwidth: null
            content:
              -
                type: paragraph
                attrs:
                  textAlign: left
                content:
                  -
                    type: text
                    text: Method
          -
            type: tableCell
            attrs:
              colspan: 1
              rowspan: 1
              colwidth: null
            content:
              -
                type: paragraph
                attrs:
                  textAlign: left
                content:
                  -
                    type: text
                    text: 'Instance method'
          -
            type: tableCell
            attrs:
              colspan: 1
              rowspan: 1
              colwidth: null
            content:
              -
                type: paragraph
                attrs:
                  textAlign: left
                content:
                  -
                    type: text
                    marks:
                      -
                        type: bold
                    text: 'Static method'
                  -
                    type: text
                    text: ' (required)'
      -
        type: tableRow
        content:
          -
            type: tableCell
            attrs:
              colspan: 1
              rowspan: 1
              colwidth: null
            content:
              -
                type: paragraph
                attrs:
                  textAlign: left
                content:
                  -
                    type: text
                    text: Return
          -
            type: tableCell
            attrs:
              colspan: 1
              rowspan: 1
              colwidth: null
            content:
              -
                type: paragraph
                attrs:
                  textAlign: left
                content:
                  -
                    type: text
                    marks:
                      -
                        type: code
                    text: array
          -
            type: tableCell
            attrs:
              colspan: 1
              rowspan: 1
              colwidth: null
            content:
              -
                type: paragraph
                attrs:
                  textAlign: left
                content:
                  -
                    type: text
                    marks:
                      -
                        type: code
                    text: iterable
                  -
                    type: text
                    text: ' (array or generator)'
      -
        type: tableRow
        content:
          -
            type: tableCell
            attrs:
              colspan: 1
              rowspan: 1
              colwidth: null
            content:
              -
                type: paragraph
                attrs:
                  textAlign: left
                content:
                  -
                    type: text
                    text: 'IDE Support'
          -
            type: tableCell
            attrs:
              colspan: 1
              rowspan: 1
              colwidth: null
            content:
              -
                type: paragraph
                attrs:
                  textAlign: left
                content:
                  -
                    type: text
                    text: Limited
          -
            type: tableCell
            attrs:
              colspan: 1
              rowspan: 1
              colwidth: null
            content:
              -
                type: paragraph
                attrs:
                  textAlign: left
                content:
                  -
                    type: text
                    text: 'Full autocomplete and refactoring'
  -
    type: heading
    attrs:
      textAlign: left
      level: 1
    content:
      -
        type: text
        marks:
          -
            type: bold
        text: 'Named Data Sets'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'Use named data sets to make test output readable:'
  -
    type: codeBlock
    attrs:
      language: null
    content:
      -
        type: text
        text: |
          public static function getLatencies(): iterable
          {
              yield '35 days overdue' => [35];
              yield '65 days overdue' => [65];
              yield '95 days overdue' => [95];
          }

          // Test output shows:
          // ✓ it reports overdue order with data set "35 days overdue"
          // ✓ it reports overdue order with data set "65 days overdue"
          // ✓ it reports overdue order with data set "95 days overdue"
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: '{.tip} Named data sets make understanding failed tests much easier. Seeing '
      -
        type: text
        marks:
          -
            type: code
        text: 'data set "65 days overdue"'
      -
        type: text
        text: ' instead of '
      -
        type: text
        marks:
          -
            type: code
        text: 'data set #2'
      -
        type: text
        text: ' speeds up debugging. {/tip}'
  -
    type: horizontalRule
  -
    type: heading
    attrs:
      textAlign: left
      level: 1
    content:
      -
        type: text
        marks:
          -
            type: bold
        text: 'Factory Patterns for Test Data'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'Factories are the most powerful way to create test data. But when used incorrectly, they can lead to flaky tests.'
  -
    type: heading
    attrs:
      textAlign: left
      level: 1
    content:
      -
        type: text
        marks:
          -
            type: bold
        text: 'factory()->create() vs firstOrCreate()'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        marks:
          -
            type: bold
        text: 'Use '
      -
        type: text
        marks:
          -
            type: code
        text: factory()->create()
      -
        type: text
        marks:
          -
            type: bold
        text: ' for:'
  -
    type: bulletList
    content:
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                text: 'Test-specific data (should be isolated)'
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                text: 'Data that can differ between tests'
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                text: 'Most test scenarios'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        marks:
          -
            type: bold
        text: 'Use '
      -
        type: text
        marks:
          -
            type: code
        text: firstOrCreate()
      -
        type: text
        marks:
          -
            type: bold
        text: ' for:'
  -
    type: bulletList
    content:
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                text: 'Shared reference data (workflow types, status codes)'
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                text: 'Data seeded by migrations'
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                text: 'Data that must be consistent across tests'
  -
    type: codeBlock
    attrs:
      language: null
    content:
      -
        type: text
        text: |
          // WorkflowJob is reference data - use firstOrCreate
          $workflowJob = WorkflowJob::firstOrCreate(
              ['id' => OrderWorkflowType::ConfirmDelivery->value],
              ['name' => 'Confirm Delivery']
          );

          // Order is test data - use factory
          $order = Order::factory()
              ->withWorkflowJob($workflowJob)
              ->create();
  -
    type: heading
    attrs:
      textAlign: left
      level: 1
    content:
      -
        type: text
        marks:
          -
            type: bold
        text: 'Use Correct Factory State Methods'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: "Using the wrong factory state creates data that doesn't match the test scenario."
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        marks:
          -
            type: bold
        text: 'Example: Fast Payable Order'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'A "fast payable" order requires specific workflow states:'
  -
    type: bulletList
    content:
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                marks:
                  -
                    type: code
                text: ConfirmDigitalPromissoryNoteDocument
              -
                type: text
                text: ': DONE'
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                marks:
                  -
                    type: code
                text: ConfirmDocumentsSigned
              -
                type: text
                text: ': NOT done'
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                marks:
                  -
                    type: code
                text: ConfirmPromissoryNoteDocument
              -
                type: text
                text: ': NOT done'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        marks:
          -
            type: bold
        text: 'Wrong (All workflows done):'
  -
    type: codeBlock
    attrs:
      language: null
    content:
      -
        type: text
        text: |
          // This creates ALL workflows as done - not a fast payable order!
          $order = Order::factory()
              ->withFulfilledWorkflowJobItems(isRequiredForPayment: true)
              ->create();
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        marks:
          -
            type: bold
        text: 'Correct (Specific workflow states):'
  -
    type: codeBlock
    attrs:
      language: null
    content:
      -
        type: text
        text: |
          // This creates the correct state for a fast payable order
          $order = Order::factory()
              ->retailerFastPayable(retailerPaymentReleaseDate: now()->previous('Wednesday'))
              ->create();
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: '{.note} Use factory states semantically. '
      -
        type: text
        marks:
          -
            type: code
        text: withFulfilledWorkflowJobItems()
      -
        type: text
        text: ' might not always create the state you expect. {/note}'
  -
    type: heading
    attrs:
      textAlign: left
      level: 1
    content:
      -
        type: text
        marks:
          -
            type: bold
        text: 'Additional Tips'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        marks:
          -
            type: bold
        text: '1. Avoid random business rules:'
  -
    type: codeBlock
    attrs:
      language: null
    content:
      -
        type: text
        text: |
          // WRONG: Random subcategory might trigger GTS
          $order = Order::factory()->create();

          // CORRECT: Explicit non-GTS subcategory
          $subcategory = Subcategory::factory()
              ->notRequiringGTS()
              ->create();

          $order = Order::factory()
              ->for($subcategory)
              ->create();
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        marks:
          -
            type: bold
        text: '2. Fake BEFORE factory:'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: "Factories' "
      -
        type: text
        marks:
          -
            type: code
        text: afterCreating
      -
        type: text
        text: ' hooks can send notifications or mail. Set fakes before creating models to avoid side effects.'
  -
    type: codeBlock
    attrs:
      language: null
    content:
      -
        type: text
        text: |
          // CORRECT ORDER
          Notification::fake();
          Mail::fake();

          $order = Order::factory()->create();  // afterCreating hooks won't send real notifications
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        marks:
          -
            type: bold
        text: '3. Money unit awareness:'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: "Money configs might already be in minor units. Don't double-convert."
  -
    type: codeBlock
    attrs:
      language: null
    content:
      -
        type: text
        text: |
          // WRONG: Double conversion
          TarfinMoney::of(config('tarfin.application.cash_price_min'));  // Already in minor units!

          // CORRECT: Use ofMinor
          TarfinMoney::ofMinor(config('tarfin.application.cash_price_min'));
  -
    type: horizontalRule
  -
    type: heading
    attrs:
      textAlign: left
      level: 1
    content:
      -
        type: text
        marks:
          -
            type: bold
        text: 'The Determinism Checklist'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'Use this checklist when writing or reviewing tests:'
  -
    type: bulletList
    content:
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                text: 'Time is frozen with '
              -
                type: text
                marks:
                  -
                    type: code
                text: travelTo()
              -
                type: text
                text: ' where necessary'
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                text: "Random values don't affect test logic or counts"
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                text: "DataProviders don't use "
              -
                type: text
                marks:
                  -
                    type: code
                text: now()
              -
                type: text
                text: ', '
              -
                type: text
                marks:
                  -
                    type: code
                text: config()
              -
                type: text
                text: ', or facades'
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                text: 'Back-to-back created records have explicit timestamps'
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                text: 'Factory states match test scenario'
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                text: 'Multiple cases use DataProviders (not randomness)'
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                text: 'Fixed timestamps instead of natural language date parsing ('
              -
                type: text
                marks:
                  -
                    type: code
                text: "'Today, 17:00'"
              -
                type: text
                text: )
  -
    type: horizontalRule
  -
    type: heading
    attrs:
      textAlign: left
      level: 1
    content:
      -
        type: text
        marks:
          -
            type: bold
        text: "What's Next"
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'In Part 3 we took control of time and avoided the randomness traps.'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        marks:
          -
            type: bold
        text: 'Part 4: The Cleanup'
      -
        type: text
        text: ' covers test infrastructure:'
  -
    type: bulletList
    content:
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                text: 'Why '
              -
                type: text
                marks:
                  -
                    type: code
                text: tearDown()
              -
                type: text
                text: ' method ordering is critical'
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                text: 'The mysterious errors caused by Sushi models'
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                text: 'Proper use of HTTP, Event, and Queue fakes'
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                text: 'The ultimate testing checklist'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'See you there.'
  -
    type: horizontalRule
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        marks:
          -
            type: italic
        text: 'The Flaky Test Chronicles is a series of lessons from a 300-commit test suite cleanup.'
---
