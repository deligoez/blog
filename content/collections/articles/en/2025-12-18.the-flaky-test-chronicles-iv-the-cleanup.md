---
id: cb6753c2-e359-49bc-832a-51c34c92696d
published: false
blueprint: articles
title: 'The Flaky Test Chronicles IV: The Cleanup'
subtitle: 'The Art of Test Cleanup and Assertion Patterns'
updated_by: b8f3533e-0fcf-42b9-a3d8-c8691deaf917
updated_at: 1766441683
og_generator_image: the-flaky-test-chronicles-iv-the-cleanup.jpg
show_toc: true
toc_levels:
  - 1
content:
  -
    type: blockquote
    content:
      -
        type: paragraph
        attrs:
          textAlign: left
        content:
          -
            type: text
            text: 'One line in '
          -
            type: text
            marks:
              -
                type: code
            text: tearDown()
          -
            type: text
            text: '. Wrong order. 200 tests fail. Nobody knows why.'
  -
    type: heading
    attrs:
      textAlign: left
      level: 1
    content:
      -
        type: text
        text: 'The Order of Destruction'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'The '
      -
        type: text
        marks:
          -
            type: code
        text: tearDown()
      -
        type: text
        text: ' method seems simple. Clean up after your test. What could go wrong?'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'Everything. Everything can go wrong.'
  -
    type: heading
    attrs:
      textAlign: left
      level: 2
    content:
      -
        type: text
        text: 'The Golden Rule'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'Custom cleanup BEFORE '
      -
        type: text
        marks:
          -
            type: code
        text: 'parent::tearDown()'
      -
        type: text
        text: '. Always.'
  -
    type: codeBlock
    attrs:
      language: null
    content:
      -
        type: text
        text: |-
          protected function tearDown(): void
          {
              // 1. Your custom cleanup first
              $this->refreshSushiModels();
              $this->clearCustomCache();

              // 2. Parent tearDown last
              parent::tearDown();
          }
  -
    type: set
    attrs:
      id: mjcyuhrn
      values:
        type: sidenote
        content:
          -
            type: paragraph
            content:
              -
                type: text
                text: 'Call '
              -
                type: text
                marks:
                  -
                    type: code
                text: 'parent::tearDown()'
              -
                type: text
                text: " last. Unless you enjoy debugging why your cleanup code can't access things that no longer exist."
        style: tip
        position: right
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        marks:
          -
            type: bold
        text: 'Why This Order Matters:'
  -
    type: bulletList
    content:
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                marks:
                  -
                    type: code
                text: 'parent::tearDown()'
              -
                type: text
                text: ' may clear resources your cleanup needs'
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                text: 'Mockery is closed in parent tearDown'
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                text: 'Database transactions are rolled back in parent tearDown'
  -
    type: heading
    attrs:
      textAlign: left
      level: 2
    content:
      -
        type: text
        text: 'Centralize Cleanup in Base TestCase'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        marks:
          -
            type: bold
        text: 'The Problem:'
      -
        type: text
        text: ' Repeated cleanup logic scattered across multiple test files via traits.'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        marks:
          -
            type: bold
        text: 'Before (Using traits everywhere):'
  -
    type: codeBlock
    attrs:
      language: null
    content:
      -
        type: text
        text: |-
          class SomeTest extends TestCase
          {
              use RefreshesSushiModels;  // Must remember to add this

              // ...
          }
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        marks:
          -
            type: bold
        text: 'After (Centralized in TestCase):'
  -
    type: codeBlock
    attrs:
      language: null
    content:
      -
        type: text
        text: |-
          // In TestCase.php
          protected function tearDown(): void
          {
              $this->refreshSushiModels();  // Always runs
              parent::tearDown();
          }

          private function refreshSushiModels(): void
          {
              RetailerFastPayableOrder::flushEventListeners();

              $reflection = new ReflectionClass(RetailerFastPayableOrder::class);
              $property = $reflection->getProperty('sushiConnection');
              $property->setAccessible(true);
              $property->setValue(null, null);

              RetailerFastPayableOrder::clearBootedModels();
          }
  -
    type: set
    attrs:
      id: mjcyx61u
      values:
        type: sidenote
        content:
          -
            type: paragraph
            content:
              -
                type: text
                text: 'Trait explosion is a symptom, not a solution. Centralize in TestCase.'
        style: warning
        position: right
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        marks:
          -
            type: bold
        text: 'Benefits:'
  -
    type: bulletList
    content:
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                text: 'No need to remember adding traits to individual test classes'
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                text: 'Consistent cleanup across all tests'
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                text: 'Single place to modify cleanup logic'
  -
    type: heading
    attrs:
      textAlign: left
      level: 2
    content:
      -
        type: text
        text: 'When Traits Make Sense'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'Sometimes traits are the right choice, when a concern is needed by only some tests and has its own lifecycle.'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        marks:
          -
            type: bold
        text: 'The evolution we witnessed:'
  -
    type: bulletList
    content:
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                marks:
                  -
                    type: bold
                text: 'Before:'
              -
                type: text
                text: ' Everything in TestCase tearDown (runs for ALL tests)'
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                marks:
                  -
                    type: bold
                text: 'After:'
              -
                type: text
                text: ' Opt-in traits for specific concerns (runs only when trait is used)'
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                marks:
                  -
                    type: bold
                text: 'Why:'
              -
                type: text
                text: ' Not every test needs Sushi refresh. Targeted cleanup is faster.'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'Laravel automatically discovers '
      -
        type: text
        marks:
          -
            type: code
        text: setUpXXX()
      -
        type: text
        text: ' and '
      -
        type: text
        marks:
          -
            type: code
        text: tearDownXXX()
      -
        type: text
        text: ' methods in traits. See Part 5 for detailed examples of trait organization and naming conventions.'
  -
    type: horizontalRule
  -
    type: heading
    attrs:
      textAlign: left
      level: 1
    content:
      -
        type: text
        text: 'The Sushi Model Mystery'
  -
    type: heading
    attrs:
      textAlign: left
      level: 2
    content:
      -
        type: text
        text: 'What is Sushi?'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        marks:
          -
            type: link
            attrs:
              href: 'https://github.com/calebporzio/sushi'
              rel: null
              target: null
              title: null
        text: Sushi
      -
        type: text
        text: ' is a package that allows Eloquent models to be backed by arrays or custom queries instead of database tables. It creates in-memory SQLite databases for caching.'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: "Fast. Convenient. Haunted by static connections that remember things they shouldn't."
  -
    type: heading
    attrs:
      textAlign: left
      level: 2
    content:
      -
        type: text
        text: 'The Problem'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'Sushi models cache their SQLite connections statically. When tests mock facades (especially the Application container), this cached connection can become corrupted:'
  -
    type: codeBlock
    attrs:
      language: null
    content:
      -
        type: text
        text: |-
          Mockery\Exception\BadMethodCallException:
          Received Mockery_0::connection(), but no expectations were specified
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: "You mocked Config. Sushi's static connection is pointing to a Mockery ghost. The test has no idea what's happening. Neither do you."
  -
    type: heading
    attrs:
      textAlign: left
      level: 2
    content:
      -
        type: text
        text: 'The Solution'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'Reset the Sushi connection in '
      -
        type: text
        marks:
          -
            type: code
        text: tearDown()
      -
        type: text
        text: ':'
  -
    type: set
    attrs:
      id: mjcz2205
      values:
        type: sidenote
        content:
          -
            type: paragraph
            content:
              -
                type: text
                text: "This is defensive programming. You don't need to know which test mocked what. You just clean up everything, every time."
        style: info
        position: right
  -
    type: codeBlock
    attrs:
      language: null
    content:
      -
        type: text
        text: |-
          private function refreshSushiModels(): void
          {
              RetailerFastPayableOrder::flushEventListeners();

              $reflection = new ReflectionClass(RetailerFastPayableOrder::class);
              $property = $reflection->getProperty('sushiConnection');
              $property->setAccessible(true);
              $property->setValue(null, null);

              RetailerFastPayableOrder::clearBootedModels();
          }
  -
    type: heading
    attrs:
      textAlign: left
      level: 2
    content:
      -
        type: text
        text: 'Why Not Use partialMock Everywhere?'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'You might think: '
      -
        type: text
        marks:
          -
            type: italic
        text: '“If the problem is facade mocking corrupting Sushi connections, why not just use '
      -
        type: text
        marks:
          -
            type: code
        text: partialMock()
      -
        type: text
        marks:
          -
            type: italic
        text: ' in every test that uses Sushi models?”'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'This approach has significant drawbacks:'
  -
    type: orderedList
    attrs:
      start: 1
    content:
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                marks:
                  -
                    type: bold
                text: 'Implicit coupling'
              -
                type: text
                text: ' - Tests become dependent on knowing which models use Sushi'
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                marks:
                  -
                    type: bold
                text: 'Maintenance burden'
              -
                type: text
                text: ' - Adding a new Sushi model requires updating many tests'
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                marks:
                  -
                    type: bold
                text: 'Hidden complexity'
              -
                type: text
                text: ' - Developers must remember this rule for every test'
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                marks:
                  -
                    type: bold
                text: 'Cascading issues'
              -
                type: text
                text: ' - '
              -
                type: text
                marks:
                  -
                    type: code
                text: partialMock()
              -
                type: text
                text: ' on Application container can cause other unexpected behaviors'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'The '
      -
        type: text
        marks:
          -
            type: code
        text: tearDown()
      -
        type: text
        text: ' cleanup approach is better because:'
  -
    type: bulletList
    content:
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                text: "It's "
              -
                type: text
                marks:
                  -
                    type: bold
                text: automatic
              -
                type: text
                text: ' - No need to remember anything per test'
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                text: "It's "
              -
                type: text
                marks:
                  -
                    type: bold
                text: centralized
              -
                type: text
                text: ' - One place to fix issues'
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                text: "It's "
              -
                type: text
                marks:
                  -
                    type: bold
                text: defensive
              -
                type: text
                text: ' - Works regardless of what mocking a test does'
  -
    type: heading
    attrs:
      textAlign: left
      level: 2
    content:
      -
        type: text
        text: 'Cache Clearing Before Mocks'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        marks:
          -
            type: bold
        text: 'The Problem:'
      -
        type: text
        text: ' When mocking config values that are cached, the cache may already contain a value from a previous test. Your mock never gets triggered.'
  -
    type: set
    attrs:
      id: mjcz6q9x
      values:
        type: sidenote
        content:
          -
            type: paragraph
            content:
              -
                type: text
                text: 'Config is cached. You mock Config. The cached version wins. Your mock loses. You lose an hour.'
        style: danger
        position: right
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        marks:
          -
            type: bold
        text: 'Before (Mock not triggered):'
  -
    type: codeBlock
    attrs:
      language: null
    content:
      -
        type: text
        text: |-
          LaravelConfig::partialMock()
              ->shouldReceive('get')
              ->with('mobile_delivery_confirmation')
              ->once()
              ->andReturns(false);

          // Test fails because cached value is returned instead
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        marks:
          -
            type: bold
        text: 'After (Clear cache first):'
  -
    type: codeBlock
    attrs:
      language: null
    content:
      -
        type: text
        text: |-
          // Clear the cache before mocking
          cache()->forget('mobile_delivery_confirmation');

          LaravelConfig::partialMock()
              ->shouldReceive('get')
              ->with('mobile_delivery_confirmation')
              ->once()
              ->andReturns(false);

          // Now the mock will be triggered
  -
    type: horizontalRule
  -
    type: heading
    attrs:
      textAlign: left
      level: 1
    content:
      -
        type: text
        text: 'Observable Events: The Silent Side Effects'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: "Model observers can wreak havoc on tests. An observer sends a notification. Another updates a related model. A third logs to an external service. None of this is what you're testing."
  -
    type: heading
    attrs:
      textAlign: left
      level: 2
    content:
      -
        type: text
        text: 'Disable by Default'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'In your base '
      -
        type: text
        marks:
          -
            type: code
        text: TestCase
      -
        type: text
        text: ', disable observable events for models that have side effects:'
  -
    type: codeBlock
    attrs:
      language: null
    content:
      -
        type: text
        text: |-
          // In setUp()
          Application::ignoreObservableEvents(['saved', 'created', 'updated']);
          Order::ignoreObservableEvents(['saved', 'updated']);
          Farmer::ignoreObservableEvents(['saved', 'created', 'updated']);
          // ... and so on for ~9+ models
  -
    type: heading
    attrs:
      textAlign: left
      level: 2
    content:
      -
        type: text
        text: 'Re-enable When Testing Observers'
  -
    type: set
    attrs:
      id: mjczbsly
      values:
        type: sidenote
        content:
          -
            type: paragraph
            content:
              -
                type: text
                text: 'Events, notifications, and observers should be opt-in during tests, not opt-out. Your test should control its side effects.'
        style: info
        position: right
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'When you actually need to test observer behavior:'
  -
    type: codeBlock
    attrs:
      language: null
    content:
      -
        type: text
        text: |-
          #[Test]
          public function it_triggers_notification_on_create(): void
          {
              Application::unignoreObservableEvents(['created']);

              // Test the observer...

              Application::ignoreObservableEvents(['created']);  // Clean up
          }
  -
    type: horizontalRule
  -
    type: heading
    attrs:
      textAlign: left
      level: 1
    content:
      -
        type: text
        text: 'HTTP, Events, and Queue Fakes'
  -
    type: heading
    attrs:
      textAlign: left
      level: 2
    content:
      -
        type: text
        text: 'Http::fake() Precedence'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'Order matters. Specific routes first, wildcards last.'
  -
    type: set
    attrs:
      id: mjczetws
      values:
        type: sidenote
        content:
          -
            type: paragraph
            content:
              -
                type: text
                marks:
                  -
                    type: code
                text: 'Http::sequence()'
              -
                type: text
                text: " in parallel tests? You're playing musical chairs with HTTP responses. Don't."
        style: danger
        position: right
  -
    type: codeBlock
    attrs:
      language: null
    content:
      -
        type: text
        text: |-
          Http::fake([
              'api.example.com/users' => Http::response(['users' => []]),
              'api.example.com/*' => Http::response(['status' => 'ok']),
          ]);
  -
    type: heading
    attrs:
      textAlign: left
      level: 2
    content:
      -
        type: text
        text: 'Queue/Bus Fakes'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: "You faked the bus. The job won't run. Its internal mocks are useless."
  -
    type: codeBlock
    attrs:
      language: null
    content:
      -
        type: text
        text: |-
          Bus::fake();

          // Job won't execute - no need to mock its internals
          ProcessOrder::withChain([
              new SendConfirmation(),
              new UpdateInventory()
          ])->dispatch($order);

          // Assert on structure, not execution
          Bus::assertDispatched(ProcessOrder::class, fn ($job) =>
              $job->chained[0] instanceof SendConfirmation
          );
  -
    type: heading
    attrs:
      textAlign: left
      level: 2
    content:
      -
        type: text
        text: 'Partial Fakes'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: "Sometimes you want some jobs to run, sometimes you don't. Be explicit."
  -
    type: codeBlock
    attrs:
      language: null
    content:
      -
        type: text
        text: |-
          // Only fake SpecificJob - let others run
          Bus::fake([SpecificJob::class]);
  -
    type: heading
    attrs:
      textAlign: left
      level: 2
    content:
      -
        type: text
        text: 'Event Fakes'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'Events firing events can get messy. Fake only what you need.'
  -
    type: codeBlock
    attrs:
      language: null
    content:
      -
        type: text
        text: |-
          // Only fake OrderUpdated - let nested events fire
          Event::fake([OrderUpdated::class]);

          $order->update(['status' => 'completed']);

          Event::assertDispatched(OrderUpdated::class);
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'Or use '
      -
        type: text
        marks:
          -
            type: code
        text: fakeFor
      -
        type: text
        text: ' for scoped faking:'
  -
    type: codeBlock
    attrs:
      language: null
    content:
      -
        type: text
        text: |-
          Event::fakeFor(function () use ($order) {
              $order->update(['status' => 'completed']);
              Event::assertDispatched(OrderUpdated::class);
          });
          // Events are real again here
  -
    type: heading
    attrs:
      textAlign: left
      level: 2
    content:
      -
        type: text
        text: 'Timing Matters'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'Fake '
      -
        type: text
        marks:
          -
            type: bold
        text: BEFORE
      -
        type: text
        text: ' you trigger. Always.'
  -
    type: codeBlock
    attrs:
      language: null
    content:
      -
        type: text
        text: |-
          // CORRECT ORDER
          Notification::fake();
          Mail::fake();

          $order = Order::factory()->create();  // afterCreating hooks won't send real notifications
  -
    type: horizontalRule
  -
    type: heading
    attrs:
      textAlign: left
      level: 1
    content:
      -
        type: text
        text: 'Passport Client Patterns'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'Laravel '
      -
        type: text
        marks:
          -
            type: link
            attrs:
              href: 'https://github.com/laravel/passport'
              rel: null
              target: _blank
              title: null
        text: Passport
      -
        type: text
        text: ' requires OAuth clients to be created before authentication tests can work. For full authentication architecture including helper methods and multi-guard setup, see Part 5.'
  -
    type: heading
    attrs:
      textAlign: left
      level: 2
    content:
      -
        type: text
        text: 'The Helper You Need'
  -
    type: codeBlock
    attrs:
      language: null
    content:
      -
        type: text
        text: |-
          // In TestCase.php
          public function createPassportClients(): void
          {
              $countClients = Passport::client()->count();

              // Only create if needed
              if ($countClients >= 5) {
                  return;
              }

              $this->artisan('create:personal-access-clients');
          }
  -
    type: heading
    attrs:
      textAlign: left
      level: 2
    content:
      -
        type: text
        text: 'Always Specify Scopes'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        marks:
          -
            type: bold
        text: 'The Problem:'
      -
        type: text
        text: ' Forgetting to specify scopes results in 403 Forbidden errors.'
  -
    type: set
    attrs:
      id: mjczlgax
      values:
        type: sidenote
        content:
          -
            type: paragraph
            content:
              -
                type: text
                text: "403 Forbidden. No, your endpoint isn't broken. Your token doesn't have the scope. Check your test setup."
        style: tip
        position: right
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        marks:
          -
            type: bold
        text: 'Before (403 Error):'
  -
    type: codeBlock
    attrs:
      language: null
    content:
      -
        type: text
        text: |-
          Passport::actingAsClient(Client::factory()->create());

          $response = $this->getJson(route('accounting.farmers.index'));

          $response->assertForbidden();  // Oops!
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        marks:
          -
            type: bold
        text: 'After (Correct scopes):'
  -
    type: codeBlock
    attrs:
      language: null
    content:
      -
        type: text
        text: |-
          Passport::actingAsClient(
              Client::factory()->create(),
              ['accounting']  // Required scope
          );

          $response = $this->getJson(route('accounting.farmers.index'));

          $response->assertOk();
  -
    type: horizontalRule
  -
    type: heading
    attrs:
      textAlign: left
      level: 1
    content:
      -
        type: text
        text: 'Assertion Patterns'
  -
    type: heading
    attrs:
      textAlign: left
      level: 2
    content:
      -
        type: text
        text: 'Boolean Properties'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        marks:
          -
            type: code
        text: assertTrue($model->is_active)
      -
        type: text
        text: " doesn't test what you think. Type coercion can mask bugs."
  -
    type: codeBlock
    attrs:
      language: null
    content:
      -
        type: text
        text: |-
          // WRONG: Type coercion can mask issues
          $this->assertTrue($application->is_assignable);

          // CORRECT: Exact comparison
          $this->assertSame(true, $application->is_assignable);
          $this->assertSame(true, $orders->contains($order));
  -
    type: heading
    attrs:
      textAlign: left
      level: 2
    content:
      -
        type: text
        text: 'Money Objects'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'Floats are liars. '
      -
        type: text
        marks:
          -
            type: code
        text: '0.10 !== 0.1'
      -
        type: text
        text: ' in floating point land.'
  -
    type: codeBlock
    attrs:
      language: null
    content:
      -
        type: text
        text: |-
          // WRONG: Float comparison nightmares
          $this->assertEquals($expected, $actual);

          // CORRECT: Use Money's comparison
          $this->assertTrue($expectedMoney->isEqualTo($actualMoney));
  -
    type: heading
    attrs:
      textAlign: left
      level: 2
    content:
      -
        type: text
        text: 'Exception Assertions'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        marks:
          -
            type: bold
        text: 'Pattern 1: Use $this->fail() for try/catch'
  -
    type: codeBlock
    attrs:
      language: null
    content:
      -
        type: text
        text: |
          public function it_throws_prevention_exception(): void
          {
              try {
                  FarmerEligibility::check($dto);

                  $this->fail('PreventionException was not thrown');
              } catch (PreventionException $e) {
                  $this->assertEquals('expected', $e->getMessage());
              }
          }
  -
    type: set
    attrs:
      id: mjczog3k
      values:
        type: sidenote
        content:
          -
            type: paragraph
            content:
              -
                type: text
                marks:
                  -
                    type: code
                text: expectException()
              -
                type: text
                text: " is cleaner. The try/catch pattern has its place, but it's not your first choice."
        style: tip
        position: right
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        marks:
          -
            type: bold
        text: 'Pattern 2: Use expectException() (Preferred)'
  -
    type: codeBlock
    attrs:
      language: null
    content:
      -
        type: text
        text: |
          public function it_throws_prevention_exception(): void
          {
              $this->expectException(PreventionException::class);
              $this->expectExceptionMessage('expected');

              FarmerEligibility::check($dto);
          }
  -
    type: horizontalRule
  -
    type: heading
    attrs:
      textAlign: left
      level: 1
    content:
      -
        type: text
        text: 'Risky Test Prevention'
  -
    type: set
    attrs:
      id: mjczqme3
      values:
        type: sidenote
        content:
          -
            type: paragraph
            content:
              -
                type: text
                text: "A test without assertions is not a test. It's a lie you tell CI."
        style: warning
        position: right
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'PHPUnit marks tests as '
      -
        type: text
        marks:
          -
            type: code
        text: risky
      -
        type: text
        text: ' when they have no assertions. This often indicates a problem with the test.'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        marks:
          -
            type: bold
        text: 'Before (Risky - no assertion if exception not thrown):'
  -
    type: codeBlock
    attrs:
      language: null
    content:
      -
        type: text
        text: |-
          #[Test]
          public function it_throws_prevention_exception(): void
          {
              try {
                  FarmerEligibility::check($dto);
              } catch (PreventionException $e) {
                  $this->assertEquals('expected', $e->getMessage());
              }
              // If no exception is thrown, test passes with no assertions = risky!
          }
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        marks:
          -
            type: bold
        text: 'After (Explicit failure if no exception):'
  -
    type: codeBlock
    attrs:
      language: null
    content:
      -
        type: text
        text: |
          #[Test]
          public function it_throws_prevention_exception(): void
          {
              try {
                  FarmerEligibility::check($dto);

                  $this->fail('PreventionException was not thrown');
              } catch (PreventionException $e) {
                  $this->assertEquals('expected', $e->getMessage());
              }
          }
  -
    type: horizontalRule
  -
    type: set
    attrs:
      id: mjczsb6l
      values:
        type: sidenote
        content:
          -
            type: paragraph
            content:
              -
                type: text
                text: '(The Greatest Hits)'
        style: note
        position: right
  -
    type: heading
    attrs:
      textAlign: left
      level: 1
    content:
      -
        type: text
        text: 'Common Pitfalls'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'Print this. Tape it to your monitor.'
  -
    type: orderedList
    attrs:
      start: 1
    content:
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                marks:
                  -
                    type: code
                text: fresh()
              -
                type: text
                marks:
                  -
                    type: bold
                text: ' vs '
              -
                type: text
                marks:
                  -
                    type: code
                text: refresh()
              -
                type: text
                text: ' - Relationships are cached; refresh or reload after mutations.'
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                marks:
                  -
                    type: code
                text: assertDatabaseHas()
              -
                type: text
                marks:
                  -
                    type: bold
                text: ' with JSON'
              -
                type: text
                text: ' - Use arrow syntax ('
              -
                type: text
                marks:
                  -
                    type: code
                text: metadata->key
              -
                type: text
                text: ') or '
              -
                type: text
                marks:
                  -
                    type: code
                text: json_encode
              -
                type: text
                text: ' for full payloads.'
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                marks:
                  -
                    type: code
                text: 'Http::fake()'
              -
                type: text
                marks:
                  -
                    type: bold
                text: ' ordering'
              -
                type: text
                text: ' - Specific first, wildcard last; '
              -
                type: text
                marks:
                  -
                    type: code
                text: sequence()
              -
                type: text
                text: ' can mask earlier fakes.'
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                marks:
                  -
                    type: bold
                text: 'Global scopes'
              -
                type: text
                text: ' - Use '
              -
                type: text
                marks:
                  -
                    type: code
                text: withoutGlobalScope
              -
                type: text
                text: /
              -
                type: text
                marks:
                  -
                    type: code
                text: withTrashed
              -
                type: text
                text: ' when asserting soft-deleted or scoped records.'
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                marks:
                  -
                    type: bold
                text: 'Carbon mutation'
              -
                type: text
                text: ' - '
              -
                type: text
                marks:
                  -
                    type: code
                text: addDays()
              -
                type: text
                text: ' mutates; use '
              -
                type: text
                marks:
                  -
                    type: code
                text: copy()
              -
                type: text
                text: ' or '
              -
                type: text
                marks:
                  -
                    type: code
                text: CarbonImmutable
              -
                type: text
                text: .
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                marks:
                  -
                    type: bold
                text: 'Timestamp precision'
              -
                type: text
                text: ' - If code uses '
              -
                type: text
                marks:
                  -
                    type: code
                text: 'created_at > ...'
              -
                type: text
                text: ' to detect newer records, set explicit '
              -
                type: text
                marks:
                  -
                    type: code
                text: created_at
              -
                type: text
                text: ' in tests (or freeze time).'
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                marks:
                  -
                    type: bold
                text: 'Locale/timezone globals'
              -
                type: text
                text: ' - When asserting translated messages or formatted dates, set locale explicitly and freeze time; reset in '
              -
                type: text
                marks:
                  -
                    type: code
                text: tearDown()
              -
                type: text
                text: .
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                marks:
                  -
                    type: code
                text: assertSee()
              -
                type: text
                marks:
                  -
                    type: bold
                text: ' vs '
              -
                type: text
                marks:
                  -
                    type: code
                text: assertSeeText()
              -
                type: text
                text: ' - First matches raw HTML, second matches rendered text/decoded entities.'
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                marks:
                  -
                    type: bold
                text: 'Database transactions'
              -
                type: text
                text: ' - Always rollback in '
              -
                type: text
                marks:
                  -
                    type: code
                text: finally
              -
                type: text
                text: ' or rely on framework traits to avoid leaking open transactions.'
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                marks:
                  -
                    type: bold
                text: 'Partial fakes'
              -
                type: text
                text: ' - '
              -
                type: text
                marks:
                  -
                    type: code
                text: 'Bus::fake([SpecificJob::class])'
              -
                type: text
                text: ' instead of faking everything when you still need other jobs to run.'
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                marks:
                  -
                    type: bold
                text: 'Factory sequences'
              -
                type: text
                text: ' - '
              -
                type: text
                marks:
                  -
                    type: code
                text: Sequence
              -
                type: text
                text: ' repeats; use a callback with the index for monotonic values.'
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                marks:
                  -
                    type: bold
                text: 'Artisan prompts'
              -
                type: text
                text: ' - Use '
              -
                type: text
                marks:
                  -
                    type: code
                text: expectsQuestion()
              -
                type: text
                text: /
              -
                type: text
                marks:
                  -
                    type: code
                text: expectsConfirmation()
              -
                type: text
                text: ' to keep command tests non-interactive.'
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                marks:
                  -
                    type: bold
                text: 'Events firing events'
              -
                type: text
                text: ' - Fake only what you need so nested events still fire.'
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                marks:
                  -
                    type: bold
                text: 'Alias mocks in parallel'
              -
                type: text
                text: ' - '
              -
                type: text
                marks:
                  -
                    type: code
                text: "Mockery::mock('alias:...')"
              -
                type: text
                text: ' causes '
              -
                type: text
                marks:
                  -
                    type: code
                text: 'class already exists'
              -
                type: text
                text: ' errors; use factory pattern.'
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                marks:
                  -
                    type: bold
                text: 'Readonly class mocking'
              -
                type: text
                text: " - PHP 8.2+ readonly classes can't be extended; use untyped "
              -
                type: text
                marks:
                  -
                    type: code
                text: 'Mockery::mock()'
              -
                type: text
                text: .
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                marks:
                  -
                    type: bold
                text: 'Country/locale globals'
              -
                type: text
                text: ' - Tests expecting country-specific behavior (e.g., '
              -
                type: text
                marks:
                  -
                    type: code
                text: 'Country::TR'
              -
                type: text
                text: ') must set it explicitly in '
              -
                type: text
                marks:
                  -
                    type: code
                text: setUp()
              -
                type: text
                text: ' and reset in '
              -
                type: text
                marks:
                  -
                    type: code
                text: tearDown()
              -
                type: text
                text: '. Consider a trait like '
              -
                type: text
                marks:
                  -
                    type: code
                text: RomaniaEnvironmentTrait
              -
                type: text
                text: ' for multi-country testing.'
  -
    type: horizontalRule
  -
    type: heading
    attrs:
      textAlign: left
      level: 1
    content:
      -
        type: text
        text: 'The Ultimate Checklist'
  -
    type: heading
    attrs:
      textAlign: left
      level: 2
    content:
      -
        type: text
        text: 'Testable Code'
  -
    type: bulletList
    content:
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                text: 'Static method calls wrapped in factory classes for dependency injection'
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                text: 'Controllers/services receive dependencies via constructor injection'
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                text: 'Factory methods have no return types when wrapping readonly classes'
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                text: 'No '
              -
                type: text
                marks:
                  -
                    type: code
                text: '@runInSeparateProcess'
              -
                type: text
                text: ' or '
              -
                type: text
                marks:
                  -
                    type: code
                text: '#[RunInSeparateProcess]'
              -
                type: text
                text: ' (refactor instead)'
  -
    type: heading
    attrs:
      textAlign: left
      level: 2
    content:
      -
        type: text
        text: Mockery
  -
    type: bulletList
    content:
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                marks:
                  -
                    type: code
                text: MockeryPHPUnitIntegration
              -
                type: text
                text: ' trait is in base '
              -
                type: text
                marks:
                  -
                    type: code
                text: TestCase
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                text: 'All mocks have call count expectations ('
              -
                type: text
                marks:
                  -
                    type: code
                text: once()
              -
                type: text
                text: ', '
              -
                type: text
                marks:
                  -
                    type: code
                text: times()
              -
                type: text
                text: ', '
              -
                type: text
                marks:
                  -
                    type: code
                text: never()
              -
                type: text
                text: )
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                text: 'Using '
              -
                type: text
                marks:
                  -
                    type: code
                text: partialMock()
              -
                type: text
                text: ' instead of direct '
              -
                type: text
                marks:
                  -
                    type: code
                text: shouldReceive()
              -
                type: text
                text: ' on facades'
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                text: 'Mocks are conditional for parameterized tests'
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                text: 'No mocks for code inside faked jobs/queues'
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                text: 'Cached config cleared before mocking'
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                marks:
                  -
                    type: bold
                text: 'No alias mocks'
              -
                type: text
                text: ' - use factory pattern instead'
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                text: 'Readonly classes mocked with untyped '
              -
                type: text
                marks:
                  -
                    type: code
                text: 'Mockery::mock()'
              -
                type: text
                text: ' (no class parameter)'
  -
    type: heading
    attrs:
      textAlign: left
      level: 2
    content:
      -
        type: text
        text: 'PHPUnit Mocks'
  -
    type: bulletList
    content:
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                marks:
                  -
                    type: code
                text: createStub()
              -
                type: text
                text: ' used when no verification is needed'
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                marks:
                  -
                    type: code
                text: createMock()
              -
                type: text
                text: ' has '
              -
                type: text
                marks:
                  -
                    type: code
                text: expects()
              -
                type: text
                text: ' when used'
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                text: 'All '
              -
                type: text
                marks:
                  -
                    type: code
                text: onlyMethods
              -
                type: text
                text: ' are stubbed with defaults'
  -
    type: heading
    attrs:
      textAlign: left
      level: 2
    content:
      -
        type: text
        text: DataProviders
  -
    type: bulletList
    content:
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                text: 'DataProvider methods are '
              -
                type: text
                marks:
                  -
                    type: code
                text: static
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                text: 'No '
              -
                type: text
                marks:
                  -
                    type: code
                text: now()
              -
                type: text
                text: ', '
              -
                type: text
                marks:
                  -
                    type: code
                text: config()
              -
                type: text
                text: ', or Laravel facades in DataProviders'
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                text: 'Using string date modifiers (e.g., '
              -
                type: text
                marks:
                  -
                    type: code
                text: "'+30 days'"
              -
                type: text
                text: ') instead of Carbon instances'
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                text: 'Using PHPUnit 10+ '
              -
                type: text
                marks:
                  -
                    type: code
                text: '#[DataProvider()]'
              -
                type: text
                text: ' attribute syntax'
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                text: 'Data sets have descriptive names'
  -
    type: heading
    attrs:
      textAlign: left
      level: 2
    content:
      -
        type: text
        text: 'Test Structure'
  -
    type: bulletList
    content:
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                text: 'Custom cleanup in '
              -
                type: text
                marks:
                  -
                    type: code
                text: tearDown()
              -
                type: text
                text: ' runs '
              -
                type: text
                marks:
                  -
                    type: bold
                text: BEFORE
              -
                type: text
                text: ' '
              -
                type: text
                marks:
                  -
                    type: code
                text: 'parent::tearDown()'
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                text: 'Sushi model cleanup is centralized in TestCase'
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                text: 'Cache cleared before mocking cached config values'
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                text: 'Global scopes considered when asserting'
  -
    type: heading
    attrs:
      textAlign: left
      level: 2
    content:
      -
        type: text
        text: 'Test Data'
  -
    type: bulletList
    content:
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                text: 'No random values affecting test logic'
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                text: 'Fixed, deterministic counts and values'
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                text: 'Correct factory state methods used'
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                marks:
                  -
                    type: code
                text: firstOrCreate()
              -
                type: text
                text: ' for reference data, '
              -
                type: text
                marks:
                  -
                    type: code
                text: factory()
              -
                type: text
                text: ' for test data'
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                text: 'Money units handled correctly (major vs minor)'
  -
    type: heading
    attrs:
      textAlign: left
      level: 2
    content:
      -
        type: text
        text: Time
  -
    type: bulletList
    content:
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                text: 'Time frozen for timestamp-dependent assertions'
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                text: 'Time frozen for business day calculations'
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                text: 'Using '
              -
                type: text
                marks:
                  -
                    type: code
                text: travelTo(now()->startOfMinute())
              -
                type: text
                text: ' for payload comparisons'
  -
    type: heading
    attrs:
      textAlign: left
      level: 2
    content:
      -
        type: text
        text: HTTP/Events/Queue
  -
    type: bulletList
    content:
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                marks:
                  -
                    type: code
                text: 'Http::fake()'
              -
                type: text
                text: ' ordering is specific-before-wildcard'
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                text: 'Queue/Event/Notification fakes set before code runs'
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                text: 'Partial fakes used when other jobs/events must run'
  -
    type: heading
    attrs:
      textAlign: left
      level: 2
    content:
      -
        type: text
        text: Authentication
  -
    type: bulletList
    content:
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                text: 'Passport clients created before auth tests'
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                text: 'Required scopes specified in '
              -
                type: text
                marks:
                  -
                    type: code
                text: actingAsClient()
  -
    type: heading
    attrs:
      textAlign: left
      level: 2
    content:
      -
        type: text
        text: Assertions
  -
    type: bulletList
    content:
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                text: 'Boolean/contains use '
              -
                type: text
                marks:
                  -
                    type: code
                text: 'assertSame(true/false, ...)'
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                text: 'Money compares via '
              -
                type: text
                marks:
                  -
                    type: code
                text: isEqualTo()
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                text: 'Expected exceptions use '
              -
                type: text
                marks:
                  -
                    type: code
                text: expectException()
              -
                type: text
                text: ' or '
              -
                type: text
                marks:
                  -
                    type: code
                text: $this->fail()
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                text: 'No risky tests in the suite'
  -
    type: horizontalRule
  -
    type: heading
    attrs:
      textAlign: left
      level: 1
    content:
      -
        type: text
        text: 'What We Learned'
  -
    type: set
    attrs:
      id: mjczzgzd
      values:
        type: sidenote
        content:
          -
            type: paragraph
            content:
              -
                type: text
                marks:
                  -
                    type: italic
                text: '“It works on my machine”'
              -
                type: text
                text: ' is not a test strategy. "It works in CI, repeatedly, in parallel, in random order" is.'
        style: note
        position: right
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: '300+ commits. 43 alias mocks. Countless flaky tests.'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'The biggest lesson? '
      -
        type: text
        marks:
          -
            type: bold
        text: 'Never ignore a failing test.'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'Every flaky test is a deterministic bug waiting to be found. Every “'
      -
        type: text
        marks:
          -
            type: italic
        text: 'just rerun it”'
      -
        type: text
        text: " is technical debt you're taking on with interest."
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'Your test code is production code. Treat it that way.'
  -
    type: horizontalRule
  -
    type: heading
    attrs:
      textAlign: left
      level: 1
    content:
      -
        type: text
        text: "What's Next"
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: "We've covered the cleanup patterns. But where do all these patterns live?"
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'Part 5: The Foundation will cover the test infrastructure itself:'
  -
    type: bulletList
    content:
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                text: 'The base TestCase architecture'
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                text: 'Trait organization and naming conventions'
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                text: 'Authentication helpers and Passport patterns'
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                text: 'Service faking strategy'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'The foundation that makes everything else work.'
  -
    type: horizontalRule
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        marks:
          -
            type: italic
        text: 'The Flaky Test Chronicles continues. May your CI be green and your reruns be few.'
---
