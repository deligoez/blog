---
id: 6c21b8fe-f221-4bc0-a6b7-4e78d71ac6fc
blueprint: articles
title: 'The Flaky Test Chronicles I: The Reckoning'
updated_by: b8f3533e-0fcf-42b9-a3d8-c8691deaf917
updated_at: 1766095627
og_generator_image: the-flaky-test-chronicles-part-1-the-reckoning.jpg
subtitle: 'Why Your CI Fails at Random'
content:
  -
    type: heading
    attrs:
      textAlign: left
      level: 1
    content:
      -
        type: text
        marks:
          -
            type: bold
        text: 'The PR That Should Have Been Green'
  -
    type: blockquote
    content:
      -
        type: paragraph
        attrs:
          textAlign: left
        content:
          -
            type: text
            text: "Your CI pipeline's success rate shouldn't look like a coin flip simulation."
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'You know the feeling. You pick up a '
      -
        type: text
        marks:
          -
            type: link
            attrs:
              href: 'https://www.atlassian.com/software/jira'
              rel: null
              target: _blank
              title: null
        text: Jira
      -
        type: text
        text: ' ticket. You plan the implementation. You write the code. You even do '
      -
        type: text
        marks:
          -
            type: link
            attrs:
              href: 'https://en.wikipedia.org/wiki/Test-driven_development'
              rel: null
              target: _blank
              title: null
        text: TDD
      -
        type: text
        text: ' - actual test-first development, not the '
      -
        type: text
        marks:
          -
            type: italic
        text: '“I’ll write tests later”'
      -
        type: text
        text: ' kind.'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'Everything works. '
      -
        type: hardBreak
      -
        type: text
        text: 'Tests pass. '
      -
        type: hardBreak
      -
        type: text
        text: 'Coverage looks good. '
      -
        type: hardBreak
      -
        type: text
        text: 'You push to '
      -
        type: text
        marks:
          -
            type: link
            attrs:
              href: 'https://github.com/'
              rel: null
              target: _blank
              title: null
        text: GitHub
      -
        type: text
        text: ', open a PR, and wait for the pipeline.'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'Then the GitHub Actions runner finishes. '
      -
        type: hardBreak
      -
        type: text
        marks:
          -
            type: bold
        text: Red
      -
        type: text
        text: '. '
      -
        type: hardBreak
      -
        type: text
        text: 'Multiple failures.'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: "You check the logs. Some failures are in your new tests - but they passed locally, three times in a row. Others are in tests you've never touched. A payment processing test failed. You changed a notification service. "
      -
        type: text
        marks:
          -
            type: italic
        text: 'How are these even related?'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'You click “'
      -
        type: text
        marks:
          -
            type: italic
        text: 'Re-run failed jobs.”'
      -
        type: text
        text: ' '
      -
        type: hardBreak
      -
        type: text
        text: 'It passes. '
      -
        type: hardBreak
      -
        type: text
        text: 'You merge. '
      -
        type: hardBreak
      -
        type: text
        text: 'You move on.'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'Sound familiar? Of course it does. Every developer has lived this moment. Most of us have lived it hundreds of times.'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'For months, this was our workflow. “Just rerun it” became our unofficial '
      -
        type: text
        marks:
          -
            type: link
            attrs:
              href: 'https://en.wikipedia.org/wiki/Quality_assurance'
              rel: null
              target: _blank
              title: null
        text: QA
      -
        type: text
        text: ' process. '
      -
        type: hardBreak
      -
        type: hardBreak
      -
        type: text
        text: 'PR fails? '
      -
        type: hardBreak
      -
        type: text
        text: 'Rerun. '
      -
        type: hardBreak
      -
        type: text
        text: 'Fails again? '
      -
        type: hardBreak
      -
        type: text
        text: 'Rerun twice. '
      -
        type: hardBreak
      -
        type: text
        text: 'Eventually it passes. '
      -
        type: hardBreak
      -
        type: text
        text: 'Ship it.'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'Then one day, someone actually counted.'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        marks:
          -
            type: bold
        text: '16'
      -
        type: text
        text: ' out of '
      -
        type: text
        marks:
          -
            type: bold
        text: '10,500+'
      -
        type: text
        text: ' tests were playing Russian roulette with our '
      -
        type: text
        marks:
          -
            type: link
            attrs:
              href: 'https://en.wikipedia.org/wiki/Continuous_integration'
              rel: null
              target: _blank
              title: null
        text: CI
      -
        type: text
        text: " pipeline. That's about "
      -
        type: text
        marks:
          -
            type: bold
        text: 0.15%
      -
        type: text
        text: ". Sounds small, right? Here's the thing about "
      -
        type: text
        marks:
          -
            type: bold
        text: 0.15%
      -
        type: text
        text: ": when you run tests hundreds of times a day across a team, you're guaranteed to see these failures. "
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'Every. '
      -
        type: hardBreak
      -
        type: text
        text: 'Single. '
      -
        type: hardBreak
      -
        type: text
        text: Day.
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: '{.sidenote} Senior developer definition: Someone who knows exactly which flaky test to ignore and which one is hiding a production bug waiting for 3 AM. {/sidenote}'
  -
    type: horizontalRule
  -
    type: heading
    attrs:
      textAlign: left
      level: 1
    content:
      -
        type: text
        marks:
          -
            type: bold
        text: 'How Did We Get Here? (A Story of Denial)'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'The path to test suite hell is paved with good intentions and bad habits.'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'It starts innocently. A test fails. You rerun it. It passes. "Must be timing," you think. You don''t investigate. Why would you? You have features to ship, deadlines to meet, and a PM who definitely doesn''t care about your test infrastructure.'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'Then it happens again. And again. And suddenly you have a culture.'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'The culture looks like this:'
  -
    type: bulletList
    content:
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                marks:
                  -
                    type: bold
                text: '"Flaky" becomes a label, not a problem to solve.'
              -
                type: text
                text: ' Tests get marked as flaky and forgotten. The backlog ticket "Fix all flaky tests" has been there since 2019. Nobody touches it.'
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                marks:
                  -
                    type: bold
                text: 'Trust erodes slowly, then all at once.'
              -
                type: text
                text: ' At some point, your team stops believing test failures mean anything. Red CI? Whatever. Merge it. This is when bugs start sneaking through.'
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                marks:
                  -
                    type: bold
                text: 'Merge requests get blocked by tests that have nothing to do with your changes.'
              -
                type: text
                text: " You touched a CSS file. A payment processing test failed. Everyone knows it's unrelated. Everyone clicks rerun anyway. Twenty minutes of CI time, gone."
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                marks:
                  -
                    type: bold
                text: 'Technical debt compounds.'
              -
                type: text
                text: ' Quick fixes mask real issues. Someone adds a '
              -
                type: text
                marks:
                  -
                    type: code
                text: sleep(2)
              -
                type: text
                text: ' to "fix" a race condition. It works, sort of. It also makes your test suite two seconds slower. Multiply that by a thousand tests.'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'We lived in this world for too long.'
  -
    type: horizontalRule
  -
    type: heading
    attrs:
      textAlign: left
      level: 1
    content:
      -
        type: text
        marks:
          -
            type: bold
        text: 'The Numbers That Actually Matter'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: "First, some context. We're talking about a test suite with:"
  -
    type: bulletList
    content:
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                marks:
                  -
                    type: bold
                text: '10,500+ tests'
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                marks:
                  -
                    type: bold
                text: '~40,000 assertions'
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                marks:
                  -
                    type: bold
                text: '~8 minutes'
              -
                type: text
                text: ' CI runtime'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: "That's not a toy project. Changes here ripple."
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: "Here's the thing about test suite statistics: most of them are noise. Test counts go up and down as features ship and code gets deleted. Assertion counts fluctuate with refactoring. In a startup environment where big features ship fast and pivot faster, these numbers tell you almost nothing about test quality."
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'But some numbers matter. These are the ones we tracked:'
  -
    type: table
    content:
      -
        type: tableRow
        content:
          -
            type: tableHeader
            attrs:
              colspan: 1
              rowspan: 1
              colwidth: null
            content:
              -
                type: paragraph
                attrs:
                  textAlign: left
                content:
                  -
                    type: text
                    marks:
                      -
                        type: bold
                    text: Metric
          -
            type: tableHeader
            attrs:
              colspan: 1
              rowspan: 1
              colwidth: null
            content:
              -
                type: paragraph
                attrs:
                  textAlign: left
                content:
                  -
                    type: text
                    marks:
                      -
                        type: bold
                    text: Before
          -
            type: tableHeader
            attrs:
              colspan: 1
              rowspan: 1
              colwidth: null
            content:
              -
                type: paragraph
                attrs:
                  textAlign: left
                content:
                  -
                    type: text
                    marks:
                      -
                        type: bold
                    text: After
      -
        type: tableRow
        content:
          -
            type: tableCell
            attrs:
              colspan: 1
              rowspan: 1
              colwidth: null
            content:
              -
                type: paragraph
                attrs:
                  textAlign: left
                content:
                  -
                    type: text
                    marks:
                      -
                        type: bold
                    text: 'Flaky Failures'
          -
            type: tableCell
            attrs:
              colspan: 1
              rowspan: 1
              colwidth: null
            content:
              -
                type: paragraph
                attrs:
                  textAlign: left
                content:
                  -
                    type: text
                    text: '16'
          -
            type: tableCell
            attrs:
              colspan: 1
              rowspan: 1
              colwidth: null
            content:
              -
                type: paragraph
                attrs:
                  textAlign: left
                content:
                  -
                    type: text
                    text: '0'
      -
        type: tableRow
        content:
          -
            type: tableCell
            attrs:
              colspan: 1
              rowspan: 1
              colwidth: null
            content:
              -
                type: paragraph
                attrs:
                  textAlign: left
                content:
                  -
                    type: text
                    marks:
                      -
                        type: bold
                    text: 'PHPUnit Notices'
          -
            type: tableCell
            attrs:
              colspan: 1
              rowspan: 1
              colwidth: null
            content:
              -
                type: paragraph
                attrs:
                  textAlign: left
                content:
                  -
                    type: text
                    text: '42'
          -
            type: tableCell
            attrs:
              colspan: 1
              rowspan: 1
              colwidth: null
            content:
              -
                type: paragraph
                attrs:
                  textAlign: left
                content:
                  -
                    type: text
                    text: '0'
      -
        type: tableRow
        content:
          -
            type: tableCell
            attrs:
              colspan: 1
              rowspan: 1
              colwidth: null
            content:
              -
                type: paragraph
                attrs:
                  textAlign: left
                content:
                  -
                    type: text
                    marks:
                      -
                        type: bold
                    text: 'Alias Mocks'
          -
            type: tableCell
            attrs:
              colspan: 1
              rowspan: 1
              colwidth: null
            content:
              -
                type: paragraph
                attrs:
                  textAlign: left
                content:
                  -
                    type: text
                    text: '43'
          -
            type: tableCell
            attrs:
              colspan: 1
              rowspan: 1
              colwidth: null
            content:
              -
                type: paragraph
                attrs:
                  textAlign: left
                content:
                  -
                    type: text
                    text: '0'
      -
        type: tableRow
        content:
          -
            type: tableCell
            attrs:
              colspan: 1
              rowspan: 1
              colwidth: null
            content:
              -
                type: paragraph
                attrs:
                  textAlign: left
                content:
                  -
                    type: text
                    marks:
                      -
                        type: bold
                    text: 'Risky Tests'
          -
            type: tableCell
            attrs:
              colspan: 1
              rowspan: 1
              colwidth: null
            content:
              -
                type: paragraph
                attrs:
                  textAlign: left
                content:
                  -
                    type: text
                    text: '12'
          -
            type: tableCell
            attrs:
              colspan: 1
              rowspan: 1
              colwidth: null
            content:
              -
                type: paragraph
                attrs:
                  textAlign: left
                content:
                  -
                    type: text
                    text: '0'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: "Let's talk about what these actually mean."
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        marks:
          -
            type: bold
        text: '16 flaky failures went to zero.'
      -
        type: text
        text: ' These were the tests that passed locally and failed in CI. The ones that "just needed a rerun." Every single one was a real bug - either in the test or in production code. We found the root cause for each.'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        marks:
          -
            type: bold
        text: '42 PHPUnit notices eliminated.'
      -
        type: text
        text: ' These were risky tests - tests without assertions. PHPUnit was literally telling us "this test proves nothing" and we ignored it. A test that doesn''t assert anything is not a test. It''s a lie you tell CI.'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        marks:
          -
            type: bold
        text: '43 alias mocks killed.'
      -
        type: text
        text: ' Every one of them was a parallelization time bomb. We replaced them with the factory pattern (covered in Part 2). This took the most effort but had the biggest impact on CI reliability.'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        marks:
          -
            type: bold
        text: '12 risky tests fixed.'
      -
        type: text
        text: " Tests that ran but didn't actually verify anything. They existed to make coverage numbers look good. They're gone now."
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: "{.note} Don't obsess over total test count or assertion count. Those numbers reflect your codebase size, not your test quality. Focus on failures, notices, and risky tests. Those are the metrics that tell you if your suite is trustworthy. {/note}"
  -
    type: horizontalRule
  -
    type: heading
    attrs:
      textAlign: left
      level: 1
    content:
      -
        type: text
        marks:
          -
            type: bold
        text: 'The Flakiness Rule (Memorize This)'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'If a test fails intermittently, treat it as a '
      -
        type: text
        marks:
          -
            type: bold
        text: 'deterministic bug'
      -
        type: text
        text: '. Period. Full stop. No exceptions.'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'The bug is either:'
  -
    type: bulletList
    content:
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                marks:
                  -
                    type: bold
                text: 'In the test itself:'
              -
                type: text
                text: ' Bad assumptions, global state leaks, time dependencies, race conditions in test setup, or reliance on execution order.'
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                marks:
                  -
                    type: bold
                text: 'In production code:'
              -
                type: text
                text: ' Hidden side effects, non-deterministic database queries, code paths that behave differently under load or timing.'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'There''s no such thing as "just flaky." There are only bugs you haven''t found yet.'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'When someone says "that test is flaky," what they''re really saying is "I don''t know why this fails and I don''t want to find out." And look, I get it. Debugging flaky tests is soul-crushing work. But ignoring them is worse.'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: "Every flaky test is a tiny crack in your test suite's credibility. Enough cracks and the whole thing becomes useless. Why run tests at all if you can't trust the results?"
  -
    type: horizontalRule
  -
    type: heading
    attrs:
      textAlign: left
      level: 1
    content:
      -
        type: text
        marks:
          -
            type: bold
        text: 'The Six Deadly Sins of Flaky Tests'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'Over 300 commits, we cataloged every flaky test we fixed. They all fell into six categories.'
  -
    type: heading
    attrs:
      textAlign: left
      level: 1
    content:
      -
        type: text
        marks:
          -
            type: bold
        text: '1. Time - The Silent Killer'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'Time is the sneakiest cause of flakiness. Your code uses '
      -
        type: text
        marks:
          -
            type: code
        text: now()
      -
        type: text
        text: ', '
      -
        type: text
        marks:
          -
            type: code
        text: today()
      -
        type: text
        text: ', or '
      -
        type: text
        marks:
          -
            type: code
        text: 'Date::parse()'
      -
        type: text
        text: '. Your test runs at 11:59 PM. It passes. Tomorrow it runs at 12:01 AM. It fails. Same code. Same data. Different day.'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        marks:
          -
            type: bold
        text: 'The usual suspects:'
  -
    type: bulletList
    content:
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                text: 'Timestamp comparisons in payloads'
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                text: 'TTL and cache expiration logic'
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                text: 'Business day calculations ("next Wednesday")'
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                text: 'Scheduled jobs and cron-dependent code'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: '{.warning} '
      -
        type: text
        marks:
          -
            type: code
        text: "Date::parse('Today, 17:00')"
      -
        type: text
        text: ' - Nothing says "I enjoy debugging timezone issues at 3 AM" quite like natural language date parsing. Use explicit timestamps: '
      -
        type: text
        marks:
          -
            type: code
        text: "'2025-01-15 17:00:00'"
      -
        type: text
        text: '. Boring, but it works in every timezone and survives daylight saving time. {/warning}'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        marks:
          -
            type: bold
        text: 'The fix:'
      -
        type: text
        text: ' Freeze time.'
  -
    type: codeBlock
    attrs:
      language: null
    content:
      -
        type: text
        text: |
          $this->travelTo(now()->startOfMinute());
          // ... test logic that involves timestamps ...
          $this->travelBack();
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: "Your test now lives in a frozen moment. Time doesn't pass. Timestamps don't drift. Life is predictable. This is the way."
  -
    type: heading
    attrs:
      textAlign: left
      level: 1
    content:
      -
        type: text
        marks:
          -
            type: bold
        text: '2. Randomness - The False Prophet'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: '"I''ll use '
      -
        type: text
        marks:
          -
            type: code
        text: 'faker->numberBetween(2, 5)'
      -
        type: text
        text: ' so my test covers different cases!"'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: "No. No, you won't."
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: "What you've actually done is create a test that sometimes creates 2 records, sometimes 3, sometimes 5. Your assertion expects exactly 3. Congratulations, you've invented chaos engineering without any of the benefits."
  -
    type: codeBlock
    attrs:
      language: null
    content:
      -
        type: text
        text: |
          // This is not testing. This is gambling.
          $orders = Order::factory()
              ->times($this->faker->numberBetween(2, 5))
              ->create();

          $this->assertCount(3, $orders);  // 40% success rate, roughly
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        marks:
          -
            type: bold
        text: 'The fix:'
      -
        type: text
        text: ' Use fixed, deterministic values.'
  -
    type: codeBlock
    attrs:
      language: null
    content:
      -
        type: text
        text: |
          $orders = Order::factory()->times(3)->create();
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'Boring? Yes. Predictable? Also yes. Reliable? Absolutely yes.'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: "If you want to test multiple cases, use a DataProvider. Test all the cases. Explicitly. Don't roll the dice and hope you're covering edge cases."
  -
    type: heading
    attrs:
      textAlign: left
      level: 1
    content:
      -
        type: text
        marks:
          -
            type: bold
        text: '3. Ordering & Timestamp Precision'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: '"I created two records at the same time."'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: "You didn't. You created one record, then nanoseconds later, you created another. Usually this doesn't matter. Sometimes it does."
  -
    type: codeBlock
    attrs:
      language: null
    content:
      -
        type: text
        text: |
          // Production code:
          $hasNewerApplication = $farmer->applications()
              ->where('created_at', '>', $application->created_at)
              ->exists();

          // Test code: create two records "at the same time"
          $app1 = Application::factory()->create();
          $app2 = Application::factory()->create();

          // Surprise: app2->created_at is 3 milliseconds after app1
          // Your boolean just became a coin flip
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        marks:
          -
            type: bold
        text: 'The fix:'
      -
        type: text
        text: ' Set timestamps explicitly.'
  -
    type: codeBlock
    attrs:
      language: null
    content:
      -
        type: text
        text: |
          $createdAt = now()->startOfSecond();

          $applications = Application::factory()
              ->count(2)
              ->create([
                  'created_at' => $createdAt,
                  'updated_at' => $createdAt,
              ]);
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'Now they really are created at the same time. The universe is deterministic again.'
  -
    type: heading
    attrs:
      textAlign: left
      level: 1
    content:
      -
        type: text
        marks:
          -
            type: bold
        text: '4. Global State Leaks'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'The test that works alone but fails when run with others. The classic "it works on my machine, in isolation, when the moon is full" problem.'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        marks:
          -
            type: bold
        text: 'Common culprits:'
  -
    type: bulletList
    content:
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                marks:
                  -
                    type: bold
                text: 'Locale and timezone:'
              -
                type: text
                text: ' Your code formats dates. Another test changed the locale. Your assertions fail.'
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                marks:
                  -
                    type: bold
                text: 'Config cache:'
              -
                type: text
                text: ' You mocked a config value. Another test has cached config. Your mock gets ignored.'
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                marks:
                  -
                    type: bold
                text: 'Eloquent events:'
              -
                type: text
                text: ' A test called '
              -
                type: text
                marks:
                  -
                    type: code
                text: 'Model::unsetEventDispatcher()'
              -
                type: text
                text: '. Your factory relies on a '
              -
                type: text
                marks:
                  -
                    type: code
                text: creating
              -
                type: text
                text: ' event to set defaults. Your model is now incomplete.'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: '{.note} If you must change global state, restore it in '
      -
        type: text
        marks:
          -
            type: code
        text: tearDown()
      -
        type: text
        text: ' in the same test class. Not "eventually." Not "in some other test." Right there. Same file. Don''t make future-you hunt for it. {/note}'
  -
    type: codeBlock
    attrs:
      language: null
    content:
      -
        type: text
        text: |
          // If you do this...
          Model::unsetEventDispatcher();

          // ...you MUST do this in the same test class
          protected function tearDown(): void
          {
              Model::setEventDispatcher($this->app['events']);
              parent::tearDown();
          }
  -
    type: heading
    attrs:
      textAlign: left
      level: 1
    content:
      -
        type: text
        marks:
          -
            type: bold
        text: '5. Parallelization Hazards'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: "Parallel test execution is wonderful until it isn't. The most common failure mode: Mockery alias mocks."
  -
    type: codeBlock
    attrs:
      language: null
    content:
      -
        type: text
        text: |
          Mockery\Exception\RuntimeException: Could not load mock
          App\Services\SomeClass, class already exists
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'This error happens when two parallel tests try to mock the same class using '
      -
        type: text
        marks:
          -
            type: code
        text: "Mockery::mock('alias:...')"
      -
        type: text
        text: ". PHP's autoloader gets confused. Everything breaks. Your CI turns red."
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: "{.sidenote} Alias mocks modify PHP's global class autoloader. When two tests try to do this simultaneously for the same class, they collide. It's not a bug in Mockery. It's a fundamental limitation of how alias mocking works. We'll cover this in gory detail in Part 2. {/sidenote}"
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        marks:
          -
            type: bold
        text: 'The fix:'
      -
        type: text
        text: " Don't use alias mocks. Use the factory pattern instead. We dedicated all of Part 2 to this because we had to kill 43 of them."
  -
    type: heading
    attrs:
      textAlign: left
      level: 1
    content:
      -
        type: text
        marks:
          -
            type: bold
        text: '6. Factories That Depend on Observers'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'Your factory creates a User. An observer fires on create and sets their role. Another test disabled event dispatching. Your User has no role. Your test fails.'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'This is subtle and maddening.'
  -
    type: codeBlock
    attrs:
      language: null
    content:
      -
        type: text
        text: |
          // Another test somewhere called:
          Model::unsetEventDispatcher();

          // Your factory relies on this observer to set the role:
          // UserObserver::creating() { $user->role = UserRole::OWNER; }

          // Now your test creates a User...
          $user = User::factory()->create();

          // ...and the role is null. Test fails.
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        marks:
          -
            type: bold
        text: 'The fix:'
      -
        type: text
        text: " Set critical attributes explicitly in factory states. Don't trust events to run."
  -
    type: codeBlock
    attrs:
      language: null
    content:
      -
        type: text
        text: |
          User::factory()->state(['role' => UserRole::OWNER])->create();
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: "Yes, it's more verbose. Yes, it's more reliable. Pick reliable."
  -
    type: horizontalRule
  -
    type: heading
    attrs:
      textAlign: left
      level: 1
    content:
      -
        type: text
        marks:
          -
            type: bold
        text: 'Practical Patterns (The Stuff That Actually Works)'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'Here are the patterns we use daily. Bookmark this section.'
  -
    type: heading
    attrs:
      textAlign: left
      level: 1
    content:
      -
        type: text
        marks:
          -
            type: bold
        text: 'Freeze Time for Payload Comparisons'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'When comparing serialized data that includes timestamps:'
  -
    type: codeBlock
    attrs:
      language: null
    content:
      -
        type: text
        text: |
          $this->travelTo(now()->startOfMinute());

          $order = Order::factory()->create();
          $expectedPayload = CustomerLoanRequestDTO::fromOrder($order);

          ReportOverdueOrderJob::dispatchSync($order->id);

          // Timestamps match because time is frozen
          $this->assertDatabaseHas('credit_bureau_reports', [
              'payload' => $expectedPayload->toString(),
          ]);

          $this->travelBack();
  -
    type: heading
    attrs:
      textAlign: left
      level: 1
    content:
      -
        type: text
        marks:
          -
            type: bold
        text: 'Stabilize created_at Comparisons'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'When your code checks "is there a newer record?":'
  -
    type: codeBlock
    attrs:
      language: null
    content:
      -
        type: text
        text: |
          $createdAt = now()->startOfSecond();

          $applications = Application::factory()
              ->for($farmer)
              ->count(2)
              ->create([
                  'created_at' => $createdAt,
                  'updated_at' => $createdAt,
              ]);

          // Now the "newer record exists?" check behaves consistently
  -
    type: horizontalRule
  -
    type: heading
    attrs:
      textAlign: left
      level: 1
    content:
      -
        type: text
        marks:
          -
            type: bold
        text: 'How to Verify Your Fix Actually Fixed It'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: "You fixed a flaky test. Or did you? Here's how to be sure."
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        marks:
          -
            type: bold
        text: 'Step 1: Run it many times'
  -
    type: codeBlock
    attrs:
      language: null
    content:
      -
        type: text
        text: |
          for i in {1..100}; do
              php artisan test --filter=it_handles_payment_status || break
          done
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: "If it fails once, you haven't fixed it. You've just made it less frequent."
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        marks:
          -
            type: bold
        text: 'Step 2: Run in random order'
  -
    type: codeBlock
    attrs:
      language: null
    content:
      -
        type: text
        text: |
          php artisan test --order-by=random
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'This exposes global state leaks. If your test only passes when run after some other test, you have a dependency bug.'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        marks:
          -
            type: bold
        text: 'Step 3: Run in parallel'
  -
    type: codeBlock
    attrs:
      language: null
    content:
      -
        type: text
        text: |
          php artisan test --parallel --filter=YourTestClass
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'This exposes parallelization issues. Race conditions. Alias mock collisions. All the fun stuff.'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: "{.note} If it fails once in 100 runs, it's still flaky. You haven't found the root cause. You've just made the odds better. Keep digging. {/note}"
  -
    type: horizontalRule
  -
    type: heading
    attrs:
      textAlign: left
      level: 1
    content:
      -
        type: text
        marks:
          -
            type: bold
        text: 'The Flakiness Checklist'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'Print this. Tape it to your monitor. Use it when writing or reviewing tests.'
  -
    type: bulletList
    content:
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                marks:
                  -
                    type: bold
                text: 'No random values affect test logic or counts.'
              -
                type: text
                text: ' Faker is for names and emails, not for determining how many records to create.'
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                marks:
                  -
                    type: bold
                text: 'Time is frozen when relevant.'
              -
                type: text
                text: ' If your code uses '
              -
                type: text
                marks:
                  -
                    type: code
                text: now()
              -
                type: text
                text: ' anywhere, your test probably needs '
              -
                type: text
                marks:
                  -
                    type: code
                text: travelTo()
              -
                type: text
                text: .
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                marks:
                  -
                    type: bold
                text: 'Time is reset afterwards.'
              -
                type: text
                text: " Don't let frozen time leak to other tests."
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                marks:
                  -
                    type: bold
                text: "Assertions don't rely on implicit ordering."
              -
                type: text
                text: " If order matters, assert it explicitly. If it doesn't, don't assume it."
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                marks:
                  -
                    type: bold
                text: 'Global state changes are restored in '
              -
                type: text
                marks:
                  -
                    type: code
                text: tearDown()
              -
                type: text
                marks:
                  -
                    type: bold
                text: .
              -
                type: text
                text: ' Same test class. Same file. No exceptions.'
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                marks:
                  -
                    type: bold
                text: 'No alias/overload mocks.'
              -
                type: text
                text: ' Not even one. Not even "just this once."'
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                marks:
                  -
                    type: bold
                text: 'Factories set critical attributes explicitly.'
              -
                type: text
                text: " Don't rely on observers that might be disabled."
  -
    type: horizontalRule
  -
    type: heading
    attrs:
      textAlign: left
      level: 1
    content:
      -
        type: text
        marks:
          -
            type: bold
        text: "What's Next"
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'Part 1 was the why. The pain. The anatomy of a flaky test suite.'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: "Part 2 is where Mockery shows its dark side. We had 43 alias mocks across 5 test files. Every single one of them was a ticking time bomb in parallel execution. We'll cover:"
  -
    type: bulletList
    content:
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                text: 'Why alias mocks are fundamentally broken for parallel testing'
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                text: 'The factory pattern that saved us'
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                text: 'Why '
              -
                type: text
                marks:
                  -
                    type: code
                text: '@runInSeparateProcess'
              -
                type: text
                text: " is not a solution (it's a surrender)"
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                text: 'PHPUnit mocks vs Mockery mocks, when to use which'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'See you there. And maybe fix that one flaky test before you continue. You know the one.'
  -
    type: horizontalRule
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        marks:
          -
            type: italic
        text: 'The Flaky Test Chronicles is a series documenting what we learned from 300+ commits of test suite cleanup. May your CI be green and your reruns be few.'
---
