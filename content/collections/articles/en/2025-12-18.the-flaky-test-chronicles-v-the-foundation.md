---
id: c01a33ad-68f5-42cb-a682-de8fdea242ec
blueprint: articles
title: 'The Flaky Test Chronicles V: The Foundation'
subtitle: 'Building a Bulletproof TestCase Architecture'
updated_by: b8f3533e-0fcf-42b9-a3d8-c8691deaf917
updated_at: 1766350875
og_generator_image: the-flaky-test-chronicles-v-the-foundation.jpg
show_toc: true
toc_levels:
  - 1
content:
  -
    type: blockquote
    content:
      -
        type: paragraph
        attrs:
          textAlign: left
        content:
          -
            type: text
            text: 'Your TestCase is the constitution of your test suite. Write it carefully.'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'Every test in your suite inherits from '
      -
        type: text
        marks:
          -
            type: code
        text: TestCase
      -
        type: text
        text: ". Every decision you make there echoes through thousands of tests. Get it right, and testing becomes easier. Get it wrong, and you'll spend weeks debugging cascading failures."
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        marks:
          -
            type: bold
        text: 'What belongs in TestCase:'
  -
    type: bulletList
    content:
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                text: 'Global configuration that NEVER changes per test'
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                text: 'Traits that EVERY test needs'
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                text: "Cleanup that's always required"
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        marks:
          -
            type: bold
        text: "What doesn't belong:"
  -
    type: bulletList
    content:
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                text: 'Setup for specific test types (put in sub-classes or traits)'
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                text: 'Mocks for specific services'
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                text: 'Business logic setup'
  -
    type: horizontalRule
  -
    type: heading
    attrs:
      textAlign: left
      level: 1
    content:
      -
        type: text
        text: 'The '
      -
        type: text
        marks:
          -
            type: code
        text: setUp()
      -
        type: text
        text: ' Anatomy'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'A well-structured '
      -
        type: text
        marks:
          -
            type: code
        text: setUp()
      -
        type: text
        text: ' method reads like a checklist of “'
      -
        type: text
        marks:
          -
            type: italic
        text: 'things I don’t want to think about in every test.”'
  -
    type: heading
    attrs:
      textAlign: left
      level: 2
    content:
      -
        type: text
        text: 'Disable External Dependencies'
  -
    type: set
    attrs:
      id: mjg1sesk
      values:
        type: sidenote
        content:
          -
            type: paragraph
            content:
              -
                type: text
                text: 'Disable middleware globally, re-enable in specific tests with '
              -
                type: text
                marks:
                  -
                    type: code
                text: '$this->withMiddleware(ThrottleRequests::class)'
              -
                type: text
                text: ' when testing rate limiting.'
        style: note
        position: right
  -
    type: codeBlock
    attrs:
      language: null
    content:
      -
        type: text
        text: |-
          protected function setUp(): void
          {
              parent::setUp();

              // No asset bundling in tests
              $this->withoutVite();

              // No rate limiting headaches
              $this->withoutMiddleware(ThrottleRequests::class);
          }
  -
    type: heading
    attrs:
      textAlign: left
      level: 2
    content:
      -
        type: text
        text: 'Configure Test Defaults'
  -
    type: codeBlock
    attrs:
      language: null
    content:
      -
        type: text
        text: |-
          // In setUp()

          // Set default calculation modes
          config(['tarfin.interest_calculation' => InterestCalculation::COMPOUND]);

          // Add domain-specific Faker providers
          $this->faker->addProvider(new TCKimlikProvider($this->faker));

          // Set safe defaults for throttling
          config(['tarfin.throttle_limit' => 1000]);
  -
    type: heading
    attrs:
      textAlign: left
      level: 2
    content:
      -
        type: text
        text: 'Disable Observable Events'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: "Model observers can send notifications, update related records, and call external services. None of that should happen unless you're explicitly testing it."
  -
    type: set
    attrs:
      id: mjg1v7m4
      values:
        type: sidenote
        content:
          -
            type: paragraph
            content:
              -
                type: text
                text: 'This was a game-changer for us. Tests stopped triggering random notifications, stopped updating search indexes, stopped logging to external services.'
        style: note
        position: right
  -
    type: codeBlock
    attrs:
      language: null
    content:
      -
        type: text
        text: |-
          // In setUp()
          Application::ignoreObservableEvents(['saved', 'created', 'updated']);
          Order::ignoreObservableEvents(['saved', 'updated']);
          Farmer::ignoreObservableEvents(['saved', 'created', 'updated']);
          Product::ignoreObservableEvents(['saved', 'created', 'updated']);
          Retailer::ignoreObservableEvents(['saved', 'updated']);
          // ... 9+ models total
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'When you need to test observer behavior, use '
      -
        type: text
        marks:
          -
            type: code
        text: "Model::unignoreObservableEvents(['created'])"
      -
        type: text
        text: '. See Part 4 for the re-enabling pattern.'
  -
    type: horizontalRule
  -
    type: heading
    attrs:
      textAlign: left
      level: 1
    content:
      -
        type: text
        text: 'Trait Organization'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: "Traits are powerful. They're also easy to abuse. Here's how to use them well."
  -
    type: heading
    attrs:
      textAlign: left
      level: 2
    content:
      -
        type: text
        text: 'When to Use Traits'
  -
    type: orderedList
    attrs:
      start: 1
    content:
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                marks:
                  -
                    type: bold
                text: 'Concern is optional'
              -
                type: text
                text: ' - Not every test needs it'
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                marks:
                  -
                    type: bold
                text: 'Has its own lifecycle'
              -
                type: text
                text: ' - Needs setUp/tearDown hooks'
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                marks:
                  -
                    type: bold
                text: 'Reusable across test classes'
              -
                type: text
                text: ' - Multiple tests share the same concern'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        marks:
          -
            type: bold
        text: 'Good candidates:'
  -
    type: bulletList
    content:
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                marks:
                  -
                    type: code
                text: RefreshesSushiModels
              -
                type: text
                text: ' - Only tests using Sushi models with Config mocks'
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                marks:
                  -
                    type: code
                text: RomaniaEnvironmentTrait
              -
                type: text
                text: ' - Only tests for Romanian market'
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                marks:
                  -
                    type: code
                text: HasFormRequestAssertions
              -
                type: text
                text: ' - Only validation tests'
  -
    type: heading
    attrs:
      textAlign: left
      level: 2
    content:
      -
        type: text
        text: "Laravel's Automatic Hook Discovery"
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'Laravel automatically discovers and calls methods named '
      -
        type: text
        marks:
          -
            type: code
        text: setUpXXX()
      -
        type: text
        text: ' and '
      -
        type: text
        marks:
          -
            type: code
        text: tearDownXXX()
      -
        type: text
        text: ' in traits:'
  -
    type: set
    attrs:
      id: mjg1we3g
      values:
        type: sidenote
        content:
          -
            type: paragraph
            content:
              -
                type: text
                text: 'Name your hook methods after the trait ('
              -
                type: text
                marks:
                  -
                    type: code
                text: setUpRefreshesSushiModels
              -
                type: text
                text: ', not '
              -
                type: text
                marks:
                  -
                    type: code
                text: setUpDatabase
              -
                type: text
                text: "). When debugging, you'll immediately know which trait is responsible."
        style: tip
        position: right
  -
    type: codeBlock
    attrs:
      language: null
    content:
      -
        type: text
        text: |-
          trait RefreshesSushiModels
          {
              protected function setUpRefreshesSushiModels(): void
              {
                  $this->resetSushiConnection();
              }

              protected function tearDownRefreshesSushiModels(): void
              {
                  $this->resetSushiConnection();
              }

              private function resetSushiConnection(): void
              {
                  RetailerFastPayableOrder::flushEventListeners();

                  $reflection = new ReflectionClass(RetailerFastPayableOrder::class);
                  $property = $reflection->getProperty('sushiConnection');
                  $property->setAccessible(true);
                  $property->setValue(null, null);

                  RetailerFastPayableOrder::clearBootedModels();
              }
          }
  -
    type: heading
    attrs:
      textAlign: left
      level: 2
    content:
      -
        type: text
        text: 'When to Stay in TestCase'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'Some concerns are truly global:'
  -
    type: bulletList
    content:
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                marks:
                  -
                    type: bold
                text: DatabaseTransactions
              -
                type: text
                text: ' - Every test needs isolation'
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                marks:
                  -
                    type: bold
                text: MockeryPHPUnitIntegration
              -
                type: text
                text: ' - Mockery cleanup is universal'
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                marks:
                  -
                    type: bold
                text: WithFaker
              -
                type: text
                text: ' - Almost every test uses fake data'
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                marks:
                  -
                    type: bold
                text: CreatesApplication
              -
                type: text
                text: ' - Laravel bootstrap'
  -
    type: horizontalRule
  -
    type: heading
    attrs:
      textAlign: left
      level: 1
    content:
      -
        type: text
        text: 'Authentication Patterns'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'Authentication setup is where many tests go wrong. Either they do too much (creating clients in every test) or too little (forgetting scopes).'
  -
    type: heading
    attrs:
      textAlign: left
      level: 2
    content:
      -
        type: text
        text: 'Passport Client Lazy Initialization'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'Create clients only when needed:'
  -
    type: codeBlock
    attrs:
      language: null
    content:
      -
        type: text
        text: |-
          public function createPassportClients(): void
          {
              if (Passport::client()->count() >= 5) {
                  return;  // Already initialized
              }

              $this->artisan('create:personal-access-clients');
          }
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        marks:
          -
            type: bold
        text: 'Old pattern (slow):'
  -
    type: codeBlock
    attrs:
      language: null
    content:
      -
        type: text
        text: |-
          // In TestCase setUp() - runs for EVERY test
          $this->createPassportClients();
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        marks:
          -
            type: bold
        text: 'New pattern (fast):'
  -
    type: codeBlock
    attrs:
      language: null
    content:
      -
        type: text
        text: |
          // Only in tests that need authentication
          $this->createPassportClients();
          $this->actingAsRetailerUser();
  -
    type: heading
    attrs:
      textAlign: left
      level: 2
    content:
      -
        type: text
        text: 'Convenience Authentication Helpers'
  -
    type: codeBlock
    attrs:
      language: null
    content:
      -
        type: text
        text: |-
          protected function actingAsRetailerUser(): self
          {
              $retailer = Retailer::factory()->create();
              $user = RetailerUser::factory()
                  ->for($retailer)
                  ->owner()
                  ->create();

              Passport::actingAs($user, [], 'retailer');

              return $this;
          }

          protected function actingAsFarmer(): self
          {
              $farmer = Farmer::factory()->create();
              Passport::actingAs($farmer, [], 'api_mobile');

              return $this;
          }
  -
    type: heading
    attrs:
      textAlign: left
      level: 2
    content:
      -
        type: text
        text: 'Multi-Guard Setup'
  -
    type: set
    attrs:
      id: mjg241o3
      values:
        type: sidenote
        content:
          -
            type: paragraph
            content:
              -
                type: text
                text: "Always specify scopes. A 403 Forbidden error often means your token doesn't have the required scope, not that your endpoint is broken."
        style: warning
        position: right
  -
    type: codeBlock
    attrs:
      language: null
    content:
      -
        type: text
        text: |-
          // Admin API
          Passport::actingAs($adminUser, ['admin'], 'api');

          // Mobile app
          Passport::actingAs($farmer, [], 'api_mobile');

          // Retailer portal
          Passport::actingAs($retailerUser, ['orders'], 'retailer');
  -
    type: horizontalRule
  -
    type: heading
    attrs:
      textAlign: left
      level: 1
    content:
      -
        type: text
        text: 'Service Faking Strategy'
  -
    type: heading
    attrs:
      textAlign: left
      level: 2
    content:
      -
        type: text
        text: 'The Golden Rule'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'Fake BEFORE factory creation.'
  -
    type: codeBlock
    attrs:
      language: null
    content:
      -
        type: text
        text: |-
          // CORRECT
          Notification::fake();
          Mail::fake();
          $order = Order::factory()->create();  // afterCreating hooks won't send

          // WRONG
          $order = Order::factory()->create();  // afterCreating hooks already sent!
          Notification::fake();  // Too late
  -
    type: heading
    attrs:
      textAlign: left
      level: 2
    content:
      -
        type: text
        text: 'Common Fakes'
  -
    type: table
    content:
      -
        type: tableRow
        content:
          -
            type: tableHeader
            attrs:
              colspan: 1
              rowspan: 1
              colwidth: null
            content:
              -
                type: paragraph
                attrs:
                  textAlign: left
                content:
                  -
                    type: text
                    marks:
                      -
                        type: bold
                    text: Fake
          -
            type: tableHeader
            attrs:
              colspan: 1
              rowspan: 1
              colwidth: null
            content:
              -
                type: paragraph
                attrs:
                  textAlign: left
                content:
                  -
                    type: text
                    marks:
                      -
                        type: bold
                    text: 'Use For'
      -
        type: tableRow
        content:
          -
            type: tableCell
            attrs:
              colspan: 1
              rowspan: 1
              colwidth: null
            content:
              -
                type: paragraph
                attrs:
                  textAlign: left
                content:
                  -
                    type: text
                    marks:
                      -
                        type: code
                    text: 'Http::fake()'
          -
            type: tableCell
            attrs:
              colspan: 1
              rowspan: 1
              colwidth: null
            content:
              -
                type: paragraph
                attrs:
                  textAlign: left
                content:
                  -
                    type: text
                    text: 'External API calls'
      -
        type: tableRow
        content:
          -
            type: tableCell
            attrs:
              colspan: 1
              rowspan: 1
              colwidth: null
            content:
              -
                type: paragraph
                attrs:
                  textAlign: left
                content:
                  -
                    type: text
                    marks:
                      -
                        type: code
                    text: 'Notification::fake()'
          -
            type: tableCell
            attrs:
              colspan: 1
              rowspan: 1
              colwidth: null
            content:
              -
                type: paragraph
                attrs:
                  textAlign: left
                content:
                  -
                    type: text
                    text: 'SMS, email, push notifications'
      -
        type: tableRow
        content:
          -
            type: tableCell
            attrs:
              colspan: 1
              rowspan: 1
              colwidth: null
            content:
              -
                type: paragraph
                attrs:
                  textAlign: left
                content:
                  -
                    type: text
                    marks:
                      -
                        type: code
                    text: 'Queue::fake()'
          -
            type: tableCell
            attrs:
              colspan: 1
              rowspan: 1
              colwidth: null
            content:
              -
                type: paragraph
                attrs:
                  textAlign: left
                content:
                  -
                    type: text
                    text: 'Job dispatch assertions'
      -
        type: tableRow
        content:
          -
            type: tableCell
            attrs:
              colspan: 1
              rowspan: 1
              colwidth: null
            content:
              -
                type: paragraph
                attrs:
                  textAlign: left
                content:
                  -
                    type: text
                    marks:
                      -
                        type: code
                    text: 'Bus::fake()'
          -
            type: tableCell
            attrs:
              colspan: 1
              rowspan: 1
              colwidth: null
            content:
              -
                type: paragraph
                attrs:
                  textAlign: left
                content:
                  -
                    type: text
                    text: 'Command bus assertions'
      -
        type: tableRow
        content:
          -
            type: tableCell
            attrs:
              colspan: 1
              rowspan: 1
              colwidth: null
            content:
              -
                type: paragraph
                attrs:
                  textAlign: left
                content:
                  -
                    type: text
                    marks:
                      -
                        type: code
                    text: 'Event::fake()'
          -
            type: tableCell
            attrs:
              colspan: 1
              rowspan: 1
              colwidth: null
            content:
              -
                type: paragraph
                attrs:
                  textAlign: left
                content:
                  -
                    type: text
                    text: 'Event dispatch assertions'
      -
        type: tableRow
        content:
          -
            type: tableCell
            attrs:
              colspan: 1
              rowspan: 1
              colwidth: null
            content:
              -
                type: paragraph
                attrs:
                  textAlign: left
                content:
                  -
                    type: text
                    marks:
                      -
                        type: code
                    text: "Storage::fake('local')"
          -
            type: tableCell
            attrs:
              colspan: 1
              rowspan: 1
              colwidth: null
            content:
              -
                type: paragraph
                attrs:
                  textAlign: left
                content:
                  -
                    type: text
                    text: 'File operations'
  -
    type: heading
    attrs:
      textAlign: left
      level: 2
    content:
      -
        type: text
        text: 'Partial Fakes'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'Sometimes you want SOME jobs to run, but not others:'
  -
    type: codeBlock
    attrs:
      language: null
    content:
      -
        type: text
        text: |-
          // Only fake these jobs - let others run normally
          Bus::fake([
              SendNotificationJob::class,
              UpdateSearchIndexJob::class,
          ]);
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: "This is better than faking everything and then wondering why your test doesn't work."
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'For advanced patterns including '
      -
        type: text
        marks:
          -
            type: code
        text: 'Http::fake()'
      -
        type: text
        text: ' ordering, '
      -
        type: text
        marks:
          -
            type: code
        text: 'Event::fakeFor()'
      -
        type: text
        text: ", and why you can't mock inside faked jobs, see Part 4."
  -
    type: horizontalRule
  -
    type: heading
    attrs:
      textAlign: left
      level: 1
    content:
      -
        type: text
        text: 'Environment & Locale Testing'
  -
    type: heading
    attrs:
      textAlign: left
      level: 2
    content:
      -
        type: text
        text: 'Country-Specific Tests'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'For multi-country applications, tests must set the country explicitly:'
  -
    type: codeBlock
    attrs:
      language: null
    content:
      -
        type: text
        text: |-
          trait RomaniaEnvironmentTrait
          {
              protected function setUp(): void
              {
                  parent::setUp();
                  Config::set('app.country', Country::RO->value);
              }

              protected function tearDown(): void
              {
                  Config::set('app.country', Country::TR->value);  // Reset to default
                  parent::tearDown();
              }
          }
  -
    type: heading
    attrs:
      textAlign: left
      level: 2
    content:
      -
        type: text
        text: 'Alternative: Set in Test'
  -
    type: set
    attrs:
      id: mjg5mxxg
      values:
        type: sidenote
        content:
          -
            type: paragraph
            content:
              -
                type: text
                text: 'Always reset global state in '
              -
                type: text
                marks:
                  -
                    type: code
                text: tearDown()
              -
                type: text
                text: ' or at the end of test. Otherwise, subsequent tests inherit your configuration.'
        style: note
        position: right
  -
    type: codeBlock
    attrs:
      language: null
    content:
      -
        type: text
        text: |-
          public function it_calculates_romanian_tax(): void
          {
              Country::RO->setCurrent();

              // Test Romanian-specific behavior...
          }
  -
    type: horizontalRule
  -
    type: heading
    attrs:
      textAlign: left
      level: 1
    content:
      -
        type: text
        text: 'Private Member Access'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'Sometimes you need to test private methods or access private properties. Use these sparingly.'
  -
    type: set
    attrs:
      id: mjg5np1u
      values:
        type: sidenote
        content:
          -
            type: paragraph
            content:
              -
                type: text
                text: "If you're testing private methods often, your class might be doing too much. Consider extracting to a separate class with a public API. Test the public interface, not the implementation."
        style: warning
        position: right
  -
    type: codeBlock
    attrs:
      language: null
    content:
      -
        type: text
        text: |-
          protected function invokePrivateMethodForTesting(
              object $object,
              string $methodName,
              array $parameters = []
          ): mixed {
              $reflection = new ReflectionClass($object);
              $method = $reflection->getMethod($methodName);
              $method->setAccessible(true);

              return $method->invokeArgs($object, $parameters);
          }

          protected function getAccessiblePropertyForTesting(
              object $object,
              string $propertyName
          ): mixed {
              $reflection = new ReflectionClass($object);
              $property = $reflection->getProperty($propertyName);
              $property->setAccessible(true);

              return $property->getValue($object);
          }
  -
    type: horizontalRule
  -
    type: heading
    attrs:
      textAlign: left
      level: 1
    content:
      -
        type: text
        text: 'The Evolution We Witnessed'
  -
    type: heading
    attrs:
      textAlign: left
      level: 2
    content:
      -
        type: text
        text: 'From Centralized to Targeted'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        marks:
          -
            type: bold
        text: 'Before:'
      -
        type: text
        text: ' Everything in TestCase tearDown'
  -
    type: codeBlock
    attrs:
      language: null
    content:
      -
        type: text
        text: |-
          protected function tearDown(): void
          {
              $this->refreshSushiModels();
              $this->clearAllCaches();
              $this->resetCountry();
              parent::tearDown();
          }
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        marks:
          -
            type: bold
        text: 'After:'
      -
        type: text
        text: ' Opt-in traits for specific concerns'
  -
    type: codeBlock
    attrs:
      language: null
    content:
      -
        type: text
        text: |-
          class SushiDependentTest extends TestCase
          {
              use RefreshesSushiModels;  // Only when needed
          }
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        marks:
          -
            type: bold
        text: 'Why:'
      -
        type: text
        text: ' Not every test needs Sushi refresh. Targeted cleanup is faster and makes dependencies explicit.'
  -
    type: heading
    attrs:
      textAlign: left
      level: 2
    content:
      -
        type: text
        text: 'From Global to Explicit'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        marks:
          -
            type: bold
        text: 'Before:'
      -
        type: text
        text: ' Setup in every test'
  -
    type: codeBlock
    attrs:
      language: null
    content:
      -
        type: text
        text: |-
          protected function setUp(): void
          {
              parent::setUp();
              $this->createPassportClients();  // Runs for ALL 10,000 tests
          }
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        marks:
          -
            type: bold
        text: 'After:'
      -
        type: text
        text: ' Called only when needed'
  -
    type: codeBlock
    attrs:
      language: null
    content:
      -
        type: text
        text: |
          public function it_requires_authentication(): void
          {
              $this->createPassportClients();
              $this->actingAsRetailerUser();
              // ...
          }
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        marks:
          -
            type: bold
        text: 'Why:'
      -
        type: text
        text: ' Faster tests, clearer dependencies, easier to understand what a test actually needs.'
  -
    type: horizontalRule
  -
    type: heading
    attrs:
      textAlign: left
      level: 1
    content:
      -
        type: text
        text: 'The Foundation Checklist'
  -
    type: heading
    attrs:
      textAlign: left
      level: 2
    content:
      -
        type: text
        marks:
          -
            type: code
        text: TestCase
      -
        type: text
        text: ' Must-Haves'
  -
    type: bulletList
    content:
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                marks:
                  -
                    type: code
                text: MockeryPHPUnitIntegration
              -
                type: text
                text: ' trait for proper mock cleanup'
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                marks:
                  -
                    type: code
                text: DatabaseTransactions
              -
                type: text
                text: ' for test isolation'
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                marks:
                  -
                    type: code
                text: withoutVite()
              -
                type: text
                text: ' to disable asset bundling'
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                marks:
                  -
                    type: code
                text: 'withoutMiddleware(ThrottleRequests::class)'
              -
                type: text
                text: ' to disable rate limiting'
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                text: 'Observable events disabled for common models'
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                text: 'Domain-specific Faker providers registered'
  -
    type: heading
    attrs:
      textAlign: left
      level: 2
    content:
      -
        type: text
        text: 'Trait Guidelines'
  -
    type: bulletList
    content:
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                text: 'Use '
              -
                type: text
                marks:
                  -
                    type: code
                text: setUpXXX()
              -
                type: text
                text: ' / '
              -
                type: text
                marks:
                  -
                    type: code
                text: tearDownXXX()
              -
                type: text
                text: ' naming convention'
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                text: 'Single responsibility per trait'
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                text: 'Document when to use the trait'
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                text: 'Reset global state in tearDown'
  -
    type: heading
    attrs:
      textAlign: left
      level: 2
    content:
      -
        type: text
        text: Authentication
  -
    type: bulletList
    content:
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                text: 'Lazy Passport client creation (not in global setUp)'
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                text: 'Helper methods for common actor types'
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                text: 'Scopes always specified in '
              -
                type: text
                marks:
                  -
                    type: code
                text: actingAs()
  -
    type: heading
    attrs:
      textAlign: left
      level: 2
    content:
      -
        type: text
        text: 'Faking Strategy'
  -
    type: bulletList
    content:
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                text: 'Fake BEFORE factory creation'
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                text: 'Use partial fakes when possible'
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                text: "Don't mock inside faked jobs/queues"
  -
    type: horizontalRule
  -
    type: heading
    attrs:
      textAlign: left
      level: 1
    content:
      -
        type: text
        text: 'Epilogue: Building on Solid Ground'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'Your '
      -
        type: text
        marks:
          -
            type: code
        text: TestCase
      -
        type: text
        text: ' is the foundation of your test suite. Every decision you make there affects thousands of tests.'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'The patterns in this series, from the flakiness rule to the factory pattern to time control, all build on a solid foundation. Get the base right, and everything else becomes easier.'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: '300+ commits. 43 alias mocks. Countless flaky tests. And a TestCase that evolved from "throw everything in setUp" to "make dependencies explicit."'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: "The test that passes locally and fails in CI? That's not a flaky test. That's a bug in your foundation."
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'Build it right.'
  -
    type: horizontalRule
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        marks:
          -
            type: italic
        text: 'The Flaky Test Chronicles concludes with the foundation. May your CI be green and your reruns be few.'
---
