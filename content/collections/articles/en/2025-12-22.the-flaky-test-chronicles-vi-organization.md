---
id: bd2a25e2-28fa-4d95-b8be-74187e727c70
blueprint: articles
title: 'The Flaky Test Chronicles VI: Organization'
subtitle: 'Where Do Your Tests Actually Live?'
show_toc: true
toc_levels:
  - 1
updated_by: b8f3533e-0fcf-42b9-a3d8-c8691deaf917
updated_at: 1766380881
og_generator_image: the-flaky-test-chronicles-vi-organization.jpg
content:
  -
    type: heading
    attrs:
      textAlign: left
      level: 1
    content:
      -
        type: text
        text: 'The "Where''s That Test?" Problem'
  -
    type: blockquote
    content:
      -
        type: paragraph
        attrs:
          textAlign: left
        content:
          -
            type: text
            text: 'A test you can''t find is a test that won''t get maintained.'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'Picture this: someone reports a bug in the '
      -
        type: text
        marks:
          -
            type: code
        text: ApplicationBuilder
      -
        type: text
        text: ' class. You need to check if there''s a test covering that scenario. Simple enough.'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'You open the '
      -
        type: text
        marks:
          -
            type: code
        text: tests/
      -
        type: text
        text: ' directory.'
      -
        type: hardBreak
      -
        type: text
        text: '1,953 files.'
      -
        type: hardBreak
      -
        type: text
        text: 'Where do you even start?'
  -
    type: set
    attrs:
      id: org001
      values:
        type: thought
        content:
          -
            type: paragraph
            content:
              -
                type: text
                text: 'Maybe tests/Unit?'
        position: center-left
  -
    type: set
    attrs:
      id: org002
      values:
        type: thought
        content:
          -
            type: paragraph
            content:
              -
                type: text
                text: 'Or tests/Feature?'
        position: center-right
  -
    type: set
    attrs:
      id: org003
      values:
        type: thought
        content:
          -
            type: paragraph
            content:
              -
                type: text
                text: 'Wait, there''s a tests/Services too...'
        position: center-left
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'You grep for '
      -
        type: text
        marks:
          -
            type: code
        text: ApplicationBuilder
      -
        type: text
        text: '. Three results in different directories. One hasn''t been updated in two years. Another tests something completely different but happens to use the builder. The third... might be what you need?'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'Five minutes gone. You still haven''t found the right test.'
  -
    type: set
    attrs:
      id: org004
      values:
        type: sidenote
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                text: 'The 5-Second Rule: If you can''t find a test in 5 seconds, your organization has failed. The cognitive overhead of hunting for tests compounds into maintenance debt that nobody wants to pay.'
        style: note
        position: right
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'This is the hidden cost of poor test organization. Not flaky tests - '
      -
        type: text
        marks:
          -
            type: italic
        text: 'forgotten'
      -
        type: text
        text: ' tests. Tests that nobody maintains because nobody can find them. Tests that drift out of sync with production code. Tests that pass but prove nothing because the code they tested was refactored months ago.'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'We fixed our flaky tests. Then we realized we had a bigger problem: we couldn''t find half of them.'
  -
    type: horizontalRule
  -
    type: heading
    attrs:
      textAlign: left
      level: 1
    content:
      -
        type: text
        text: 'The Anatomy of 2,000 Tests'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'Before we dive into structure, let me give you some context about the project we''re talking about.'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'This codebase started on '
      -
        type: text
        marks:
          -
            type: bold
        text: 'December 24, 2018'
      -
        type: text
        text: ' - yes, Christmas Eve. Since then:'
  -
    type: bulletList
    content:
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                marks:
                  -
                    type: bold
                text: '56,987 commits'
              -
                type: text
                text: ' from 9 developers over 6 years'
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                marks:
                  -
                    type: bold
                text: '733,104 lines of code'
              -
                type: text
                text: ' across 16,175 files'
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                marks:
                  -
                    type: bold
                text: '5,864 classes'
              -
                type: text
                text: ', 255 enums, 23,276 methods'
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                text: 'Evolved from '
              -
                type: text
                marks:
                  -
                    type: bold
                text: 'PHP 7.1 to 8.5'
              -
                type: text
                text: ' and '
              -
                type: text
                marks:
                  -
                    type: bold
                text: 'Laravel 5.7 to 12'
  -
    type: set
    attrs:
      id: org-stats-1
      values:
        type: sidenote
        content:
          -
            type: paragraph
            content:
              -
                type: text
                text: 'Stats generated with '
              -
                type: text
                marks:
                  -
                    type: link
                    attrs:
                      href: 'https://github.com/tomasVotruba/lines'
                      rel: null
                      target: _blank
                      title: null
                text: lines
              -
                type: text
                text: ' by Tomas Votruba (creator of Rector). If you want to understand your codebase''s complexity, it''s an excellent tool.'
        style: note
        position: right
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'That upgrade path represents '
      -
        type: text
        marks:
          -
            type: bold
        text: '9 PHP upgrades'
      -
        type: text
        text: ' (7.1 → 7.2 → 7.3 → 7.4 → 8.0 → 8.1 → 8.2 → 8.3 → 8.4 → 8.5) and '
      -
        type: text
        marks:
          -
            type: bold
        text: '7 Laravel major versions'
      -
        type: text
        text: ' (5.7 → 5.8 → 6 → 7 → 8 → 9 → 10 → 11 → 12). Each upgrade requires updating dependencies, fixing deprecations, and rewriting incompatible code.'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'We don''t let upgrades pile up. When a new PHP or Laravel version drops, we upgrade within weeks - not months, not years. That speed is only possible because our test suite catches breaking changes immediately. A flaky test suite makes upgrades terrifying. A reliable one makes them routine.'
  -
    type: set
    attrs:
      id: org-stats-2
      values:
        type: sidenote
        content:
          -
            type: paragraph
            content:
              -
                type: text
                text: 'We also maintain several open-source packages extracted from this codebase at '
              -
                type: text
                marks:
                  -
                    type: link
                    attrs:
                      href: 'https://github.com/tarfin-labs'
                      rel: null
                      target: _blank
                      title: null
                text: TarfinLabs
              -
                type: text
                text: '. The patterns in this series come from real production code that we actively maintain and share with the community.'
        style: note
        position: right
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'The test suite itself:'
  -
    type: bulletList
    content:
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                marks:
                  -
                    type: bold
                text: '1,953 test files'
              -
                type: text
                text: ' containing '
              -
                type: text
                marks:
                  -
                    type: bold
                text: '10,251 test methods'
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                marks:
                  -
                    type: bold
                text: '363,373 lines'
              -
                type: text
                text: ' - nearly half the codebase is tests'
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                marks:
                  -
                    type: bold
                text: '10,021 PHPUnit attributes'
              -
                type: text
                text: ' (we fully embraced PHP 8 syntax)'
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                marks:
                  -
                    type: bold
                text: '8,839 named arguments'
              -
                type: text
                text: ' (readability matters in tests)'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'This isn''t a side project. This is '
      -
        type: text
        marks:
          -
            type: link
            attrs:
              href: 'https://tarfin.com'
              rel: null
              target: _blank
              title: null
        text: Tarfin
      -
        type: text
        text: ' - Europe''s leading fintech platform for farmer agri-input financing. Thousands of farmers across Turkey and Romania use our platform to purchase seeds, fertilizers, feed, and equipment with flexible payment terms. We serve 75+ cities, work with 1,200+ retailers, and process real financial transactions where bugs have real consequences.'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'Here''s what our test directory actually looks like:'
  -
    type: codeBlock
    attrs:
      language: null
    content:
      -
        type: text
        text: |-
          tests/
          ├── Unit/           552 files
          ├── Feature/        438 files
          ├── Services/       634 files
          ├── Machines/       308 files
          ├── Traits/         helper traits
          ├── Mocks/          mock classes
          ├── Files/          test fixtures
          ├── ModelFactories/ factory helpers
          └── TestCase.php    base class

          Total: 1,953 test files
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'Notice something? This isn''t the standard Laravel '
      -
        type: text
        marks:
          -
            type: code
        text: Unit/
      -
        type: text
        text: ' and '
      -
        type: text
        marks:
          -
            type: code
        text: Feature/
      -
        type: text
        text: ' split anymore. We have '
      -
        type: text
        marks:
          -
            type: code
        text: Services/
      -
        type: text
        text: ' and '
      -
        type: text
        marks:
          -
            type: code
        text: Machines/
      -
        type: text
        text: ' as top-level directories.'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'This is what happens when a test suite '
      -
        type: text
        marks:
          -
            type: italic
        text: grows
      -
        type: text
        text: '. The traditional split breaks down around 200-300 tests. By 500, it''s unusable. By 1,000, you need a new approach.'
  -
    type: set
    attrs:
      id: org005
      values:
        type: sidenote
        content:
          -
            type: paragraph
            content:
              -
                type: text
                text: 'The Laravel default of Unit/Feature works beautifully for small to medium projects. But when your Services directory in app/ has 59 subdirectories and your Machines have their own complex hierarchy, forcing everything into Unit/ creates chaos.'
        style: note
        position: right
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'We evolved into a '
      -
        type: text
        marks:
          -
            type: bold
        text: 'hybrid approach'
      -
        type: text
        text: ':'
  -
    type: bulletList
    content:
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                marks:
                  -
                    type: bold
                text: Unit/
              -
                type: text
                text: ' - Traditional unit tests for Models, Enums, Casts, Rules'
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                marks:
                  -
                    type: bold
                text: Feature/
              -
                type: text
                text: ' - HTTP tests organized by domain (Admin, Mobile, Retailer)'
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                marks:
                  -
                    type: bold
                text: Services/
              -
                type: text
                text: ' - Domain-specific service tests (634 files!)'
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                marks:
                  -
                    type: bold
                text: Machines/
              -
                type: text
                text: ' - State machine tests (308 files)'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'This structure wasn''t designed. It '
      -
        type: text
        marks:
          -
            type: italic
        text: emerged
      -
        type: text
        text: '. And emergent structures, without intentional maintenance, accumulate debt.'
  -
    type: horizontalRule
  -
    type: heading
    attrs:
      textAlign: left
      level: 1
    content:
      -
        type: text
        text: 'The Three Laws of Test Organization'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'After cleaning up our mess, we crystallized three principles that would have prevented most of it.'
  -
    type: heading
    attrs:
      textAlign: left
      level: 2
    content:
      -
        type: text
        text: 'Law 1: Mirror Your App Structure'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'The simplest rule, and the one we violated constantly:'
  -
    type: blockquote
    content:
      -
        type: paragraph
        attrs:
          textAlign: left
        content:
          -
            type: text
            text: 'A test should live in the same relative path as the code it tests.'
  -
    type: codeBlock
    attrs:
      language: null
    content:
      -
        type: text
        text: |-
          # Good: Perfect mirroring
          app/Builders/ApplicationBuilder.php
          tests/Unit/Builders/ApplicationBuilderTest.php

          app/Services/FarmerDocument/DTOs/CksReportDTO.php
          tests/Services/FarmerDocument/DTOs/CksReportDTOTest.php

          app/Machines/Application/Guards/HasValidScoreGuard.php
          tests/Machines/Application/Guards/HasValidScoreGuardTest.php
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'When the structure mirrors, navigation becomes instant. See a file in '
      -
        type: text
        marks:
          -
            type: code
        text: app/Something/
      -
        type: text
        text: '? The test is in '
      -
        type: text
        marks:
          -
            type: code
        text: tests/Something/
      -
        type: text
        text: '. No guessing. No grepping. No five-minute hunts.'
  -
    type: set
    attrs:
      id: org006
      values:
        type: sidenote
        content:
          -
            type: paragraph
            content:
              -
                type: text
                text: 'IDE navigation becomes trivial with mirrored structures. Most editors let you jump between test and implementation with a single shortcut. But only if the paths match.'
        style: note
        position: right
  -
    type: heading
    attrs:
      textAlign: left
      level: 2
    content:
      -
        type: text
        text: 'Law 2: One Home Per Test Type'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'Every category of test should have exactly one canonical location. Not two. Not "'
      -
        type: text
        marks:
          -
            type: italic
        text: 'either here or there."'
      -
        type: text
        text: ' One.'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'Here''s what we found in our codebase:'
  -
    type: codeBlock
    attrs:
      language: null
    content:
      -
        type: text
        text: |-
          # Model tests scattered across THREE locations
          tests/Unit/Model/ApplicationTest.php    ← 155 files here
          tests/Unit/Models/FindeksVysBeanTest.php  ← 2 files here
          tests/Unit/ApplicationTest.php          ← 30 loose files here
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'Same type of test. Three different homes. '
  -
    type: set
    attrs:
      id: org007
      values:
        type: thought
        content:
          -
            type: paragraph
            content:
              -
                type: text
                text: 'Is it Model or Models?'
        position: center-left
  -
    type: set
    attrs:
      id: org008
      values:
        type: thought
        content:
          -
            type: paragraph
            content:
              -
                type: text
                text: 'Yes.'
        position: center-right
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'This happens when different developers follow different conventions. Someone creates '
      -
        type: text
        marks:
          -
            type: code
        text: Model/
      -
        type: text
        text: ' (singular). Someone else creates '
      -
        type: text
        marks:
          -
            type: code
        text: Models/
      -
        type: text
        text: ' (plural). A third person doesn''t bother with subdirectories at all. Nobody notices because tests still pass.'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        marks:
          -
            type: bold
        text: 'The fix:'
      -
        type: text
        text: ' Pick one. Migrate. Enforce. Delete the alternatives.'
  -
    type: heading
    attrs:
      textAlign: left
      level: 2
    content:
      -
        type: text
        text: 'Law 3: Domain Directories Deserve Top-Level'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'When a domain grows large enough, it deserves its own top-level directory in '
      -
        type: text
        marks:
          -
            type: code
        text: tests/
      -
        type: text
        text: '.'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'Our '
      -
        type: text
        marks:
          -
            type: code
        text: app/Services/
      -
        type: text
        text: ' has 59 subdirectories. Stuffing 634 service tests into '
      -
        type: text
        marks:
          -
            type: code
        text: tests/Unit/Services/
      -
        type: text
        text: ' would create a nightmare. So '
      -
        type: text
        marks:
          -
            type: code
        text: tests/Services/
      -
        type: text
        text: ' became its own top-level directory.'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'Same with state machines. Our '
      -
        type: text
        marks:
          -
            type: code
        text: app/Machines/
      -
        type: text
        text: ' is a critical architectural component with 308 tests. It earned its place as '
      -
        type: text
        marks:
          -
            type: code
        text: tests/Machines/
      -
        type: text
        text: '.'
  -
    type: set
    attrs:
      id: org009
      values:
        type: sidenote
        content:
          -
            type: paragraph
            content:
              -
                type: text
                text: 'The threshold for top-level promotion: When you''d have more than 50 test files in a subdirectory, consider promoting it. When navigating that subdirectory becomes painful, definitely promote it.'
        style: note
        position: right
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        marks:
          -
            type: bold
        text: 'Decision framework:'
  -
    type: bulletList
    content:
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                text: '< 20 tests: Keep in Unit/ or Feature/'
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                text: '20-50 tests: Consider a dedicated subdirectory'
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                text: '50+ tests: Promote to top-level'
  -
    type: horizontalRule
  -
    type: heading
    attrs:
      textAlign: left
      level: 1
    content:
      -
        type: text
        text: 'The Organizational Debt Catalog'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'Let me show you exactly what we found. These aren''t hypotheticals. These are real issues from our real codebase.'
  -
    type: heading
    attrs:
      textAlign: left
      level: 2
    content:
      -
        type: text
        text: 'The Singular/Plural Split'
  -
    type: codeBlock
    attrs:
      language: null
    content:
      -
        type: text
        text: |-
          tests/Unit/Model/     ← 155 test files (singular)
          tests/Unit/Models/    ← 2 test files   (plural)
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: '155 files in one directory. 2 files in another. Both testing models. Both "correct" in isolation.'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'How does this happen? Developer A creates '
      -
        type: text
        marks:
          -
            type: code
        text: Model/
      -
        type: text
        text: ' following the singular convention. Three months later, Developer B sees '
      -
        type: text
        marks:
          -
            type: code
        text: app/Models/
      -
        type: text
        text: ' and creates '
      -
        type: text
        marks:
          -
            type: code
        text: tests/Unit/Models/
      -
        type: text
        text: ' to match. Nobody notices. Code review focuses on the test logic, not the directory name.'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'Fast forward: You need to find a model test. You check '
      -
        type: text
        marks:
          -
            type: code
        text: Models/
      -
        type: text
        text: '. Not there. You give up. Actually, it''s in '
      -
        type: text
        marks:
          -
            type: code
        text: Model/
      -
        type: text
        text: '. Or maybe loose in '
      -
        type: text
        marks:
          -
            type: code
        text: Unit/
      -
        type: text
        text: '.'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        marks:
          -
            type: bold
        text: 'The fix:'
  -
    type: codeBlock
    attrs:
      language: null
    content:
      -
        type: text
        text: |-
          # 1. Pick a winner (we chose singular to match Laravel conventions)
          # 2. Move the stragglers
          mv tests/Unit/Models/* tests/Unit/Model/

          # 3. Delete the empty directory
          rmdir tests/Unit/Models/

          # 4. Add a CI check to prevent recreation
  -
    type: heading
    attrs:
      textAlign: left
      level: 2
    content:
      -
        type: text
        text: 'Loose Files at Root'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'We found 30 test files sitting directly in '
      -
        type: text
        marks:
          -
            type: code
        text: tests/Unit/
      -
        type: text
        text: ':'
  -
    type: codeBlock
    attrs:
      language: null
    content:
      -
        type: text
        text: |-
          tests/Unit/
          ├── AchievementTest.php
          ├── ActivityTest.php
          ├── ApplicationTest.php
          ├── BankAccountTest.php
          ├── CampaignTest.php
          ├── CommentsTest.php
          ├── DocumentTest.php
          ├── GoalTest.php
          ├── OrderTest.php
          ├── ProductTest.php
          ├── SystemNoficationTest.php  ← Note the typo!
          └── ... 19 more loose files
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'These are all model tests. They belong in '
      -
        type: text
        marks:
          -
            type: code
        text: tests/Unit/Model/
      -
        type: text
        text: '. But someone created them at the root, probably in a hurry, probably planning to move them later. '
      -
        type: text
        marks:
          -
            type: italic
        text: Later never came.
  -
    type: set
    attrs:
      id: org010
      values:
        type: sidenote
        content:
          -
            type: paragraph
            content:
              -
                type: text
                text: 'The worst part: some of these loose files duplicate tests that exist in Model/. ApplicationTest.php exists in both places, testing slightly different things, neither knowing about the other.'
        style: note
        position: right
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        marks:
          -
            type: bold
        text: 'Why this happens:'
  -
    type: bulletList
    content:
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                text: 'Quick fix mentality - "I''ll organize it later"'
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                text: 'Copy-paste from another loose file'
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                text: 'Didn''t know the convention'
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                text: 'Code review didn''t catch it'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        marks:
          -
            type: bold
        text: 'The fix:'
  -
    type: codeBlock
    attrs:
      language: null
    content:
      -
        type: text
        text: |-
          # Find all loose test files
          ls tests/Unit/*.php | grep -v TestCase

          # Move each to proper location
          for file in ApplicationTest OrderTest CampaignTest; do
              mv "tests/Unit/${file}.php" "tests/Unit/Model/"
          done

          # Update namespaces in moved files
  -
    type: heading
    attrs:
      textAlign: left
      level: 2
    content:
      -
        type: text
        text: 'The Ghost Directory'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'This one''s subtle but dangerous:'
  -
    type: codeBlock
    attrs:
      language: null
    content:
      -
        type: text
        text: |-
          tests/Machines/           ← 308 test files (current structure)
          tests/Unit/Machines/      ← 3 test files   (ghost from old structure)
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'At some point, we decided state machine tests deserved their own top-level directory. We created '
      -
        type: text
        marks:
          -
            type: code
        text: tests/Machines/
      -
        type: text
        text: ' and started putting new tests there. 308 of them.'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'But we never finished the migration. Three old tests still linger in '
      -
        type: text
        marks:
          -
            type: code
        text: tests/Unit/Machines/
      -
        type: text
        text: '. Forgotten. Unmaintained. Probably testing code that''s been refactored three times since.'
  -
    type: set
    attrs:
      id: org011
      values:
        type: thought
        content:
          -
            type: paragraph
            content:
              -
                type: text
                text: 'Three files? That''s nothing.'
        position: center-left
  -
    type: set
    attrs:
      id: org012
      values:
        type: thought
        content:
          -
            type: paragraph
            content:
              -
                type: text
                text: 'Three files that new developers will find and copy from. Three files that signal "tests can go here." The ghost becomes the template.'
        position: center-right
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        marks:
          -
            type: bold
        text: 'The fix:'
      -
        type: text
        text: ' Complete the migration. Move the 3 files to '
      -
        type: text
        marks:
          -
            type: code
        text: tests/Machines/
      -
        type: text
        text: '. Delete the ghost directory entirely.'
  -
    type: heading
    attrs:
      textAlign: left
      level: 2
    content:
      -
        type: text
        text: 'The Typo That Hides Tests'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'Sometimes the problem isn''t structure - it''s spelling.'
  -
    type: codeBlock
    attrs:
      language: null
    content:
      -
        type: text
        text: |-
          tests/Unit/SystemNoficationTest.php

          class SystemNoficationTest extends TestCase  // "Nofication"?
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'Notice it? '
      -
        type: text
        marks:
          -
            type: code
        text: Nofication
      -
        type: text
        text: ' instead of '
      -
        type: text
        marks:
          -
            type: code
        text: Notification
      -
        type: text
        text: '. A single missing "ti" that makes this test invisible to anyone searching for "notification tests."'
  -
    type: set
    attrs:
      id: org-typo
      values:
        type: sidenote
        content:
          -
            type: paragraph
            content:
              -
                type: text
                text: 'The typo exists in both the filename AND the class name. Someone copy-pasted the mistake, and code review caught neither. This test has existed for years without anyone noticing.'
        style: note
        position: right
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'Typos in test names are particularly insidious because:'
  -
    type: bulletList
    content:
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                text: 'Tests still run - PHPUnit doesn''t care about spelling'
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                text: 'IDE autocomplete works if you''ve opened the file before'
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                text: 'Grep and search fail silently - you just don''t find what you''re looking for'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        marks:
          -
            type: bold
        text: 'The fix:'
      -
        type: text
        text: ' Rename both the file and the class. Add a spellcheck to your CI pipeline for test file names.'
  -
    type: heading
    attrs:
      textAlign: left
      level: 2
    content:
      -
        type: text
        text: 'The Casing Trap'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'This one will bite you on case-sensitive file systems:'
  -
    type: codeBlock
    attrs:
      language: null
    content:
      -
        type: text
        text: |-
          tests/Services/TarfinSms/Stubs/     ← Uppercase "Stubs"
          tests/Services/FarmerDocument/stubs/ ← Lowercase "stubs"
          tests/Services/CreditBureau/stubs/   ← Lowercase "stubs"
          tests/Services/Keysfin/stubs/        ← Lowercase "stubs"
          ... 7 more lowercase stubs/ directories
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'Ten services use lowercase '
      -
        type: text
        marks:
          -
            type: code
        text: stubs/
      -
        type: text
        text: '. One service uses uppercase '
      -
        type: text
        marks:
          -
            type: code
        text: Stubs/
      -
        type: text
        text: '. On macOS, you won''t notice. On Linux CI servers? Your tests might fail to find their fixture files.'
  -
    type: set
    attrs:
      id: org-casing
      values:
        type: thought
        content:
          -
            type: paragraph
            content:
              -
                type: text
                text: 'It works on my machine!'
        position: center-left
  -
    type: set
    attrs:
      id: org-casing-2
      values:
        type: thought
        content:
          -
            type: paragraph
            content:
              -
                type: text
                text: 'CI runs on Linux.'
        position: center-right
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        marks:
          -
            type: bold
        text: 'The fix:'
      -
        type: text
        text: ' Pick a convention (we use lowercase for non-class directories like '
      -
        type: text
        marks:
          -
            type: code
        text: stubs/
      -
        type: text
        text: ') and enforce it everywhere.'
  -
    type: heading
    attrs:
      textAlign: left
      level: 2
    content:
      -
        type: text
        text: 'The Naming Mismatch'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'Remember Law 1: Mirror Your App Structure? Here''s what happens when you don''t:'
  -
    type: codeBlock
    attrs:
      language: null
    content:
      -
        type: text
        text: |-
          app/Http/Middleware/      ← Singular
          tests/Unit/Middlewares/   ← Plural

          # You're testing Middleware, but looking in Middlewares.
          # Or vice versa.
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'The app uses '
      -
        type: text
        marks:
          -
            type: code
        text: Middleware
      -
        type: text
        text: ' (singular). The tests use '
      -
        type: text
        marks:
          -
            type: code
        text: Middlewares
      -
        type: text
        text: ' (plural). Your mental model breaks. You search for the wrong thing. You create tests in the wrong place.'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        marks:
          -
            type: bold
        text: 'The fix:'
      -
        type: text
        text: ' Test directory names must exactly match app directory names. No exceptions.'
  -
    type: heading
    attrs:
      textAlign: left
      level: 2
    content:
      -
        type: text
        text: 'Helpers at Root'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'Not just tests get disorganized - helper files do too:'
  -
    type: codeBlock
    attrs:
      language: null
    content:
      -
        type: text
        text: |-
          tests/
          ├── TestCase.php                        ← Base class (fine here)
          ├── AdminTestCase.php                   ← Specialized base (fine)
          ├── CreatesApplication.php              ← Bootstrap trait (fine)
          ├── GeneratesRetailersWithDistances.php ← Should be in Traits/
          ├── PrepareAddressData.php              ← Should be in Traits/
          └── Traits/
              ├── HasFormRequestAssertions.php
              └── RefreshesPassportClients.php
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'Two helper traits live at the root level. Four others live in '
      -
        type: text
        marks:
          -
            type: code
        text: Traits/
      -
        type: text
        text: '. When you need a helper trait, where do you look? Where do you add a new one?'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        marks:
          -
            type: bold
        text: 'The fix:'
      -
        type: text
        text: ' Move all helper traits to '
      -
        type: text
        marks:
          -
            type: code
        text: tests/Traits/
      -
        type: text
        text: '. Keep only base TestCase classes at root.'
  -
    type: horizontalRule
  -
    type: heading
    attrs:
      textAlign: left
      level: 1
    content:
      -
        type: text
        text: 'The TestCase.php Foundation'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'Organization isn''t just about directories. It''s about infrastructure. Here''s what our base '
      -
        type: text
        marks:
          -
            type: code
        text: TestCase
      -
        type: text
        text: ' looks like:'
  -
    type: codeBlock
    attrs:
      language: null
    content:
      -
        type: text
        text: |-
          abstract class TestCase extends BaseTestCase
          {
              use CreatesApplication;
              use DatabaseTransactions;
              use WithFaker;
              use AdditionalAssertions;
              use MockeryPHPUnitIntegration;  // Critical for parallel tests
              use HasFormRequestAssertions;

              protected function setUp(): void
              {
                  parent::setUp();

                  $this->withoutVite();

                  // Disable observers that cause side effects
                  Application::ignoreObservableEvents(['saved', 'created', 'updated']);
                  Order::ignoreObservableEvents(['saved', 'updated']);
                  Farmer::ignoreObservableEvents(['saved', 'created', 'updated']);
                  // ... 12 more models

                  $this->withoutMiddleware(ThrottleRequests::class);
              }

              // Convenience auth helpers
              public function actingAsRetailerUser(?Retailer $retailer = null): Retailer
              {
                  // ...
              }

              public function actingAsFarmer(?Farmer $farmer = null): Farmer
              {
                  // ...
              }
          }
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'Key patterns here:'
  -
    type: bulletList
    content:
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                marks:
                  -
                    type: bold
                text: MockeryPHPUnitIntegration
              -
                type: text
                text: ' - Required for Mockery to work correctly with PHPUnit (covered in Part 2)'
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                marks:
                  -
                    type: bold
                text: ignoreObservableEvents
              -
                type: text
                text: ' - Prevents side effects during test setup (covered in Part 4)'
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                marks:
                  -
                    type: bold
                text: 'Convenience auth helpers'
              -
                type: text
                text: ' - Reduce boilerplate in tests that need authentication'
  -
    type: set
    attrs:
      id: org013
      values:
        type: sidenote
        content:
          -
            type: paragraph
            content:
              -
                type: text
                text: 'Notice the 15 models with ignored events. Each one was added after we traced a flaky test to an observer firing during factory creation. The base TestCase is a graveyard of lessons learned.'
        style: note
        position: right
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'Where do supporting files go?'
  -
    type: codeBlock
    attrs:
      language: null
    content:
      -
        type: text
        text: |-
          tests/
          ├── TestCase.php                     ← Base class, root level
          ├── AdminTestCase.php                ← Specialized base, root level
          ├── CreatesApplication.php           ← Bootstrap trait, root level
          ├── Traits/                          ← Helper traits
          │   ├── HasFormRequestAssertions.php
          │   └── RefreshesPassportClients.php
          ├── Mocks/                           ← Mock implementations
          └── ModelFactories/                  ← Complex factory helpers
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'The rule: Base classes at root. Everything else in typed directories.'
  -
    type: horizontalRule
  -
    type: heading
    attrs:
      textAlign: left
      level: 1
    content:
      -
        type: text
        text: 'Practical Fixes'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'You''ve seen the problems. Here''s how to fix them.'
  -
    type: heading
    attrs:
      textAlign: left
      level: 2
    content:
      -
        type: text
        text: 'The Consolidation Script'
  -
    type: codeBlock
    attrs:
      language: null
    content:
      -
        type: text
        text: |-
          #!/bin/bash

          # Find loose model tests
          echo "Loose tests in Unit/:"
          ls tests/Unit/*.php 2>/dev/null | grep -v TestCase | grep -v AdminTestCase

          # Find singular/plural conflicts
          echo -e "\nModel vs Models conflict:"
          echo "Model/ count: $(find tests/Unit/Model -name '*.php' 2>/dev/null | wc -l)"
          echo "Models/ count: $(find tests/Unit/Models -name '*.php' 2>/dev/null | wc -l)"

          # Find ghost directories
          echo -e "\nPotential ghost directories:"
          for dir in Machines Services; do
              if [ -d "tests/Unit/$dir" ] && [ -d "tests/$dir" ]; then
                  echo "Both tests/Unit/$dir and tests/$dir exist"
              fi
          done
  -
    type: heading
    attrs:
      textAlign: left
      level: 2
    content:
      -
        type: text
        text: 'CI Enforcement'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'Prevention beats cure. Add checks to your CI pipeline:'
  -
    type: codeBlock
    attrs:
      language: null
    content:
      -
        type: text
        text: |-
          # .github/workflows/test-organization.yml
          - name: Check for loose test files
            run: |
              loose=$(ls tests/Unit/*.php 2>/dev/null | grep -v TestCase | grep -v AdminTestCase || true)
              if [ -n "$loose" ]; then
                echo "Found loose test files in tests/Unit/:"
                echo "$loose"
                exit 1
              fi

          - name: Check for Models/ directory (should be Model/)
            run: |
              if [ -d "tests/Unit/Models" ]; then
                echo "Error: tests/Unit/Models/ exists. Use tests/Unit/Model/ instead."
                exit 1
              fi
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'Now organizational debt can''t sneak in through pull requests.'
  -
    type: horizontalRule
  -
    type: heading
    attrs:
      textAlign: left
      level: 1
    content:
      -
        type: text
        text: 'The Organization Checklist'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'Run through this quarterly, or whenever your test suite feels unwieldy:'
  -
    type: bulletList
    content:
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                marks:
                  -
                    type: bold
                text: 'All model tests in '
              -
                type: text
                marks:
                  -
                    type: bold
                  -
                    type: code
                text: tests/Unit/Model/
              -
                type: text
                text: ' (singular, not plural)'
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                marks:
                  -
                    type: bold
                text: 'No loose test files at directory roots'
              -
                type: text
                text: ' - every test in a subdirectory'
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                marks:
                  -
                    type: bold
                text: 'Domain directories mirror app structure'
              -
                type: text
                text: ' - tests/Services/ matches app/Services/'
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                marks:
                  -
                    type: bold
                text: 'No duplicate/ghost directories'
              -
                type: text
                text: ' - each test type has exactly one home'
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                marks:
                  -
                    type: bold
                text: 'Helper traits in '
              -
                type: text
                marks:
                  -
                    type: bold
                  -
                    type: code
                text: tests/Traits/
              -
                type: text
                text: ' - not scattered across the codebase'
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                marks:
                  -
                    type: bold
                text: 'Stubs co-located with their tests'
              -
                type: text
                text: ' - tests/Something/stubs/ not somewhere random'
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                marks:
                  -
                    type: bold
                text: 'CI enforces organization rules'
              -
                type: text
                text: ' - can''t merge disorganized tests'
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                marks:
                  -
                    type: bold
                text: 'No typos in test file names'
              -
                type: text
                text: ' - spellcheck your test names'
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                marks:
                  -
                    type: bold
                text: 'Consistent casing in directory names'
              -
                type: text
                text: ' - stubs/ not Stubs/'
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                marks:
                  -
                    type: bold
                text: 'Test directory names match app exactly'
              -
                type: text
                text: ' - Middleware/ not Middlewares/'
  -
    type: horizontalRule
  -
    type: heading
    attrs:
      textAlign: left
      level: 1
    content:
      -
        type: text
        text: 'The End of the Chronicles'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'Six parts. 300+ commits. Zero flaky tests remaining.'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'We started with a test suite that was a coin flip. We ended with one that passes first time, every time.'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'What did it take?'
  -
    type: bulletList
    content:
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                marks:
                  -
                    type: bold
                text: 'Part 1:'
              -
                type: text
                text: ' Recognized the problem. Adopted the mindset that flaky means broken.'
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                marks:
                  -
                    type: bold
                text: 'Part 2:'
              -
                type: text
                text: ' Killed 43 alias mocks. Embraced the factory pattern.'
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                marks:
                  -
                    type: bold
                text: 'Part 3:'
              -
                type: text
                text: ' Froze time. Banned randomness. Made tests deterministic.'
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                marks:
                  -
                    type: bold
                text: 'Part 4:'
              -
                type: text
                text: ' Fixed tearDown order. Cleaned up properly. Wrote assertions that mean something.'
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                marks:
                  -
                    type: bold
                text: 'Part 5:'
              -
                type: text
                text: ' Built a TestCase foundation that prevents problems by default.'
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                marks:
                  -
                    type: bold
                text: 'Part 6:'
              -
                type: text
                text: ' Organized the chaos. Made tests findable and maintainable.'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'The patterns in these articles aren''t theoretical. They''re battle-tested across 10,500+ tests and nearly 2,000 test files. They work.'
  -
    type: set
    attrs:
      id: org014
      values:
        type: sidenote
        content:
          -
            type: paragraph
            content:
              -
                type: text
                text: 'Test maintenance isn''t glamorous work. It doesn''t ship features. It doesn''t impress stakeholders. But it''s the foundation that makes everything else possible. A team that can trust their tests moves faster than one that can''t.'
        style: note
        position: right
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'If you''re staring at a flaky test suite, know this: it can be fixed. One test at a time. One pattern at a time. One commit at a time.'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'Start today. Your future self will thank you.'
  -
    type: horizontalRule
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        marks:
          -
            type: italic
        text: 'The Flaky Test Chronicles documents what we learned from 300+ commits of test suite cleanup. May your CI be green, your tests be findable, and your reruns be none.'
---
