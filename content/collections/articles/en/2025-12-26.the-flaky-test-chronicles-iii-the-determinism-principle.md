---
id: 5d9a03d6-6f6e-475f-adc2-956131aaab36
published: false
blueprint: articles
title: 'The Flaky Test Chronicles III: The Determinism Principle'
subtitle: 'Time, Randomness, and Predictable Test Data'
updated_by: b8f3533e-0fcf-42b9-a3d8-c8691deaf917
updated_at: 1766750846
og_generator_image: the-flaky-test-chronicles-iii-the-determinism-principle.jpg
show_toc: true
toc_levels:
  - 1
display_date: '2025-12-26'
content:
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'In '
      -
        type: text
        marks:
          -
            type: link
            attrs:
              href: /articles/the-flaky-test-chronicles-ii-mock-madness
              target: null
        text: 'Part 2'
      -
        type: text
        text: ", we conquered Mockery's alias and overload mocks. Now we face an even more fundamental challenge: "
      -
        type: text
        marks:
          -
            type: bold
        text: determinism
      -
        type: text
        text: .
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'A deterministic test produces the same result every time it runs. Same inputs, same outputs, no surprises. But several forces conspire against determinism:'
  -
    type: bulletList
    content:
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                marks:
                  -
                    type: bold
                text: Time
              -
                type: text
                text: ' - Milliseconds pass between operations'
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                marks:
                  -
                    type: bold
                text: Randomness
              -
                type: text
                text: ' - Faker values change every run'
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                marks:
                  -
                    type: bold
                text: 'Data order'
              -
                type: text
                text: ' - Database records with identical timestamps'
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                marks:
                  -
                    type: bold
                text: 'Factory states'
              -
                type: text
                text: ' - Implicit defaults that vary'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'This part covers techniques to make your tests predictable and repeatable.'
  -
    type: horizontalRule
  -
    type: heading
    attrs:
      textAlign: left
      level: 1
    content:
      -
        type: text
        text: 'The Timestamp Trap'
  -
    type: blockquote
    content:
      -
        type: paragraph
        attrs:
          textAlign: left
        content:
          -
            type: text
            text: 'The test passed at 11:59 PM. It failed at midnight. '
      -
        type: paragraph
        attrs:
          textAlign: left
        content:
          -
            type: text
            text: 'Same code.  Same data. '
      -
        type: paragraph
        attrs:
          textAlign: left
        content:
          -
            type: text
            text: 'Different universe.'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'The most insidious flaky tests are time-related. The code works correctly. The test looks reasonable. It passes locally. It fails in CI at random.'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'You spend hours debugging. Then you realize: '
      -
        type: text
        marks:
          -
            type: bold
        text: 'millisecond differences'
      -
        type: text
        text: .
  -
    type: codeBlock
    attrs:
      language: null
    content:
      -
        type: text
        text: |-
          #[Test]
          public function it_creates_order_report(): void
          {
              $order = Order::factory()->create();

              $expectedPayload = OrderReportDTO::fromOrder($order);

              ProcessOrderJob::dispatchSync($order->id);

              // FAILS: payload timestamps differ by milliseconds
              $this->assertDatabaseHas('order_reports', [
                  'payload' => $expectedPayload->toString(),
              ]);
          }
  -
    type: set
    attrs:
      id: mjcwfxtg
      values:
        type: sidenote
        content:
          -
            type: paragraph
            content:
              -
                type: text
                text: 'JSON timestamps are the ultimate betrayal. '
              -
                type: hardBreak
              -
                type: text
                marks:
                  -
                    type: code
                text: '2025-01-15T10:30:00.000Z'
              -
                type: text
                text: ' and '
              -
                type: hardBreak
              -
                type: text
                marks:
                  -
                    type: code
                text: '2025-01-15T10:30:00.003Z'
              -
                type: text
                text: ' look similar. They are not equal.'
        style: warning
        position: right
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'When '
      -
        type: text
        marks:
          -
            type: code
        text: $expectedPayload
      -
        type: text
        text: ' is created, timestamp is '
      -
        type: text
        marks:
          -
            type: code
        text: X
      -
        type: text
        text: '. When the job runs, timestamp is '
      -
        type: text
        marks:
          -
            type: code
        text: 'Y'
      -
        type: text
        text: ". The difference is 3 milliseconds. JSON payloads don't match. Test fails."
  -
    type: horizontalRule
  -
    type: heading
    attrs:
      textAlign: left
      level: 1
    content:
      -
        type: text
        text: 'When to Freeze Time'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'Situations where you need to freeze time:'
  -
    type: orderedList
    attrs:
      start: 1
    content:
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                marks:
                  -
                    type: bold
                text: 'Payload/DTO comparisons'
              -
                type: text
                text: ' - Timestamps in serialized data'
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                marks:
                  -
                    type: bold
                text: 'Business day calculations'
              -
                type: text
                text: ' - When day of week matters'
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                marks:
                  -
                    type: bold
                text: 'Date-dependent assertions'
              -
                type: text
                text: ' - '
              -
                type: text
                marks:
                  -
                    type: italic
                text: '“Created today”,'
              -
                type: text
                text: ' “'
              -
                type: text
                marks:
                  -
                    type: italic
                text: 'Expires in 30 days”'
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                marks:
                  -
                    type: bold
                text: 'Scheduling tests'
              -
                type: text
                text: ' - Cron jobs, delayed jobs'
  -
    type: horizontalRule
  -
    type: heading
    attrs:
      textAlign: left
      level: 1
    content:
      -
        type: text
        text: 'The Five Methods of Time Control'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'Laravel provides powerful tools for controlling time.'
  -
    type: heading
    attrs:
      textAlign: left
      level: 2
    content:
      -
        type: text
        text: 'Method 1: Simple Freeze'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'The most basic approach. '
      -
        type: text
        marks:
          -
            type: code
        text: startOfMinute()
      -
        type: text
        text: ' eliminates millisecond differences.'
  -
    type: codeBlock
    attrs:
      language: null
    content:
      -
        type: text
        text: |-
          $this->travelTo(now()->startOfMinute());

          // All now() calls return the frozen time
          $order = Order::factory()->create();

          $this->assertEquals(now(), $order->created_at);
  -
    type: heading
    attrs:
      textAlign: left
      level: 2
    content:
      -
        type: text
        text: 'Method 2: Freeze to Specific Day'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'When day of week matters:'
  -
    type: codeBlock
    attrs:
      language: null
    content:
      -
        type: text
        text: |-
          // Freeze to next Monday for day-of-week dependent tests
          $this->travelTo(now()->next('Monday'));

          $paymentDate = $merchant->getNextPaymentDate();

          $this->assertEquals(now()->next('Wednesday'), $paymentDate);
  -
    type: heading
    attrs:
      textAlign: left
      level: 2
    content:
      -
        type: text
        text: 'Method 3: Freeze with Callback'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'Time is frozen only within the callback:'
  -
    type: codeBlock
    attrs:
      language: null
    content:
      -
        type: text
        text: |-
          // Time is frozen only within the callback
          $this->travelTo(now()->subDay(), function () {
              $this->getJson('middleware-test-route')->assertOk();
          });

          // Time is back to normal here
  -
    type: heading
    attrs:
      textAlign: left
      level: 2
    content:
      -
        type: text
        text: 'Method 4: Travel Back Explicitly'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'When you want to handle cleanup yourself:'
  -
    type: set
    attrs:
      id: mjcwmont
      values:
        type: sidenote
        content:
          -
            type: paragraph
            content:
              -
                type: text
                text: 'Prefer '
              -
                type: text
                marks:
                  -
                    type: code
                text: $this->travelTo(...)
              -
                type: text
                text: '. However, if the code under test uses '
              -
                type: text
                marks:
                  -
                    type: code
                text: Illuminate\Support\Facades\Date
              -
                type: text
                text: ' directly (e.g., '
              -
                type: text
                marks:
                  -
                    type: code
                text: 'Date::parse()'
              -
                type: text
                text: ', '
              -
                type: text
                marks:
                  -
                    type: code
                text: today()
              -
                type: text
                text: '), freeze via the facade.'
        style: info
        position: right
  -
    type: paragraph
    attrs:
      textAlign: left
  -
    type: codeBlock
    attrs:
      language: null
    content:
      -
        type: text
        text: |-
          $this->travelTo(now()->next('Monday'));

          // ... test logic ...

          $this->travelBack();  // Restore original time
  -
    type: heading
    attrs:
      textAlign: left
      level: 2
    content:
      -
        type: text
        text: 'Method 5: Date::setTestNow()'
  -
    type: set
    attrs:
      id: mjcwnlau
      values:
        type: sidenote
        content:
          -
            type: paragraph
            content:
              -
                type: text
                text: 'Avoid natural language parsing like '
              -
                type: text
                marks:
                  -
                    type: code
                text: "Date::parse('Today, 17:00')->subHours(1)"
              -
                type: text
                text: '. Timezone and DST (daylight saving time) changes can lead to unexpected results. Prefer fixed timestamps.'
        style: tip
        position: right
  -
    type: codeBlock
    attrs:
      language: null
    content:
      -
        type: text
        text: |-
          use Illuminate\Support\Facades\Date;

          Date::setTestNow(Date::parse('2025-12-15 12:51:25'));

          // ... test logic ...

          Date::setTestNow(); // Always reset (see Part 4 for tearDown ordering)
  -
    type: horizontalRule
  -
    type: heading
    attrs:
      textAlign: left
      level: 1
    content:
      -
        type: text
        text: 'The '
      -
        type: text
        marks:
          -
            type: code
        text: created_at
      -
        type: text
        text: ' > Nightmare'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'Tests can become flaky when code checks “'
      -
        type: text
        marks:
          -
            type: italic
        text: 'does a newer record exist?”'
      -
        type: text
        text: ' and the test creates multiple related records back-to-back. Millisecond differences between records can flip the boolean result.'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        marks:
          -
            type: bold
        text: 'Before (Flaky):'
  -
    type: codeBlock
    attrs:
      language: null
    content:
      -
        type: text
        text: |-
          // Code under test:
          // $hasNewerSubmission = $user->submissions()
          //     ->where('created_at', '>', $submission->created_at)
          //     ->exists();

          $submissions = Submission::factory()
              ->for($user)
              ->sequence(
                  ['channel' => ChannelType::Web],
                  ['channel' => ChannelType::Mobile],
              )
              ->rejected()
              ->count(2)
              ->create();

          // Depending on tiny timestamp differences, the "web" submission
          // can be filtered out.
  -
    type: set
    attrs:
      id: mjcwpi4p
      values:
        type: sidenote
        content:
          -
            type: paragraph
            content:
              -
                type: text
                text: 'This problem becomes more pronounced in parallel CI runs. Records created within the same second sometimes have the same timestamp, sometimes different.'
        style: note
        position: right
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        marks:
          -
            type: bold
        text: 'After (Stable):'
  -
    type: codeBlock
    attrs:
      language: null
    content:
      -
        type: text
        text: |-
          $createdAt = now()->startOfSecond();

          $submissions = Submission::factory()
              ->for($user)
              ->sequence(
                  ['channel' => ChannelType::Web],
                  ['channel' => ChannelType::Mobile],
              )
              ->rejected()
              ->count(2)
              ->create([
                  'created_at' => $createdAt,
                  'updated_at' => $createdAt,
              ]);

          // Verify all records have the same timestamp
          $this->assertCount(
              1,
              $submissions
                  ->pluck('created_at')
                  ->map(fn ($d) => $d->format('Y-m-d H:i:s'))
                  ->unique()
          );
  -
    type: horizontalRule
  -
    type: heading
    attrs:
      textAlign: left
      level: 1
    content:
      -
        type: text
        text: 'Real-World Example: Overdue Order'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        marks:
          -
            type: bold
        text: 'Before (Flaky - timestamp mismatch):'
  -
    type: codeBlock
    attrs:
      language: null
    content:
      -
        type: text
        text: |-
          public function it_creates_order_report(): void
          {
              $order = Order::factory()->create();

              $expectedPayload = OrderReportDTO::fromOrder($order);

              ProcessOrderJob::dispatchSync($order->id);

              // FAILS: payload timestamps differ by milliseconds
              $this->assertDatabaseHas('order_reports', [
                  'payload' => $expectedPayload->toString(),
              ]);
          }
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        marks:
          -
            type: bold
        text: 'After (Stable - time frozen):'
  -
    type: set
    attrs:
      id: mjcxej9g
      values:
        type: sidenote
        content:
          -
            type: paragraph
            content:
              -
                type: text
                marks:
                  -
                    type: code
                text: startOfMinute()
              -
                type: text
                text: ' is usually sufficient. For tests requiring second precision, use '
              -
                type: text
                marks:
                  -
                    type: code
                text: startOfSecond()
              -
                type: text
                text: .
        style: tip
        position: right
  -
    type: codeBlock
    attrs:
      language: null
    content:
      -
        type: text
        text: |-
          public function it_creates_order_report(): void
          {
              // Freeze time at the start of minute for consistent timestamps
              $this->travelTo(now()->startOfMinute());

              $order = Order::factory()->create();

              $expectedPayload = OrderReportDTO::fromOrder($order);

              ProcessOrderJob::dispatchSync($order->id);

              // PASSES: timestamps are identical
              $this->assertDatabaseHas('order_reports', [
                  'payload' => $expectedPayload->toString(),
              ]);
          }
  -
    type: horizontalRule
  -
    type: heading
    attrs:
      textAlign: left
      level: 1
    content:
      -
        type: text
        text: 'The Randomness Illusion'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'Random values in tests might seem like a good idea. “'
      -
        type: text
        marks:
          -
            type: italic
        text: 'It’ll catch edge cases,”'
      -
        type: text
        text: ' you think. But they actually cause more problems than they solve.'
  -
    type: heading
    attrs:
      textAlign: left
      level: 2
    content:
      -
        type: text
        text: 'Why Random Values Hurt'
  -
    type: codeBlock
    attrs:
      language: null
    content:
      -
        type: text
        text: |-
          // This creates flaky tests
          $orders = Order::factory()
              ->times($this->faker->numberBetween(2, 5))
              ->create();

          // Assertions may fail randomly
          $this->assertCount(3, $orders);  // Might be 2, 3, 4, or 5!
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        marks:
          -
            type: bold
        text: 'Problems:'
  -
    type: orderedList
    attrs:
      start: 1
    content:
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                marks:
                  -
                    type: bold
                text: 'Flaky tests'
              -
                type: text
                text: ' - Same test passes/fails depending on random values'
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                marks:
                  -
                    type: bold
                text: 'Hard to debug'
              -
                type: text
                text: " - Can't consistently reproduce failures"
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                marks:
                  -
                    type: bold
                text: 'Misleading coverage'
              -
                type: text
                text: ' - Test might not actually cover all cases'
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                marks:
                  -
                    type: bold
                text: 'CI instability'
              -
                type: text
                text: ' - Random failures erode trust in test suite'
  -
    type: heading
    attrs:
      textAlign: left
      level: 2
    content:
      -
        type: text
        text: 'The Solution: Deterministic Values'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        marks:
          -
            type: bold
        text: 'Before:'
  -
    type: codeBlock
    attrs:
      language: null
    content:
      -
        type: text
        text: |-
          $orders = Order::factory()
              ->times($this->faker->numberBetween(2, 5))
              ->create();

          $status = $this->faker->randomElement([
              PaymentStatus::DRAFT,
              PaymentStatus::PARTLY_PAID,
              PaymentStatus::FULLY_PAID,
          ]);
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        marks:
          -
            type: bold
        text: 'After:'
  -
    type: codeBlock
    attrs:
      language: null
    content:
      -
        type: text
        text: |-
          $orders = Order::factory()
              ->times(3)  // Fixed count
              ->create();

          $status = PaymentStatus::DRAFT;  // Specific status
  -
    type: heading
    attrs:
      textAlign: left
      level: 2
    content:
      -
        type: text
        text: 'Use DataProviders Instead'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'Instead of randomness, use '
      -
        type: text
        marks:
          -
            type: code
        text: DataProviders
      -
        type: text
        text: ' to test multiple cases deterministically:'
  -
    type: codeBlock
    attrs:
      language: null
    content:
      -
        type: text
        text: |-
          #[DataProvider('paymentStatuses')]
          #[Test]
          public function it_handles_payment_status(PaymentStatus $status): void
          {
              $order = Order::factory()->create([
                  'payment_status' => $status,
              ]);

              // Test each status deterministically
          }

          public static function paymentStatuses(): iterable
          {
              yield 'draft' => [PaymentStatus::DRAFT];
              yield 'partly paid' => [PaymentStatus::PARTLY_PAID];
              yield 'fully paid' => [PaymentStatus::FULLY_PAID];
          }
  -
    type: heading
    attrs:
      textAlign: left
      level: 2
    content:
      -
        type: text
        text: 'When Random IS Acceptable'
  -
    type: set
    attrs:
      id: mjcxhz7y
      values:
        type: sidenote
        content:
          -
            type: paragraph
            content:
              -
                type: text
                text: "Random data that doesn't affect assertions is fine. Random data that affects test logic is not."
        style: warning
        position: right
  -
    type: paragraph
    attrs:
      textAlign: left
  -
    type: codeBlock
    attrs:
      language: null
    content:
      -
        type: text
        text: |-
          // OK: Random data that doesn't affect assertions
          $user = User::factory()->create([
              'name' => $this->faker->name(),  // Doesn't matter for test
          ]);

          // NOT OK: Random data that affects test logic
          $order = Order::factory()->create([
              'total' => $this->faker->numberBetween(1000, 5000),  // Affects assertions!
          ]);
  -
    type: horizontalRule
  -
    type: heading
    attrs:
      textAlign: left
      level: 1
    content:
      -
        type: text
        text: 'DataProvider Deep Dive'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: "PHPUnit's DataProvider feature is powerful but has subtleties that can lead to unexpected behavior."
  -
    type: heading
    attrs:
      textAlign: left
      level: 2
    content:
      -
        type: text
        text: 'The Boot Order Problem'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        marks:
          -
            type: bold
        text: 'DataProviders run BEFORE Laravel boots.'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'This means:'
  -
    type: bulletList
    content:
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                marks:
                  -
                    type: code
                text: now()
              -
                type: text
                text: ' returns a regular Carbon instance, not the immutable version configured in your service provider'
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                text: "Application configuration isn't available"
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                text: "Dependency injection doesn't work"
  -
    type: set
    attrs:
      id: mjcxo7qi
      values:
        type: sidenote
        content:
          -
            type: paragraph
            content:
              -
                type: text
                text: "Don't use "
              -
                type: text
                marks:
                  -
                    type: code
                text: now()
              -
                type: text
                text: ', '
              -
                type: text
                marks:
                  -
                    type: code
                text: config()
              -
                type: text
                text: ', '
              -
                type: text
                marks:
                  -
                    type: code
                text: app()
              -
                type: text
                text: " in DataProviders - Laravel hasn't booted yet!"
        style: tip
        position: right
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        marks:
          -
            type: bold
        text: 'Before (Unexpected behavior):'
  -
    type: codeBlock
    attrs:
      language: null
    content:
      -
        type: text
        text: |-
          public static function getLimitExpirationDate(): iterable
          {
              // PROBLEM: now() is called before Laravel boots!
              // This doesn't return CarbonImmutable as expected
              yield 'With expiration' => [now()->addDays(30)];
              yield 'Without expiration' => [null];
          }

          #[DataProvider('getLimitExpirationDate')]
          #[Test]
          public function it_handles_expiration(?CarbonInterface $expirationDate): void
          {
              // $expirationDate is not CarbonImmutable!
          }
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        marks:
          -
            type: bold
        text: 'After (Use string modifiers):'
  -
    type: codeBlock
    attrs:
      language: null
    content:
      -
        type: text
        text: |-
          public static function getLimitExpirationDate(): iterable
          {
              // Use string modifiers instead of Carbon instances
              yield 'With expiration' => ['+30 days'];
              yield 'Without expiration' => [null];
          }

          #[DataProvider('getLimitExpirationDate')]
          #[Test]
          public function it_handles_expiration(?string $expirationDateModifier): void
          {
              // Convert to date inside the test where Laravel is booted
              $expirationDate = $expirationDateModifier
                  ? now()->modify($expirationDateModifier)
                  : null;

              // Now $expirationDate is CarbonImmutable as expected
          }
  -
    type: heading
    attrs:
      textAlign: left
      level: 2
    content:
      -
        type: text
        text: 'Safe vs Unsafe in DataProviders'
  -
    type: table
    content:
      -
        type: tableRow
        content:
          -
            type: tableHeader
            attrs:
              colspan: 1
              rowspan: 1
              colwidth: null
            content:
              -
                type: paragraph
                attrs:
                  textAlign: left
                content:
                  -
                    type: text
                    marks:
                      -
                        type: bold
                    text: Safe
          -
            type: tableHeader
            attrs:
              colspan: 1
              rowspan: 1
              colwidth: null
            content:
              -
                type: paragraph
                attrs:
                  textAlign: left
                content:
                  -
                    type: text
                    marks:
                      -
                        type: bold
                    text: Unsafe
      -
        type: tableRow
        content:
          -
            type: tableCell
            attrs:
              colspan: 1
              rowspan: 1
              colwidth: null
            content:
              -
                type: paragraph
                attrs:
                  textAlign: left
                content:
                  -
                    type: text
                    text: 'Scalar values (strings, int, bool)'
          -
            type: tableCell
            attrs:
              colspan: 1
              rowspan: 1
              colwidth: null
            content:
              -
                type: paragraph
                attrs:
                  textAlign: left
                content:
                  -
                    type: text
                    marks:
                      -
                        type: code
                    text: now()
                  -
                    type: text
                    text: ', '
                  -
                    type: text
                    marks:
                      -
                        type: code
                    text: today()
      -
        type: tableRow
        content:
          -
            type: tableCell
            attrs:
              colspan: 1
              rowspan: 1
              colwidth: null
            content:
              -
                type: paragraph
                attrs:
                  textAlign: left
                content:
                  -
                    type: text
                    text: Enums
          -
            type: tableCell
            attrs:
              colspan: 1
              rowspan: 1
              colwidth: null
            content:
              -
                type: paragraph
                attrs:
                  textAlign: left
                content:
                  -
                    type: text
                    marks:
                      -
                        type: code
                    text: config()
      -
        type: tableRow
        content:
          -
            type: tableCell
            attrs:
              colspan: 1
              rowspan: 1
              colwidth: null
            content:
              -
                type: paragraph
                attrs:
                  textAlign: left
                content:
                  -
                    type: text
                    text: 'Static data'
          -
            type: tableCell
            attrs:
              colspan: 1
              rowspan: 1
              colwidth: null
            content:
              -
                type: paragraph
                attrs:
                  textAlign: left
                content:
                  -
                    type: text
                    marks:
                      -
                        type: code
                    text: app()
      -
        type: tableRow
        content:
          -
            type: tableCell
            attrs:
              colspan: 1
              rowspan: 1
              colwidth: null
            content:
              -
                type: paragraph
                attrs:
                  textAlign: left
          -
            type: tableCell
            attrs:
              colspan: 1
              rowspan: 1
              colwidth: null
            content:
              -
                type: paragraph
                attrs:
                  textAlign: left
                content:
                  -
                    type: text
                    text: 'Any Laravel facade'
  -
    type: heading
    attrs:
      textAlign: left
      level: 2
    content:
      -
        type: text
        text: 'PHPUnit 10+ Attribute Syntax'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'PHPUnit 10 replaced the old '
      -
        type: text
        marks:
          -
            type: code
        text: '@dataProvider'
      -
        type: text
        text: ' annotation with PHP 8 attributes:'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        marks:
          -
            type: bold
        text: 'Old Style (PHPUnit 9 and earlier):'
  -
    type: codeBlock
    attrs:
      language: null
    content:
      -
        type: text
        text: |-
          /**
           * @dataProvider applicationStatuses
           */
          public function test_something(ApplicationStatus $status): void
          {
              // ...
          }

          public function applicationStatuses(): array
          {
              return [
                  [ApplicationStatus::PENDING],
                  [ApplicationStatus::APPROVED],
              ];
          }
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        marks:
          -
            type: bold
        text: 'New Style (PHPUnit 10+):'
  -
    type: codeBlock
    attrs:
      language: null
    content:
      -
        type: text
        text: |-
          use PHPUnit\Framework\Attributes\DataProvider;
          use PHPUnit\Framework\Attributes\Test;

          #[DataProvider('applicationStatuses')]
          #[Test]
          public function test_something(ApplicationStatus $status): void
          {
              // ...
          }

          public static function applicationStatuses(): iterable
          {
              yield 'pending' => [ApplicationStatus::PENDING];
              yield 'approved' => [ApplicationStatus::APPROVED];
          }
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        marks:
          -
            type: bold
        text: 'Key Differences:'
  -
    type: table
    content:
      -
        type: tableRow
        content:
          -
            type: tableHeader
            attrs:
              colspan: 1
              rowspan: 1
              colwidth: null
            content:
              -
                type: paragraph
                attrs:
                  textAlign: left
                content:
                  -
                    type: text
                    marks:
                      -
                        type: bold
                    text: Aspect
          -
            type: tableHeader
            attrs:
              colspan: 1
              rowspan: 1
              colwidth: null
            content:
              -
                type: paragraph
                attrs:
                  textAlign: left
                content:
                  -
                    type: text
                    marks:
                      -
                        type: bold
                    text: 'Old Style'
          -
            type: tableHeader
            attrs:
              colspan: 1
              rowspan: 1
              colwidth: null
            content:
              -
                type: paragraph
                attrs:
                  textAlign: left
                content:
                  -
                    type: text
                    marks:
                      -
                        type: bold
                    text: 'New Style'
      -
        type: tableRow
        content:
          -
            type: tableCell
            attrs:
              colspan: 1
              rowspan: 1
              colwidth: null
            content:
              -
                type: paragraph
                attrs:
                  textAlign: left
                content:
                  -
                    type: text
                    text: Syntax
          -
            type: tableCell
            attrs:
              colspan: 1
              rowspan: 1
              colwidth: null
            content:
              -
                type: paragraph
                attrs:
                  textAlign: left
                content:
                  -
                    type: text
                    marks:
                      -
                        type: code
                    text: '@dataProvider'
                  -
                    type: text
                    text: ' annotation'
          -
            type: tableCell
            attrs:
              colspan: 1
              rowspan: 1
              colwidth: null
            content:
              -
                type: paragraph
                attrs:
                  textAlign: left
                content:
                  -
                    type: text
                    marks:
                      -
                        type: code
                    text: '#[DataProvider()]'
                  -
                    type: text
                    text: ' attribute'
      -
        type: tableRow
        content:
          -
            type: tableCell
            attrs:
              colspan: 1
              rowspan: 1
              colwidth: null
            content:
              -
                type: paragraph
                attrs:
                  textAlign: left
                content:
                  -
                    type: text
                    text: Method
          -
            type: tableCell
            attrs:
              colspan: 1
              rowspan: 1
              colwidth: null
            content:
              -
                type: paragraph
                attrs:
                  textAlign: left
                content:
                  -
                    type: text
                    text: 'Instance method'
          -
            type: tableCell
            attrs:
              colspan: 1
              rowspan: 1
              colwidth: null
            content:
              -
                type: paragraph
                attrs:
                  textAlign: left
                content:
                  -
                    type: text
                    marks:
                      -
                        type: bold
                    text: 'Static method'
                  -
                    type: text
                    text: ' (required)'
      -
        type: tableRow
        content:
          -
            type: tableCell
            attrs:
              colspan: 1
              rowspan: 1
              colwidth: null
            content:
              -
                type: paragraph
                attrs:
                  textAlign: left
                content:
                  -
                    type: text
                    text: Return
          -
            type: tableCell
            attrs:
              colspan: 1
              rowspan: 1
              colwidth: null
            content:
              -
                type: paragraph
                attrs:
                  textAlign: left
                content:
                  -
                    type: text
                    marks:
                      -
                        type: code
                    text: array
          -
            type: tableCell
            attrs:
              colspan: 1
              rowspan: 1
              colwidth: null
            content:
              -
                type: paragraph
                attrs:
                  textAlign: left
                content:
                  -
                    type: text
                    marks:
                      -
                        type: code
                    text: iterable
                  -
                    type: text
                    text: ' (array or generator)'
      -
        type: tableRow
        content:
          -
            type: tableCell
            attrs:
              colspan: 1
              rowspan: 1
              colwidth: null
            content:
              -
                type: paragraph
                attrs:
                  textAlign: left
                content:
                  -
                    type: text
                    text: 'IDE Support'
          -
            type: tableCell
            attrs:
              colspan: 1
              rowspan: 1
              colwidth: null
            content:
              -
                type: paragraph
                attrs:
                  textAlign: left
                content:
                  -
                    type: text
                    text: Limited
          -
            type: tableCell
            attrs:
              colspan: 1
              rowspan: 1
              colwidth: null
            content:
              -
                type: paragraph
                attrs:
                  textAlign: left
                content:
                  -
                    type: text
                    text: 'Full autocomplete and refactoring'
  -
    type: heading
    attrs:
      textAlign: left
      level: 2
    content:
      -
        type: text
        text: 'Named Data Sets'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'Use named data sets to make test output readable:'
  -
    type: set
    attrs:
      id: mjcxqwgi
      values:
        type: sidenote
        content:
          -
            type: paragraph
            content:
              -
                type: text
                text: 'Named data sets make understanding failed tests much easier. Seeing '
              -
                type: text
                marks:
                  -
                    type: code
                text: 'data set "65 days overdue"'
              -
                type: text
                text: ' instead of '
              -
                type: text
                marks:
                  -
                    type: code
                text: 'data set #2'
              -
                type: text
                text: ' speeds up debugging.'
        style: info
        position: right
  -
    type: codeBlock
    attrs:
      language: null
    content:
      -
        type: text
        text: |-
          public static function getLatencies(): iterable
          {
              yield '35 days overdue' => [35];
              yield '65 days overdue' => [65];
              yield '95 days overdue' => [95];
          }

          // Test output shows:
          // ✓ it reports overdue order with data set "35 days overdue"
          // ✓ it reports overdue order with data set "65 days overdue"
          // ✓ it reports overdue order with data set "95 days overdue"
  -
    type: horizontalRule
  -
    type: heading
    attrs:
      textAlign: left
      level: 1
    content:
      -
        type: text
        text: 'Factory Patterns for Test Data'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'Factories are the most powerful way to create test data. But when used incorrectly, they can lead to flaky tests.'
  -
    type: heading
    attrs:
      textAlign: left
      level: 2
    content:
      -
        type: text
        text: 'factory()->create() vs firstOrCreate()'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        marks:
          -
            type: bold
        text: 'Use '
      -
        type: text
        marks:
          -
            type: code
        text: factory()->create()
      -
        type: text
        marks:
          -
            type: bold
        text: ' for:'
  -
    type: bulletList
    content:
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                text: 'Test-specific data (should be isolated)'
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                text: 'Data that can differ between tests'
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                text: 'Most test scenarios'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        marks:
          -
            type: bold
        text: 'Use '
      -
        type: text
        marks:
          -
            type: code
        text: firstOrCreate()
      -
        type: text
        marks:
          -
            type: bold
        text: ' for:'
  -
    type: bulletList
    content:
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                text: 'Shared reference data (workflow types, status codes)'
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                text: 'Data seeded by migrations'
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                text: 'Data that must be consistent across tests'
  -
    type: codeBlock
    attrs:
      language: null
    content:
      -
        type: text
        text: |-
          // Task is reference data - use firstOrCreate
          $task = Task::firstOrCreate(
              ['id' => TaskType::ConfirmDelivery->value],
              ['name' => 'Confirm Delivery']
          );

          // Order is test data - use factory
          $order = Order::factory()
              ->withTask($task)
              ->create();
  -
    type: heading
    attrs:
      textAlign: left
      level: 2
    content:
      -
        type: text
        text: 'Use Correct Factory State Methods'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: "Using the wrong factory state creates data that doesn't match the test scenario."
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        marks:
          -
            type: bold
        text: 'Example: Ready-to-Ship Order'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'A "'
      -
        type: text
        marks:
          -
            type: italic
        text: ready-to-ship
      -
        type: text
        text: '" order requires specific task states:'
  -
    type: bulletList
    content:
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                marks:
                  -
                    type: code
                text: VerifyPayment
              -
                type: text
                text: ': DONE'
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                marks:
                  -
                    type: code
                text: ConfirmShipping
              -
                type: text
                text: ': NOT done'
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                marks:
                  -
                    type: code
                text: GenerateInvoice
              -
                type: text
                text: ': NOT done'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        marks:
          -
            type: bold
        text: 'Wrong (All tasks done):'
  -
    type: codeBlock
    attrs:
      language: null
    content:
      -
        type: text
        text: |-
          // This creates ALL tasks as done - not a ready-to-ship order!
          $order = Order::factory()
              ->withCompletedTasks(requiredForShipping: true)
              ->create();
  -
    type: set
    attrs:
      id: mjcyam73
      values:
        type: sidenote
        content:
          -
            type: paragraph
            content:
              -
                type: text
                text: 'Use factory states semantically. '
              -
                type: text
                marks:
                  -
                    type: code
                text: withCompletedTasks()
              -
                type: text
                text: ' might not always create the state you expect.'
        style: warning
        position: right
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        marks:
          -
            type: bold
        text: 'Correct (Specific workflow states):'
  -
    type: codeBlock
    attrs:
      language: null
    content:
      -
        type: text
        text: |-
          // This creates the correct state for a ready-to-ship order
          $order = Order::factory()
              ->readyToShip(shippingDate: now()->next('Monday'))
              ->create();
  -
    type: heading
    attrs:
      textAlign: left
      level: 1
    content:
      -
        type: text
        text: 'Additional Tips'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        marks:
          -
            type: bold
        text: '1. Avoid random business rules:'
  -
    type: codeBlock
    attrs:
      language: null
    content:
      -
        type: text
        text: |-
          // WRONG: Random category might trigger extra approval workflow
          $order = Order::factory()->create();

          // CORRECT: Explicit category that doesn't require approval
          $category = Category::factory()
              ->withoutApprovalRequired()
              ->create();

          $order = Order::factory()
              ->for($category)
              ->create();
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        marks:
          -
            type: bold
        text: '2. Fake BEFORE factory:'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: "Factories' "
      -
        type: text
        marks:
          -
            type: code
        text: afterCreating()
      -
        type: text
        text: ' hooks can send notifications or mail. Set fakes before creating models to avoid side effects.'
  -
    type: codeBlock
    attrs:
      language: null
    content:
      -
        type: text
        text: |
          // CORRECT ORDER
          Notification::fake();
          Mail::fake();

          $order = Order::factory()->create();  // afterCreating hooks won't send real notifications
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        marks:
          -
            type: bold
        text: '3. Money unit awareness:'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: "Money configs might already be in minor units. Don't double-convert."
  -
    type: codeBlock
    attrs:
      language: null
    content:
      -
        type: text
        text: |
          // WRONG: Double conversion
          Money::of(config('orders.minimum_amount'));  // Already in minor units (cents)!

          // CORRECT: Use ofMinor for values stored in cents
          Money::ofMinor(config('orders.minimum_amount'));
  -
    type: horizontalRule
  -
    type: heading
    attrs:
      textAlign: left
      level: 1
    content:
      -
        type: text
        text: 'The Determinism Checklist'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'Use this checklist when writing or reviewing tests:'
  -
    type: bulletList
    content:
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                text: 'Time is frozen with '
              -
                type: text
                marks:
                  -
                    type: code
                text: travelTo()
              -
                type: text
                text: ' where necessary'
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                text: "Random values don't affect test logic or counts"
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                text: "DataProviders don't use "
              -
                type: text
                marks:
                  -
                    type: code
                text: now()
              -
                type: text
                text: ', '
              -
                type: text
                marks:
                  -
                    type: code
                text: config()
              -
                type: text
                text: ', or facades'
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                text: 'Back-to-back created records have explicit timestamps'
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                text: 'Factory states match test scenario'
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                text: 'Multiple cases use DataProviders (not randomness)'
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                text: 'Fixed timestamps instead of natural language date parsing ('
              -
                type: text
                marks:
                  -
                    type: code
                text: "'Today, 17:00'"
              -
                type: text
                text: )
  -
    type: horizontalRule
  -
    type: heading
    attrs:
      textAlign: left
      level: 1
    content:
      -
        type: text
        text: "What's Next"
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'In this part, we established the determinism principle: controlling time, eliminating randomness, and making test data predictable.'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'Part 4: The Cleanup'
      -
        type: text
        marks:
          -
            type: bold
        text: ' '
      -
        type: text
        text: 'covers test infrastructure:'
  -
    type: bulletList
    content:
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                text: 'Why '
              -
                type: text
                marks:
                  -
                    type: code
                text: tearDown()
              -
                type: text
                text: ' method ordering is critical'
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                text: 'The mysterious errors caused by Sushi models'
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                text: 'Proper use of HTTP, Event, and Queue fakes'
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                text: 'The ultimate testing checklist'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'See you there.'
  -
    type: horizontalRule
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        marks:
          -
            type: italic
        text: 'The Flaky Test Chronicles is a series of lessons from a 300+ commit test suite cleanup. Start from '
      -
        type: text
        marks:
          -
            type: italic
          -
            type: link
            attrs:
              href: /articles/the-flaky-test-chronicles-i-the-reckoning
              target: null
        text: 'Part 1: The Reckoning'
      -
        type: text
        marks:
          -
            type: italic
        text: .
---
