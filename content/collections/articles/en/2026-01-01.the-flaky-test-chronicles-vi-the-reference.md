---
id: bd2a25e2-28fa-4d95-b8be-74187e727c70
blueprint: articles
title: 'The Flaky Test Chronicles VI: The Reference'
subtitle: 'The Complete Checklist and AI Prompt for Test Reliability'
show_toc: true
toc_levels:
  - 1
updated_by: b8f3533e-0fcf-42b9-a3d8-c8691deaf917
updated_at: 1767303164
og_generator_image: the-flaky-test-chronicles-vi-the-reference.jpg
display_date: '2026-01-01 23:00'
content:
  -
    type: blockquote
    content:
      -
        type: paragraph
        attrs:
          textAlign: left
        content:
          -
            type: text
            text: 'Five parts. 300+ commits. 43 alias mocks eliminated. One mission: tests that pass every time.'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: "You've made it through the chronicles. "
      -
        type: text
        marks:
          -
            type: link
            attrs:
              href: /articles/the-flaky-test-chronicles-i-the-reckoning
              rel: null
              target: null
              title: null
        text: 'The Reckoning'
      -
        type: text
        text: ' taught you why tests fail randomly. '
      -
        type: text
        marks:
          -
            type: link
            attrs:
              href: /articles/the-flaky-test-chronicles-ii-mock-madness
              rel: null
              target: null
              title: null
        text: 'Mock Madness'
      -
        type: text
        text: ' showed you the alias mock trap. '
      -
        type: text
        marks:
          -
            type: link
            attrs:
              href: /articles/the-flaky-test-chronicles-iii-the-determinism-principle
              rel: null
              target: null
              title: null
        text: 'The Determinism Principle'
      -
        type: text
        text: ' gave you control over time and randomness. '
      -
        type: text
        marks:
          -
            type: link
            attrs:
              href: /articles/the-flaky-test-chronicles-iv-the-teardown-tango
              rel: null
              target: null
              title: null
        text: 'The Teardown Tango'
      -
        type: text
        text: ' mastered cleanup. '
      -
        type: text
        marks:
          -
            type: link
            attrs:
              href: /articles/the-flaky-test-chronicles-v-the-abstraction-avalanche
              rel: null
              target: null
              title: null
        text: 'The Abstraction Avalanche'
      -
        type: text
        text: ' tamed your '
      -
        type: text
        marks:
          -
            type: code
        text: TestCase
      -
        type: text
        text: ' architecture.'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'Now you need a reference. Something to pull up during code review. Something to hand to a new team member. Something to feed your AI assistant.'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'This is that reference.'
  -
    type: horizontalRule
  -
    type: heading
    attrs:
      textAlign: left
      level: 1
    content:
      -
        type: text
        text: 'The Ultimate Checklist'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'Everything from Parts 1-5, organized by category.'
  -
    type: heading
    attrs:
      textAlign: left
      level: 2
    content:
      -
        type: text
        text: 'Time & Randomness'
  -
    type: bulletList
    content:
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                text: 'Freeze time at test start with '
              -
                type: text
                marks:
                  -
                    type: code
                text: 'Carbon::setTestNow()'
              -
                type: text
                text: ' or '
              -
                type: text
                marks:
                  -
                    type: code
                text: travelTo()
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                text: 'Use '
              -
                type: text
                marks:
                  -
                    type: code
                text: travelBack()
              -
                type: text
                text: ' after '
              -
                type: text
                marks:
                  -
                    type: code
                text: travelTo()
              -
                type: text
                text: ', or use the callback form'
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                text: 'Use '
              -
                type: text
                marks:
                  -
                    type: code
                text: startOfSecond()
              -
                type: text
                text: ' for back-to-back records to eliminate millisecond differences'
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                marks:
                  -
                    type: code
                text: createFromFormat()
              -
                type: text
                text: ' uses current time for missing parts - chain '
              -
                type: text
                marks:
                  -
                    type: code
                text: startOfDay()
              -
                type: text
                text: ' for date-only'
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                text: 'Never compare timestamps with '
              -
                type: text
                marks:
                  -
                    type: code
                text: assertEquals
              -
                type: text
                text: ' - use '
              -
                type: text
                marks:
                  -
                    type: code
                text: assertEqualsWithDelta
              -
                type: text
                text: ' or custom assertions'
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                text: 'Seed random generators with fixed values - use '
              -
                type: text
                marks:
                  -
                    type: code
                text: DataProviders
              -
                type: text
                text: ' instead of random values'
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                marks:
                  -
                    type: code
                text: DataProviders
              -
                type: text
                text: ' run BEFORE Laravel boots - never use '
              -
                type: text
                marks:
                  -
                    type: code
                text: now()
              -
                type: text
                text: ', '
              -
                type: text
                marks:
                  -
                    type: code
                text: config()
              -
                type: text
                text: ', or facades in them'
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                text: 'Never rely on database ordering without explicit '
              -
                type: text
                marks:
                  -
                    type: code
                text: 'ORDER BY'
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                text: 'Shuffle test data deliberately to expose hidden dependencies'
  -
    type: heading
    attrs:
      textAlign: left
      level: 2
    content:
      -
        type: text
        text: Mocking
  -
    type: bulletList
    content:
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                text: 'Never use Mockery '
              -
                type: text
                marks:
                  -
                    type: code
                text: alias
              -
                type: text
                text: ' or '
              -
                type: text
                marks:
                  -
                    type: code
                text: overload
              -
                type: text
                text: ' mocks - use dependency injection instead'
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                text: 'Use '
              -
                type: text
                marks:
                  -
                    type: code
                text: MockeryPHPUnitIntegration
              -
                type: text
                text: ' trait in base '
              -
                type: text
                marks:
                  -
                    type: code
                text: TestCase
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                text: 'Prefer Laravel fakes ('
              -
                type: text
                marks:
                  -
                    type: code
                text: 'Http::fake'
              -
                type: text
                text: ', '
              -
                type: text
                marks:
                  -
                    type: code
                text: 'Queue::fake'
              -
                type: text
                text: ') over manual mocks'
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                marks:
                  -
                    type: code
                text: 'Http::fake()'
              -
                type: text
                text: ' precedence matters - specific routes first, wildcards last'
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                text: 'Avoid '
              -
                type: text
                marks:
                  -
                    type: code
                text: 'Http::sequence()'
              -
                type: text
                text: ' in parallel tests - responses are consumed unpredictably'
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                text: 'Fake BEFORE factory creation to catch '
              -
                type: text
                marks:
                  -
                    type: code
                text: afterCreating
              -
                type: text
                text: ' hooks'
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                text: 'Use partial fakes when possible - '
              -
                type: text
                marks:
                  -
                    type: code
                text: 'Bus::fake([SpecificJob::class])'
              -
                type: text
                text: ', '
              -
                type: text
                marks:
                  -
                    type: code
                text: 'Event::fake([SpecificEvent::class])'
  -
    type: heading
    attrs:
      textAlign: left
      level: 2
    content:
      -
        type: text
        text: 'Cleanup & Isolation'
  -
    type: bulletList
    content:
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                text: 'Use '
              -
                type: text
                marks:
                  -
                    type: code
                text: DatabaseTransactions
              -
                type: text
                text: ' for test isolation'
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                text: 'Custom cleanup BEFORE '
              -
                type: text
                marks:
                  -
                    type: code
                text: 'parent::tearDown()'
              -
                type: text
                text: ' - Mockery and transactions close in parent'
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                text: 'Clear caches BEFORE mocking, not after'
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                text: 'Disable observable events in '
              -
                type: text
                marks:
                  -
                    type: code
                text: setUp
              -
                type: text
                text: ' for models with side effects'
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                text: 'Use opt-in traits for targeted '
              -
                type: text
                marks:
                  -
                    type: code
                text: tearDown
              -
                type: text
                text: ' ('
              -
                type: text
                marks:
                  -
                    type: code
                text: RefreshesSushiModels
              -
                type: text
                text: ', '
              -
                type: text
                marks:
                  -
                    type: code
                text: CleansUpTestFiles
              -
                type: text
                text: )
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                text: 'Prefer '
              -
                type: text
                marks:
                  -
                    type: code
                text: 'Storage::fake()'
              -
                type: text
                text: ' over manual file cleanup'
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                text: 'Reset global state (config, locale) in '
              -
                type: text
                marks:
                  -
                    type: code
                text: tearDown
              -
                type: text
                text: ' or at test end'
  -
    type: heading
    attrs:
      textAlign: left
      level: 2
    content:
      -
        type: text
        text: 'Test Structure'
  -
    type: bulletList
    content:
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                text: 'Keep '
              -
                type: text
                marks:
                  -
                    type: code
                text: TestCase
              -
                type: text
                text: ' lean - only global concerns'
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                text: 'Use traits for optional concerns with '
              -
                type: text
                marks:
                  -
                    type: code
                text: setUpXXX
              -
                type: text
                text: /
              -
                type: text
                marks:
                  -
                    type: code
                text: tearDownXXX
              -
                type: text
                text: ' naming'
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                text: 'Call Passport clients lazily, not in global '
              -
                type: text
                marks:
                  -
                    type: code
                text: setUp
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                text: 'Always specify scopes in '
              -
                type: text
                marks:
                  -
                    type: code
                text: 'Passport::actingAs()'
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                text: 'Enable risky test detection in PHPUnit'
  -
    type: heading
    attrs:
      textAlign: left
      level: 2
    content:
      -
        type: text
        text: Assertions
  -
    type: bulletList
    content:
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                text: 'Use '
              -
                type: text
                marks:
                  -
                    type: code
                text: 'assertSame(true, ...)'
              -
                type: text
                text: ' not '
              -
                type: text
                marks:
                  -
                    type: code
                text: assertTrue()
              -
                type: text
                text: ' to catch missing boolean model casts'
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                text: 'Create custom assertions for value objects (Money, dates)'
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                text: 'For Money: use '
              -
                type: text
                marks:
                  -
                    type: code
                text: Money->isEqualTo()
              -
                type: text
                text: ', not '
              -
                type: text
                marks:
                  -
                    type: code
                text: assertEquals
              -
                type: text
                text: ' on floats'
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                text: 'Use '
              -
                type: text
                marks:
                  -
                    type: code
                text: $this->fail()
              -
                type: text
                text: ' in try/catch blocks to prevent risky tests'
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                text: 'Prefer '
              -
                type: text
                marks:
                  -
                    type: code
                text: expectException()
              -
                type: text
                text: ' over try/catch when only asserting exception type'
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                text: 'Assert exception class AND message when relevant'
  -
    type: heading
    attrs:
      textAlign: left
      level: 2
    content:
      -
        type: text
        text: Verification
  -
    type: bulletList
    content:
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                text: 'Run suspected flaky tests many times: '
              -
                type: text
                marks:
                  -
                    type: code
                text: '--repeat 100'
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                text: 'Run in random order: '
              -
                type: text
                marks:
                  -
                    type: code
                text: '--order-by=random'
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                text: 'Run in parallel to expose race conditions'
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                text: 'A test that fails once in 100 runs is a bug, not bad luck'
  -
    type: horizontalRule
  -
    type: heading
    attrs:
      textAlign: left
      level: 1
    content:
      -
        type: text
        text: 'The AI Agent Prompt'
  -
    type: heading
    attrs:
      textAlign: left
      level: 2
    content:
      -
        type: text
        text: 'Why This Prompt?'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'AI coding assistants are increasingly writing and reviewing our tests. But they lack the hard-won knowledge of flaky test patterns - the '
      -
        type: text
        marks:
          -
            type: code
        text: alias
      -
        type: text
        text: ' mock trap, the '
      -
        type: text
        marks:
          -
            type: code
        text: DataProvider
      -
        type: text
        text: ' timing issue, the cache-before-mock ritual.'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'This prompt transfers that knowledge. Add it to your AI context and every test review catches the same issues a senior developer would.'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        marks:
          -
            type: bold
        text: 'Use it when:'
  -
    type: bulletList
    content:
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                text: 'AI writes tests for you - catch flakiness before commit'
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                text: 'Debugging flaky failures - get pattern-based suggestions'
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                text: 'Code review - automated checklist for test reliability'
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                text: 'Onboarding - teach new devs through AI explanations'
  -
    type: heading
    attrs:
      textAlign: left
      level: 2
    content:
      -
        type: text
        text: 'The Prompt'
  -
    type: codeBlock
    attrs:
      language: markdown
    content:
      -
        type: text
        text: |-
          ## Flaky Test Review Guidelines

          When reviewing or debugging Laravel/PHP tests, check for these common flakiness patterns:

          ### Time-Related Issues
          - [ ] Is time frozen with Carbon::setTestNow() or travelTo() at test start?
          - [ ] Using travelBack() after travelTo(), or the callback form?
          - [ ] Using startOfSecond() for back-to-back created records?
          - [ ] createFromFormat() chains startOfDay() for date-only comparisons?
          - [ ] DataProviders avoid now(), config(), facades? (They run before Laravel boots)

          ### Mock Issues
          - [ ] Any Mockery alias:: or overload:: usage? (Use DI/Facades instead - these break parallel tests)
          - [ ] Is MockeryPHPUnitIntegration trait used in base TestCase?
          - [ ] Are fakes called BEFORE factory creation? (afterCreating hooks run immediately)
          - [ ] Http::fake() has specific routes before wildcards?
          - [ ] Avoiding Http::sequence() in parallel tests?
          - [ ] Using partial fakes where possible? Bus::fake([Job::class]), Event::fake([Event::class])

          ### Isolation Issues
          - [ ] Does test depend on database ordering without ORDER BY?
          - [ ] Are caches cleared BEFORE mocking cached values?
          - [ ] Are observable events disabled for models that trigger side effects?
          - [ ] Is static state (singletons, static properties, Sushi connections) properly reset?
          - [ ] Is global state (config, locale) reset in tearDown?

          ### tearDown Issues
          - [ ] Custom cleanup runs BEFORE parent::tearDown()? (Mockery closes in parent)
          - [ ] Are file handles closed before cleanup?
          - [ ] Are opt-in cleanup traits used for specific concerns?

          ### Assertion Issues
          - [ ] Using assertSame(true, ...) not assertTrue() for booleans? (Catches missing casts)
          - [ ] Using Money->isEqualTo() not assertEquals for money values?
          - [ ] Using $this->fail() in try/catch blocks? (Prevents risky tests)

          ### Common Fixes
          1. Freeze time: `$this->travelTo(now()->startOfSecond())`
          2. Disable events: `Model::ignoreObservableEvents(['created', 'updated'])`
          3. Fake before factory: `Notification::fake(); $model = Model::factory()->create();`
          4. Clear cache before mock: `cache()->forget('key'); Config::partialMock()`
          5. Use Storage::fake() instead of manual file operations
          6. Replace alias mocks with Factory Pattern or Facades
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'Copy this into your project as a '
      -
        type: text
        marks:
          -
            type: code
        text: TESTING_GUIDELINES.md
      -
        type: text
        text: ' or add it to your AI assistant context.'
  -
    type: horizontalRule
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'The complete series:'
  -
    type: orderedList
    attrs:
      start: 1
    content:
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                marks:
                  -
                    type: link
                    attrs:
                      href: /articles/the-flaky-test-chronicles-i-the-reckoning
                      rel: null
                      target: null
                      title: null
                text: 'The Reckoning'
              -
                type: text
                text: ' - Why tests fail randomly'
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                marks:
                  -
                    type: link
                    attrs:
                      href: /articles/the-flaky-test-chronicles-ii-mock-madness
                      rel: null
                      target: null
                      title: null
                text: 'Mock Madness'
              -
                type: text
                text: ' - The alias mock trap'
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                marks:
                  -
                    type: link
                    attrs:
                      href: /articles/the-flaky-test-chronicles-iii-the-determinism-principle
                      rel: null
                      target: null
                      title: null
                text: 'The Determinism Principle'
              -
                type: text
                text: ' - Time and randomness'
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                marks:
                  -
                    type: link
                    attrs:
                      href: /articles/the-flaky-test-chronicles-iv-the-teardown-tango
                      rel: null
                      target: null
                      title: null
                text: 'The Teardown Tango'
              -
                type: text
                text: ' - Cleanup and assertions'
      -
        type: listItem
        content:
          -
            type: paragraph
            attrs:
              textAlign: left
            content:
              -
                type: text
                marks:
                  -
                    type: link
                    attrs:
                      href: /articles/the-flaky-test-chronicles-v-the-abstraction-avalanche
                      rel: null
                      target: null
                      title: null
                text: 'The Abstraction Avalanche'
              -
                type: text
                text: ' - '
              -
                type: text
                marks:
                  -
                    type: code
                text: TestCase
              -
                type: text
                text: ' architecture'
  -
    type: heading
    attrs:
      textAlign: left
      level: 1
    content:
      -
        type: text
        text: 'The End'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: '300+ commits. 43 alias mocks eliminated. Countless flaky tests fixed.'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'And a '
      -
        type: text
        marks:
          -
            type: code
        text: TestCase
      -
        type: text
        text: ' that evolved from “'
      -
        type: text
        marks:
          -
            type: italic
        text: 'throw everything in '
      -
        type: text
        marks:
          -
            type: code
        text: setUp
      -
        type: text
        marks:
          -
            type: italic
        text: ”
      -
        type: text
        text: '  to “'
      -
        type: text
        marks:
          -
            type: italic
        text: 'make dependencies explicit.”'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: "The test that passes locally and fails in CI? That's not a flaky test. That's a bug in your foundation."
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'Build it right. Keep it deterministic. Trust your tests.'
  -
    type: horizontalRule
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        marks:
          -
            type: italic
        text: 'The Flaky Test Chronicles ends here. Now go forth and make your tests boring. Boring tests are good tests.'
---
