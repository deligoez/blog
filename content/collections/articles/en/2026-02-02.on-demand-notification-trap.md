---
id: 195d92e6-12f7-4a96-88ca-76509319548e
blueprint: articles
title: 'The On-Demand Notification Trap'
subtitle: 'When `assertSentTo` Lies About Anonymous Notifiables'
show_toc: true
toc_levels:
  - 1
updated_by: b8f3533e-0fcf-42b9-a3d8-c8691deaf917
updated_at: 1770063746
og_generator_image: on-demand-notification-trap.jpg
content:
  -
    type: blockquote
    content:
      -
        type: paragraph
        attrs:
          textAlign: left
        content:
          -
            type: text
            text: 'The test passed. I ran it again. It failed. Same code. Same test. Different result.'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: "If you've read "
      -
        type: text
        marks:
          -
            type: link
            attrs:
              href: /articles/the-flaky-test-chronicles-i-the-reckoning
              rel: null
              target: null
              title: null
        text: 'The Flaky Test Chronicles'
      -
        type: text
        text: ', you know the feeling. That sinking sensation when CI goes red for a test that was green moments ago. That quiet voice saying “'
      -
        type: text
        marks:
          -
            type: italic
        text: 'just rerun it.”'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'This is another one of those stories.'
  -
    type: horizontalRule
  -
    type: heading
    attrs:
      textAlign: left
      level: 1
    content:
      -
        type: text
        text: 'The Beginning'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'A red build in the CI pipeline. '
      -
        type: hardBreak
      -
        type: text
        text: 'The reason: “'
      -
        type: text
        marks:
          -
            type: italic
        text: 'The expected notification was not sent.”'
      -
        type: hardBreak
      -
        type: text
        text: 'I run it locally, it passes.'
      -
        type: hardBreak
      -
        type: text
        text: 'CI runs it again, it fails.'
      -
        type: hardBreak
      -
        type: text
        text: 'Classic flaky test symptoms.'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'The test looked like this:'
  -
    type: codeBlock
    attrs:
      language: php
    content:
      -
        type: text
        text: |-
          Notification::fake();

          $job = new ProcessPaymentJob($order->id);
          $job->failed();

          Notification::assertSentTo(
              notifiable: new AnonymousNotifiable(),
              notification: PaymentFailedNotification::class,
              callback: fn ($notification, $channels) => $notification->orderId === $order->id
          );
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: "The job's "
      -
        type: text
        marks:
          -
            type: code
        text: failed()
      -
        type: text
        text: ' method:'
  -
    type: set
    attrs:
      id: ml5lhgcp
      values:
        type: sidenote
        content:
          -
            type: paragraph
            content:
              -
                type: text
                text: 'At first glance, this makes perfect sense. We send via '
              -
                type: text
                marks:
                  -
                    type: code
                text: 'Notification::route()'
              -
                type: text
                text: ', we test with '
              -
                type: text
                marks:
                  -
                    type: code
                text: 'assertSentTo(new AnonymousNotifiable(), ...)'
              -
                type: text
                text: '. Because '
              -
                type: text
                marks:
                  -
                    type: code
                text: route()
              -
                type: text
                text: ' internally creates an '
              -
                type: text
                marks:
                  -
                    type: code
                text: AnonymousNotifiable
              -
                type: text
                text: .
        style: note
        position: right
  -
    type: codeBlock
    attrs:
      language: php
    content:
      -
        type: text
        text: |-
          public function failed(): void
          {
              Notification::route('mail', config('app.admin_email'))
                  ->notify(new PaymentFailedNotification($this->orderId));
          }
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'So why does it sometimes pass and sometimes fail?'
  -
    type: horizontalRule
  -
    type: heading
    attrs:
      textAlign: left
      level: 1
    content:
      -
        type: text
        text: 'The Source of the Problem'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: "I found the answer in Laravel's "
      -
        type: text
        marks:
          -
            type: code
        text: NotificationFake
      -
        type: text
        text: ' class. Notifications are stored like this:'
  -
    type: codeBlock
    attrs:
      language: php
    content:
      -
        type: text
        text: '$this->notifications[get_class($notifiable)][$notifiable->getKey()][$notification]'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: "A three-level array: class name, notifiable's key, and notification class."
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'When I looked at '
      -
        type: text
        marks:
          -
            type: code
        text: AnonymousNotifiable
      -
        type: text
        text: "'s "
      -
        type: text
        marks:
          -
            type: code
        text: getKey()
      -
        type: text
        text: ' method:'
  -
    type: codeBlock
    attrs:
      language: php
    content:
      -
        type: text
        text: |-
          public function getKey()
          {
              //
          }
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'Empty. Returns '
      -
        type: text
        marks:
          -
            type: code
        text: 'null'
      -
        type: text
        text: '. And in PHP, '
      -
        type: text
        marks:
          -
            type: code
        text: '(string) null'
      -
        type: text
        text: ' is just an empty string.'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'So all anonymous notifications should be stored under the same key. Theoretically, I should be able to access them with '
      -
        type: text
        marks:
          -
            type: code
        text: 'new AnonymousNotifiable()'
      -
        type: text
        text: ". But in practice, this wasn't always working."
  -
    type: horizontalRule
  -
    type: heading
    attrs:
      textAlign: left
      level: 1
    content:
      -
        type: text
        text: 'The Real Problem'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: "I went down this rabbit hole for longer than I'd like to admit. Debugging the "
      -
        type: text
        marks:
          -
            type: code
        text: NotificationFake
      -
        type: text
        text: ' internals. Checking if there was some object identity issue. Wondering if parallel test execution was somehow corrupting the notification storage.'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'Then I found the answer in the most obvious place: the documentation.'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'This sentence caught my eye in the Laravel documentation:'
  -
    type: blockquote
    content:
      -
        type: paragraph
        attrs:
          textAlign: left
        content:
          -
            type: text
            marks:
              -
                type: italic
            text: '“If the code you are testing sends on-demand notifications, you can test that the on-demand notification was sent via the '
          -
            type: text
            marks:
              -
                type: code
            text: assertSentOnDemand
          -
            type: text
            marks:
              -
                type: italic
            text: ' method.”'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        marks:
          -
            type: code
        text: assertSentOnDemand()
      -
        type: text
        text: '. A method designed specifically for this purpose.'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'Looking at the source code:'
  -
    type: set
    attrs:
      id: ml5lplpu
      values:
        type: sidenote
        content:
          -
            type: paragraph
            content:
              -
                type: text
                text: "Wait, it does the same thing! So why does one work reliably and the other doesn't? The answer lies in how PHP handles object instantiation across test runs. When you create "
              -
                type: text
                marks:
                  -
                    type: code
                text: 'new AnonymousNotifiable()'
              -
                type: text
                text: " in your test, it's a different instance than the one Laravel's fake created internally. In most cases this doesn't matter - but in parallel execution or with certain test ordering, it can."
        style: note
        position: right
  -
    type: codeBlock
    attrs:
      language: php
    content:
      -
        type: text
        text: |-
          public function assertSentOnDemand($notification, $callback = null)
          {
              $this->assertSentTo(new AnonymousNotifiable, $notification, $callback);
          }
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: "The moral? When Laravel provides a specialized method, use it. Don't try to be clever."
  -
    type: horizontalRule
  -
    type: heading
    attrs:
      textAlign: left
      level: 1
    content:
      -
        type: text
        text: 'The Solution'
  -
    type: codeBlock
    attrs:
      language: php
    content:
      -
        type: text
        text: |-
          Notification::assertSentOnDemand(
              notification: PaymentFailedNotification::class,
              callback: fn ($notification, $channels) => ...
          );
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'A one-line change.'
      -
        type: hardBreak
      -
        type: text
        marks:
          -
            type: code
        text: assertSentOnDemand
      -
        type: text
        text: ' instead of '
      -
        type: text
        marks:
          -
            type: code
        text: assertSentTo
      -
        type: text
        text: .
      -
        type: hardBreak
      -
        type: text
        text: 'No '
      -
        type: text
        marks:
          -
            type: code
        text: notifiable
      -
        type: text
        text: " parameter - because the method name already tells us we're testing an on-demand notification."
  -
    type: horizontalRule
  -
    type: heading
    attrs:
      textAlign: left
      level: 1
    content:
      -
        type: text
        text: 'Bonus: Callback Parameters'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'The '
      -
        type: text
        marks:
          -
            type: code
        text: assertSentOnDemand
      -
        type: text
        text: ' callback can accept three parameters:'
  -
    type: set
    attrs:
      id: ml5lsemz
      values:
        type: sidenote
        content:
          -
            type: paragraph
            content:
              -
                type: text
                text: 'Use the third parameter if you want to verify the route address. If you only need to check the notification content, the first two parameters are enough - PHP ignores extra parameters.'
        style: note
        position: right
  -
    type: set
    attrs:
      id: ml5lswxl
      values:
        type: sidenote
        content:
          -
            type: paragraph
            content:
              -
                type: text
                text: 'For every notification you send via '
              -
                type: text
                marks:
                  -
                    type: code
                text: 'Notification::route()'
              -
                type: text
                text: ', use '
              -
                type: text
                marks:
                  -
                    type: code
                text: assertSentOnDemand()
              -
                type: text
                text: '. While '
              -
                type: text
                marks:
                  -
                    type: code
                text: 'assertSentTo(new AnonymousNotifiable(), ...)'
              -
                type: text
                marks:
                  -
                    type: italic
                text: ' might'
              -
                type: text
                text: " appear to work, it's not reliable."
        style: tip
        position: right
  -
    type: codeBlock
    attrs:
      language: php
    content:
      -
        type: text
        text: |-
          Notification::assertSentOnDemand(
              OrderShipped::class,
              function ($notification, array $channels, object $notifiable) {
                  // $notification - the sent notification instance
                  // $channels - the channels used ['mail', 'sms', ...]
                  // $notifiable - route info ($notifiable->routes['mail'])

                  return $notifiable->routes['mail'] === 'test@example.com';
              }
          );
  -
    type: horizontalRule
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: 'Fifty test runs later, not a single failure.'
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: "The fix was one line. The debugging took way longer than it deserved. When Laravel gives you a specialized method, there's usually a reason."
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        text: "Not every flaky test is a race condition. Sometimes it's just using the wrong tool for the job."
  -
    type: horizontalRule
  -
    type: paragraph
    attrs:
      textAlign: left
    content:
      -
        type: text
        marks:
          -
            type: italic
        text: 'This is a spin-off from '
      -
        type: text
        marks:
          -
            type: link
            attrs:
              href: /articles/the-flaky-test-chronicles-i-the-reckoning
              rel: null
              target: null
              title: null
          -
            type: italic
        text: 'The Flaky Test Chronicles'
      -
        type: text
        marks:
          -
            type: italic
        text: " - a series documenting what we learned from 300+ commits of test suite cleanup. This particular trap didn't fit neatly into any of the six deadly sins, but it was too good not to share."
---
