<pre class="shiki shiki-themes github-light github-dark" style="background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8;"><code><span class="line"><span style="color:#005CC5;--shiki-light-font-weight:bold;--shiki-dark:#79B8FF;--shiki-dark-font-weight:bold">---</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">name: flaky-test-reviewer</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">description: Review PHP/Laravel tests for flakiness patterns. Use when reviewing test code, debugging intermittent test failures, or writing new tests.</span></span>
<span class="line"><span style="color:#005CC5;--shiki-light-font-weight:bold;--shiki-dark:#79B8FF;--shiki-dark-font-weight:bold">---</span></span>
<span class="line"></span>
<span class="line"><span style="color:#005CC5;--shiki-light-font-weight:bold;--shiki-dark:#79B8FF;--shiki-dark-font-weight:bold"># Flaky Test Review Checklist</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">When reviewing or writing Laravel/PHP tests, check for these patterns:</span></span>
<span class="line"></span>
<span class="line"><span style="color:#005CC5;--shiki-light-font-weight:bold;--shiki-dark:#79B8FF;--shiki-dark-font-weight:bold">## Time-Related Issues</span></span>
<span class="line"><span style="color:#E36209;--shiki-dark:#FFAB70">-</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> [ ] Is time frozen with </span><span style="color:#005CC5;--shiki-dark:#79B8FF">`Carbon::setTestNow()`</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> or </span><span style="color:#005CC5;--shiki-dark:#79B8FF">`travelTo()`</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> at test start?</span></span>
<span class="line"><span style="color:#E36209;--shiki-dark:#FFAB70">-</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> [ ] Using </span><span style="color:#005CC5;--shiki-dark:#79B8FF">`travelBack()`</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> after </span><span style="color:#005CC5;--shiki-dark:#79B8FF">`travelTo()`</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, or the callback form?</span></span>
<span class="line"><span style="color:#E36209;--shiki-dark:#FFAB70">-</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> [ ] Using </span><span style="color:#005CC5;--shiki-dark:#79B8FF">`startOfSecond()`</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> for back-to-back created records?</span></span>
<span class="line"><span style="color:#E36209;--shiki-dark:#FFAB70">-</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> [ ] </span><span style="color:#005CC5;--shiki-dark:#79B8FF">`createFromFormat()`</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> chains </span><span style="color:#005CC5;--shiki-dark:#79B8FF">`startOfDay()`</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> for date-only comparisons?</span></span>
<span class="line"><span style="color:#E36209;--shiki-dark:#FFAB70">-</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> [ ] DataProviders avoid </span><span style="color:#005CC5;--shiki-dark:#79B8FF">`now()`</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#005CC5;--shiki-dark:#79B8FF">`config()`</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, facades? (They run before Laravel boots)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#005CC5;--shiki-light-font-weight:bold;--shiki-dark:#79B8FF;--shiki-dark-font-weight:bold">## Mock Issues</span></span>
<span class="line"><span style="color:#E36209;--shiki-dark:#FFAB70">-</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> [ ] Any Mockery </span><span style="color:#005CC5;--shiki-dark:#79B8FF">`alias::`</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> or </span><span style="color:#005CC5;--shiki-dark:#79B8FF">`overload::`</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> usage? (Use DI/Facades instead)</span></span>
<span class="line"><span style="color:#E36209;--shiki-dark:#FFAB70">-</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> [ ] Is </span><span style="color:#005CC5;--shiki-dark:#79B8FF">`MockeryPHPUnitIntegration`</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> trait used in base </span><span style="color:#005CC5;--shiki-dark:#79B8FF">`TestCase`</span><span style="color:#24292E;--shiki-dark:#E1E4E8">?</span></span>
<span class="line"><span style="color:#E36209;--shiki-dark:#FFAB70">-</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> [ ] Are fakes called BEFORE factory creation? (</span><span style="color:#005CC5;--shiki-dark:#79B8FF">`afterCreating`</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> hooks run immediately)</span></span>
<span class="line"><span style="color:#E36209;--shiki-dark:#FFAB70">-</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> [ ] </span><span style="color:#005CC5;--shiki-dark:#79B8FF">`Http::fake()`</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> has specific routes before wildcards?</span></span>
<span class="line"><span style="color:#E36209;--shiki-dark:#FFAB70">-</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> [ ] Avoiding </span><span style="color:#005CC5;--shiki-dark:#79B8FF">`Http::sequence()`</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> in parallel tests?</span></span>
<span class="line"></span>
<span class="line"><span style="color:#005CC5;--shiki-light-font-weight:bold;--shiki-dark:#79B8FF;--shiki-dark-font-weight:bold">## Isolation Issues</span></span>
<span class="line"><span style="color:#E36209;--shiki-dark:#FFAB70">-</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> [ ] Does test depend on database ordering without </span><span style="color:#005CC5;--shiki-dark:#79B8FF">`ORDER BY`</span><span style="color:#24292E;--shiki-dark:#E1E4E8">?</span></span>
<span class="line"><span style="color:#E36209;--shiki-dark:#FFAB70">-</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> [ ] Are caches cleared BEFORE mocking cached values?</span></span>
<span class="line"><span style="color:#E36209;--shiki-dark:#FFAB70">-</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> [ ] Are observable events disabled for models with side effects?</span></span>
<span class="line"><span style="color:#E36209;--shiki-dark:#FFAB70">-</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> [ ] Is global state (config, locale) reset in tearDown?</span></span>
<span class="line"></span>
<span class="line"><span style="color:#005CC5;--shiki-light-font-weight:bold;--shiki-dark:#79B8FF;--shiki-dark-font-weight:bold">## tearDown Issues</span></span>
<span class="line"><span style="color:#E36209;--shiki-dark:#FFAB70">-</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> [ ] Custom cleanup runs BEFORE </span><span style="color:#005CC5;--shiki-dark:#79B8FF">`parent::tearDown()`</span><span style="color:#24292E;--shiki-dark:#E1E4E8">?</span></span>
<span class="line"><span style="color:#E36209;--shiki-dark:#FFAB70">-</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> [ ] Are opt-in cleanup traits used for specific concerns?</span></span>
<span class="line"></span>
<span class="line"><span style="color:#005CC5;--shiki-light-font-weight:bold;--shiki-dark:#79B8FF;--shiki-dark-font-weight:bold">## Assertion Issues</span></span>
<span class="line"><span style="color:#E36209;--shiki-dark:#FFAB70">-</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> [ ] Using </span><span style="color:#005CC5;--shiki-dark:#79B8FF">`assertSame(true, ...)`</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> not </span><span style="color:#005CC5;--shiki-dark:#79B8FF">`assertTrue()`</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> for booleans?</span></span>
<span class="line"><span style="color:#E36209;--shiki-dark:#FFAB70">-</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> [ ] Using </span><span style="color:#005CC5;--shiki-dark:#79B8FF">`$this-&gt;fail()`</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> in try/catch blocks?</span></span>
<span class="line"></span>
<span class="line"><span style="color:#005CC5;--shiki-light-font-weight:bold;--shiki-dark:#79B8FF;--shiki-dark-font-weight:bold">## Common Fixes</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E36209;--shiki-dark:#FFAB70">1.</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#24292E;--shiki-light-font-weight:bold;--shiki-dark:#E1E4E8;--shiki-dark-font-weight:bold">**Freeze time**</span><span style="color:#24292E;--shiki-dark:#E1E4E8">: </span><span style="color:#005CC5;--shiki-dark:#79B8FF">`$this-&gt;travelTo(now()-&gt;startOfSecond())`</span></span>
<span class="line"><span style="color:#E36209;--shiki-dark:#FFAB70">2.</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#24292E;--shiki-light-font-weight:bold;--shiki-dark:#E1E4E8;--shiki-dark-font-weight:bold">**Disable events**</span><span style="color:#24292E;--shiki-dark:#E1E4E8">: </span><span style="color:#005CC5;--shiki-dark:#79B8FF">`Model::ignoreObservableEvents([&#39;created&#39;, &#39;updated&#39;])`</span></span>
<span class="line"><span style="color:#E36209;--shiki-dark:#FFAB70">3.</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#24292E;--shiki-light-font-weight:bold;--shiki-dark:#E1E4E8;--shiki-dark-font-weight:bold">**Fake before factory**</span><span style="color:#24292E;--shiki-dark:#E1E4E8">: </span><span style="color:#005CC5;--shiki-dark:#79B8FF">`Notification::fake(); $model = Model::factory()-&gt;create();`</span></span>
<span class="line"><span style="color:#E36209;--shiki-dark:#FFAB70">4.</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#24292E;--shiki-light-font-weight:bold;--shiki-dark:#E1E4E8;--shiki-dark-font-weight:bold">**Clear cache before mock**</span><span style="color:#24292E;--shiki-dark:#E1E4E8">: </span><span style="color:#005CC5;--shiki-dark:#79B8FF">`cache()-&gt;forget(&#39;key&#39;); Config::partialMock()`</span></span>
<span class="line"><span style="color:#E36209;--shiki-dark:#FFAB70">5.</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#24292E;--shiki-light-font-weight:bold;--shiki-dark:#E1E4E8;--shiki-dark-font-weight:bold">**Replace alias mocks**</span><span style="color:#24292E;--shiki-dark:#E1E4E8">: Use Factory Pattern or Facades instead</span></span></code></pre>